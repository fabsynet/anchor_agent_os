datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  admin
  agent
}

enum InvitationStatus {
  pending
  accepted
  revoked
  expired
}

enum ClientStatus {
  lead
  client

  @@map("client_status")
}

enum PolicyType {
  auto
  home
  life
  health
  commercial
  travel
  umbrella
  other

  @@map("policy_type")
}

enum PolicyStatus {
  draft
  active
  pending_renewal
  renewed
  expired
  cancelled

  @@map("policy_status")
}

enum PaymentFrequency {
  monthly
  quarterly
  semi_annual
  annual

  @@map("payment_frequency")
}

enum TaskStatus {
  todo
  in_progress
  waiting
  done

  @@map("task_status")
}

enum TaskPriority {
  low
  medium
  high
  urgent

  @@map("task_priority")
}

enum TaskType {
  manual
  renewal

  @@map("task_type")
}

enum DocumentCategory {
  policy_document
  application
  id_license
  claim_form
  proof_of_insurance
  endorsement
  cancellation_notice
  correspondence

  @@map("document_category")
}

enum ActivityEventType {
  client_created
  client_updated
  client_status_changed
  note_added
  policy_created
  policy_updated
  policy_status_changed
  policy_deleted
  task_created
  task_completed
  task_status_changed
  document_uploaded
  document_deleted

  @@map("activity_event_type")
}

enum ExpenseStatus {
  draft
  pending_approval
  approved
  rejected

  @@map("expense_status")
}

enum RecurrenceFrequency {
  weekly
  monthly
  yearly

  @@map("recurrence_frequency")
}

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  slug      String   @unique
  phone     String?
  address   String?
  province  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users       User[]
  invitations Invitation[]

  clients        Client[]
  policies       Policy[]
  activityEvents ActivityEvent[]
  notes          Note[]
  tasks          Task[]
  documents      Document[]
  expenses         Expense[]
  expenseReceipts  ExpenseReceipt[]
  budgets          Budget[]
  notifications    InAppNotification[]
  agentProfiles    AgentProfile[]

  @@map("tenants")
}

model User {
  id             String   @id @db.Uuid // matches auth.users.id
  tenantId       String   @map("tenant_id") @db.Uuid
  email          String
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  role           UserRole @default(agent)
  avatarUrl      String?  @map("avatar_url")
  setupCompleted Boolean  @default(false) @map("setup_completed")
  digestOptOut           Boolean  @default(false) @map("digest_opt_out")
  notifyBudgetAlerts     Boolean  @default(true)  @map("notify_budget_alerts")
  notifyRenewalReminders Boolean  @default(true)  @map("notify_renewal_reminders")
  notifyTaskReminders    Boolean  @default(true)  @map("notify_task_reminders")
  emailRenewalReminders  Boolean  @default(true)  @map("email_renewal_reminders")
  canViewFinancials Boolean  @default(false) @map("can_view_financials")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  invitations Invitation[] @relation("invitedBy")

  clientsCreated  Client[]        @relation("clientCreatedBy")
  policiesCreated Policy[]        @relation("policyCreatedBy")
  activityEvents  ActivityEvent[] @relation("activityEventUser")
  notesMade       Note[]          @relation("noteUser")
  tasksAssigned      Task[]          @relation("taskAssignee")
  tasksCreated       Task[]          @relation("taskCreatedBy")
  documentsUploaded  Document[]      @relation("documentUploadedBy")
  expensesSubmitted  Expense[]          @relation("expenseSubmittedBy")
  expensesApproved   Expense[]          @relation("expenseApprovedBy")
  budgetsCreated     Budget[]           @relation("budgetCreatedBy")
  notifications      InAppNotification[]
  agentProfile       AgentProfile?

  @@index([tenantId])
  @@map("users")
}

model Invitation {
  id          String           @id @default(uuid()) @db.Uuid
  tenantId    String           @map("tenant_id") @db.Uuid
  email       String
  role        UserRole
  status      InvitationStatus @default(pending)
  invitedById String           @map("invited_by_id") @db.Uuid
  token       String?          @unique
  expiresAt   DateTime         @map("expires_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  tenant    Tenant @relation(fields: [tenantId], references: [id])
  invitedBy User   @relation("invitedBy", fields: [invitedById], references: [id])

  @@index([tenantId])
  @@index([email, status])
  @@map("invitations")
}

model Client {
  id          String       @id @default(uuid()) @db.Uuid
  tenantId    String       @map("tenant_id") @db.Uuid
  firstName   String       @map("first_name")
  lastName    String       @map("last_name")
  email       String?
  phone       String?
  address     String?
  city        String?
  province    String?
  postalCode  String?      @map("postal_code")
  dateOfBirth DateTime?    @map("date_of_birth") @db.Date
  status      ClientStatus @default(lead)
  createdById String       @map("created_by_id") @db.Uuid
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  createdBy      User            @relation("clientCreatedBy", fields: [createdById], references: [id])
  policies       Policy[]
  activityEvents ActivityEvent[]
  notes          Note[]
  tasks          Task[]
  documents      Document[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, lastName, firstName])
  @@map("clients")
}

model Policy {
  id               String            @id @default(uuid()) @db.Uuid
  tenantId         String            @map("tenant_id") @db.Uuid
  clientId         String            @map("client_id") @db.Uuid
  type             PolicyType
  customType       String?           @map("custom_type")
  carrier          String?
  policyNumber     String?           @map("policy_number")
  startDate        DateTime?         @map("start_date") @db.Date
  endDate          DateTime?         @map("end_date") @db.Date
  premium          Decimal?          @db.Decimal(12, 2)
  coverageAmount   Decimal?          @map("coverage_amount") @db.Decimal(12, 2)
  deductible       Decimal?          @db.Decimal(12, 2)
  paymentFrequency PaymentFrequency? @map("payment_frequency")
  brokerCommission Decimal?          @map("broker_commission") @db.Decimal(5, 2)
  status           PolicyStatus      @default(draft)
  notes            String?
  createdById      String            @map("created_by_id") @db.Uuid
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  tenant    Tenant @relation(fields: [tenantId], references: [id])
  client    Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy User   @relation("policyCreatedBy", fields: [createdById], references: [id])
  tasks     Task[]
  documents      Document[]
  activityEvents ActivityEvent[]

  @@index([tenantId])
  @@index([clientId])
  @@index([tenantId, status])
  @@index([tenantId, type])
  @@index([tenantId, endDate])
  @@map("policies")
}

model ActivityEvent {
  id          String            @id @default(uuid()) @db.Uuid
  tenantId    String            @map("tenant_id") @db.Uuid
  clientId    String            @map("client_id") @db.Uuid
  userId      String            @map("user_id") @db.Uuid
  policyId    String?           @map("policy_id") @db.Uuid
  type        ActivityEventType
  description String
  metadata    Json?
  createdAt   DateTime          @default(now()) @map("created_at")

  tenant Tenant  @relation(fields: [tenantId], references: [id])
  client Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User    @relation("activityEventUser", fields: [userId], references: [id])
  policy Policy? @relation(fields: [policyId], references: [id], onDelete: SetNull)

  @@index([clientId, createdAt(sort: Desc)])
  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([policyId])
  @@map("activity_events")
}

model Note {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  clientId  String   @map("client_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User   @relation("noteUser", fields: [userId], references: [id])

  @@index([clientId, createdAt(sort: Desc)])
  @@index([tenantId])
  @@map("notes")
}

model Document {
  id            String           @id @default(uuid()) @db.Uuid
  tenantId      String           @map("tenant_id") @db.Uuid
  clientId      String           @map("client_id") @db.Uuid
  policyId      String?          @map("policy_id") @db.Uuid
  uploadedById  String           @map("uploaded_by_id") @db.Uuid
  fileName      String           @map("file_name")
  mimeType      String           @map("mime_type")
  fileSize      Int              @map("file_size")
  category      DocumentCategory @default(correspondence)
  storagePath   String           @map("storage_path")
  createdAt     DateTime         @default(now()) @map("created_at")

  tenant     Tenant  @relation(fields: [tenantId], references: [id])
  client     Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  policy     Policy? @relation(fields: [policyId], references: [id], onDelete: SetNull)
  uploadedBy User    @relation("documentUploadedBy", fields: [uploadedById], references: [id])

  @@index([tenantId])
  @@index([clientId])
  @@index([clientId, policyId])
  @@map("documents")
}

model Task {
  id                String       @id @default(uuid()) @db.Uuid
  tenantId          String       @map("tenant_id") @db.Uuid
  title             String
  description       String?
  status            TaskStatus   @default(todo)
  priority          TaskPriority @default(medium)
  type              TaskType     @default(manual)
  dueDate           DateTime?    @map("due_date") @db.Date
  assigneeId        String?      @map("assignee_id") @db.Uuid
  clientId          String?      @map("client_id") @db.Uuid
  policyId          String?      @map("policy_id") @db.Uuid
  createdById       String       @map("created_by_id") @db.Uuid
  renewalDaysBefore Int?         @map("renewal_days_before")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  tenant    Tenant  @relation(fields: [tenantId], references: [id])
  assignee  User?   @relation("taskAssignee", fields: [assigneeId], references: [id])
  client    Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)
  policy    Policy? @relation(fields: [policyId], references: [id], onDelete: Cascade)
  createdBy User    @relation("taskCreatedBy", fields: [createdById], references: [id])

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, dueDate])
  @@index([policyId, type, status])
  @@map("tasks")
}

model Expense {
  id              String              @id @default(uuid()) @db.Uuid
  tenantId        String              @map("tenant_id") @db.Uuid
  amount          Decimal             @db.Decimal(12, 2)
  currency        String              @default("CAD") @db.VarChar(3)
  category        String
  description     String?
  date            DateTime            @db.Date
  status          ExpenseStatus       @default(draft)
  submittedById   String              @map("submitted_by_id") @db.Uuid
  approvedById    String?             @map("approved_by_id") @db.Uuid
  approvedAt      DateTime?           @map("approved_at")
  rejectionNote   String?             @map("rejection_note")
  isRecurring     Boolean             @default(false) @map("is_recurring")
  recurrence      RecurrenceFrequency?
  nextOccurrence  DateTime?           @map("next_occurrence") @db.Date
  parentExpenseId String?             @map("parent_expense_id") @db.Uuid
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  submittedBy   User      @relation("expenseSubmittedBy", fields: [submittedById], references: [id])
  approvedBy    User?     @relation("expenseApprovedBy", fields: [approvedById], references: [id])
  parentExpense Expense?  @relation("recurringExpenses", fields: [parentExpenseId], references: [id])
  childExpenses Expense[] @relation("recurringExpenses")
  receipts      ExpenseReceipt[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, date])
  @@index([tenantId, category])
  @@index([tenantId, isRecurring, nextOccurrence])
  @@map("expenses")
}

model ExpenseReceipt {
  id          String   @id @default(uuid()) @db.Uuid
  expenseId   String   @map("expense_id") @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  fileName    String   @map("file_name")
  mimeType    String   @map("mime_type")
  fileSize    Int      @map("file_size")
  storagePath String   @map("storage_path")
  createdAt   DateTime @default(now()) @map("created_at")

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id])

  @@index([expenseId])
  @@index([tenantId])
  @@map("expense_receipts")
}

model Budget {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  month      Int
  year       Int
  totalLimit Decimal  @map("total_limit") @db.Decimal(12, 2)
  isActive   Boolean  @default(true) @map("is_active")
  createdById String  @map("created_by_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  tenant     Tenant           @relation(fields: [tenantId], references: [id])
  createdBy  User             @relation("budgetCreatedBy", fields: [createdById], references: [id])
  categories BudgetCategory[]

  @@unique([tenantId, month, year])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("budgets")
}

model BudgetCategory {
  id          String  @id @default(uuid()) @db.Uuid
  budgetId    String  @map("budget_id") @db.Uuid
  category    String
  limitAmount Decimal @map("limit_amount") @db.Decimal(12, 2)

  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@unique([budgetId, category])
  @@index([budgetId])
  @@map("budget_categories")
}

model InAppNotification {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String
  title     String
  message   String
  metadata  Json?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId, userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@map("in_app_notifications")
}

model AgentProfile {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @unique @map("user_id") @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  slug            String   @unique
  licenseNumber   String?  @map("license_number")
  bio             String?
  phone           String?
  email           String?
  website         String?
  linkedIn        String?  @map("linkedin")
  twitter         String?
  facebook        String?
  instagram       String?
  whatsApp        String?  @map("whatsapp")
  productsOffered String[] @map("products_offered")
  customLinks     Json?    @map("custom_links") @default("[]")
  coverPhotoPath  String?  @map("cover_photo_path")
  accentColor     String?  @map("accent_color") @default("#0f172a")
  isPublished     Boolean  @default(false) @map("is_published")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id])
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  testimonials Testimonial[]

  @@index([tenantId])
  @@index([slug])
  @@map("agent_profiles")
}

model Testimonial {
  id             String   @id @default(uuid()) @db.Uuid
  agentProfileId String   @map("agent_profile_id") @db.Uuid
  authorName     String   @map("author_name")
  authorEmail    String?  @map("author_email")
  isAnonymous    Boolean  @default(false) @map("is_anonymous")
  rating         Int
  content        String
  strengths      String[]
  isVisible      Boolean  @default(true) @map("is_visible")
  isFeatured     Boolean  @default(false) @map("is_featured")
  createdAt      DateTime @default(now()) @map("created_at")

  agentProfile AgentProfile @relation(fields: [agentProfileId], references: [id], onDelete: Cascade)

  @@index([agentProfileId, isVisible, createdAt(sort: Desc)])
  @@index([agentProfileId, isFeatured])
  @@map("testimonials")
}
