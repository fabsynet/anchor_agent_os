---
phase: 05-expenses-and-budgets
plan: 05
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - apps/web/src/app/(dashboard)/expenses/budgets/page.tsx
  - apps/web/src/components/budgets/budget-list.tsx
  - apps/web/src/components/budgets/budget-form-dialog.tsx
  - apps/web/src/components/budgets/budget-progress-bar.tsx
  - apps/web/src/components/dashboard/financial-widget.tsx
  - apps/web/src/components/dashboard/expense-donut-chart.tsx
  - apps/web/src/components/layout/notification-bell.tsx
  - apps/web/src/app/(dashboard)/page.tsx
  - apps/web/src/components/layout/top-nav.tsx
  - apps/web/src/components/ui/progress.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create a monthly budget with overall limit and per-category limits via dialog"
    - "Budget list shows active and past budgets with spending progress bars"
    - "Dashboard shows a financial widget with donut chart, progress bars, and summary numbers"
    - "Financial widget is only visible to admin or users with canViewFinancials flag"
    - "Notification bell in top nav shows unread count badge and recent alerts dropdown"
    - "Budget threshold alerts appear as in-app notifications in the bell dropdown"
    - "Donut chart shows category breakdown of approved expenses for current month"
    - "Admin can toggle team member financial visibility (canViewFinancials) on settings/team"
  artifacts:
    - path: "apps/web/src/components/dashboard/financial-widget.tsx"
      provides: "Combined budget progress + expense summary widget"
      min_lines: 80
    - path: "apps/web/src/components/dashboard/expense-donut-chart.tsx"
      provides: "Recharts donut chart for category breakdown"
      min_lines: 40
    - path: "apps/web/src/components/layout/notification-bell.tsx"
      provides: "Notification bell icon with unread count and dropdown"
      min_lines: 60
    - path: "apps/web/src/components/budgets/budget-form-dialog.tsx"
      provides: "Budget create/edit dialog with category limit rows"
      min_lines: 80
    - path: "apps/web/src/components/budgets/budget-list.tsx"
      provides: "Budget list with progress bars and month labels"
      min_lines: 60
  key_links:
    - from: "apps/web/src/components/dashboard/financial-widget.tsx"
      to: "/api/dashboard/financial"
      via: "Fetches financial summary data"
      pattern: "api\\.get.*dashboard/financial"
    - from: "apps/web/src/components/dashboard/expense-donut-chart.tsx"
      to: "recharts"
      via: "PieChart with innerRadius for donut"
      pattern: "PieChart|innerRadius"
    - from: "apps/web/src/components/layout/notification-bell.tsx"
      to: "/api/alerts"
      via: "Fetches unread count and alert list"
      pattern: "api\\.get.*alerts"
    - from: "apps/web/src/app/(dashboard)/page.tsx"
      to: "apps/web/src/components/dashboard/financial-widget.tsx"
      via: "Dashboard page renders FinancialWidget"
      pattern: "FinancialWidget"
---

<objective>
Build the Budget management UI, notification bell for in-app alerts, donut chart, and dashboard financial widget. This completes Phase 5 by giving admins budget control, everyone a notification system for threshold alerts, and the dashboard its financial awareness section.

Purpose: This is the final plan of Phase 5 -- it delivers the visual layer for budget tracking, spending alerts, and financial dashboard integration. Combined with the expense UI from Plan 04, this gives admins complete financial awareness.

Output: Budget list/form pages, notification bell in top nav, expense donut chart (Recharts), financial dashboard widget with progress bars and summary numbers, and canViewFinancials toggle on team settings.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-expenses-and-budgets/05-RESEARCH.md
@.planning/phases/05-expenses-and-budgets/05-CONTEXT.md
@.planning/phases/05-expenses-and-budgets/05-01-SUMMARY.md
@.planning/phases/05-expenses-and-budgets/05-03-SUMMARY.md
@apps/web/src/app/(dashboard)/page.tsx
@apps/web/src/components/dashboard/premium-income.tsx
@apps/web/src/components/dashboard/summary-cards.tsx
@apps/web/src/components/layout/top-nav.tsx
@apps/web/src/hooks/use-user.ts
@apps/web/src/lib/api.ts
@apps/web/src/app/(dashboard)/settings/page.tsx
@packages/shared/src/constants/expenses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Budget UI -- List, Form, Progress Bars</name>
  <files>
    apps/web/src/app/(dashboard)/expenses/budgets/page.tsx
    apps/web/src/components/budgets/budget-list.tsx
    apps/web/src/components/budgets/budget-form-dialog.tsx
    apps/web/src/components/budgets/budget-progress-bar.tsx
    apps/web/src/components/ui/progress.tsx
  </files>
  <action>
**progress.tsx (shadcn/ui component):**
Create a shadcn-style Progress component using @radix-ui/react-progress. Follow the shadcn/ui pattern -- Root with className, Indicator with dynamic width style. Accept `value` (0-100) and `className` props. Support custom indicator colors via className override.

**budget-progress-bar.tsx:**
Component showing a single budget category's spending progress.
Props: `category: string`, `spent: number`, `limit: number`.
- Calculate percentage: `Math.min((spent / limit) * 100, 100)`.
- Color coding: < 80% = primary (navy/blue), >= 80% = yellow-500, >= 100% = red-500.
- Layout: category label on left, "spent / limit" on right (CAD formatted), Progress bar below.
- Use the Progress component with dynamic indicator color.

**budget-list.tsx:**
Component showing all budgets with spending progress.
Props: none (fetches own data).

- Fetch `/api/budgets` on mount.
- Group budgets by active/inactive. Show active first.
- Each budget card shows:
  - Month/Year header (format with date-fns: "February 2026").
  - Overall budget: BudgetProgressBar with totalLimit and actual total spending (fetch from `/api/budgets/current` for current month, or show limit-only for past months).
  - Per-category progress bars (only for current month's active budget).
  - Status badge: Active (green) / Retired (gray).
  - Actions (admin only): Edit, Delete buttons.
- Three-state: loading (Skeleton cards), empty ("No budgets set up yet" + create button), data.
- If admin: "Create Budget" button at top.

**budget-form-dialog.tsx:**
Dialog for creating/editing budgets. Props: `open`, `onOpenChange`, `budget?: Budget`, `onSaved: () => void`.

Form fields (react-hook-form with zodResolver and createBudgetSchema):
1. **Month** -- Radix Select with months January-December (value 1-12). Default to current month for new budgets.
2. **Year** -- Number input or Select with current year +/- 1. Default to current year.
3. **Overall Monthly Limit** -- Number input with CAD prefix. Required.
4. **Per-Category Limits** (optional, dynamic rows):
   - "Add Category Limit" button adds a row.
   - Each row: Category dropdown (from EXPENSE_CATEGORIES), Limit Amount input, Remove button.
   - Use `useFieldArray` from react-hook-form for dynamic rows.
   - Categories already added are filtered out of the dropdown (no duplicates).
5. Submit creates via `POST /api/budgets` or updates via `PATCH /api/budgets/${id}`.

Admin-only: this entire form is only accessible to admin users. Non-admins see the list as read-only.

**budgets/page.tsx:**
Route: `/expenses/budgets`. Layout:
- Header: "Budgets" title + description.
- BudgetList component.
- BudgetFormDialog (controlled state).

NOTE: This is a sub-route of /expenses. Add it as `apps/web/src/app/(dashboard)/expenses/budgets/page.tsx`. Consider adding a tab or link on the main expenses page to navigate to budgets. Add "Budgets" as a secondary link/tab on the expenses page header (alongside the main expense list).
  </action>
  <verify>
Run `pnpm --filter web build` -- should compile.
Verify /expenses/budgets page renders budget list with progress bars.
Verify budget form has month, year, totalLimit, and dynamic category limit rows.
Verify progress bars color-code at 80% and 100% thresholds.
  </verify>
  <done>
Budget management UI complete: list page with active/retired budgets, progress bars with color-coded thresholds, create/edit form with dynamic per-category limits, admin-only mutation controls. Progress component created as reusable shadcn/ui component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Notification Bell, Financial Widget, and Dashboard Integration</name>
  <files>
    apps/web/src/components/layout/notification-bell.tsx
    apps/web/src/components/layout/top-nav.tsx
    apps/web/src/components/dashboard/financial-widget.tsx
    apps/web/src/components/dashboard/expense-donut-chart.tsx
    apps/web/src/app/(dashboard)/page.tsx
  </files>
  <action>
**notification-bell.tsx:**
Notification bell icon for the top nav bar.

- Fetch `/api/alerts/unread-count` on mount and on an interval (every 60 seconds -- simple polling).
- Render Bell icon (from lucide-react) with red badge showing unread count (if > 0).
- On click: toggle a dropdown (use Radix DropdownMenu with mounted state guard for hydration -- per established pattern from Phase 1).
- Dropdown shows:
  - Header: "Notifications" + "Mark all read" link.
  - List: fetch `/api/alerts?limit=10` and render each notification: title, message, relative time (date-fns formatDistanceToNow), unread indicator (dot).
  - Click on a notification: mark as read via `PATCH /api/alerts/${id}/read`, remove unread indicator.
  - Empty state: "No notifications".
  - Footer: (optional) "View all" link if you want a full page later -- for MVP, dropdown is sufficient.
- Use Radix Popover or DropdownMenu for the dropdown. Popover may be simpler for custom content layout.

**top-nav.tsx (modify existing):**
Add the NotificationBell component to the top nav bar, positioned before the user menu/avatar area. Import and render `<NotificationBell />`. This shows for all authenticated users.

**expense-donut-chart.tsx:**
Recharts donut chart component for category spending breakdown.
Props: `data: { name: string; value: number }[]`, `total: number`.

Implementation:
```
import { PieChart, Pie, Cell, Label, ResponsiveContainer, Tooltip } from 'recharts';
```
- Use PieChart with Pie component, innerRadius=60, outerRadius=80 for donut effect.
- Colors: Use CSS variables `hsl(var(--chart-1))` through `hsl(var(--chart-5))` for theme consistency. If more than 5 categories, cycle colors.
- Center label: Show total spent (CAD formatted) in the donut hole using Recharts Label component.
- Tooltip: Show category name and amount on hover.
- ResponsiveContainer: width="100%", height={200}.
- Handle empty state: if no data, show placeholder text instead of empty chart.

**financial-widget.tsx:**
Combined dashboard widget showing budget + expense summary.
Props: none (fetches own data from `/api/dashboard/financial`).

Layout (inside a Card, matching existing dashboard widget style):
1. **Header:** "Financial Overview" title, "Current Month" subtitle.
2. **Left side (or top on mobile):** ExpenseDonutChart showing category breakdown.
3. **Right side (or bottom on mobile):** Summary numbers:
   - Total Spent: CAD formatted, large text.
   - Expense Count: number with label.
   - Top Category: category name with badge.
   - Budget Usage: "X% of Y" with overall progress bar (if budget exists), or "No budget set" message.
4. **Below:** Per-category BudgetProgressBar components (if budget with category limits exists). Show top 5 categories, with "Show more" toggle if more exist.

**Access control:** The widget checks if the user can see financial data. Use `useUser()` hook -- if role is admin, always show. If not admin, fetch user profile (or check a property) for canViewFinancials. If no access, render nothing (don't show the widget at all). The `/api/dashboard/financial` endpoint returns 403 for unauthorized users -- catch this and hide widget.

**Three-state pattern:** Loading (Skeleton card matching widget dimensions), Empty (no budget and no expenses this month -- show "Set up your first budget" message for admin), Data (full widget).

**Dashboard page.tsx (modify existing):**
Add the FinancialWidget to the dashboard page. Place it in the grid below the existing premium income card (or alongside it). Import and render:
```tsx
{/* Financial Overview (Phase 5) */}
<FinancialWidget />
```

The widget self-manages its visibility (hides if user doesn't have access), so no conditional rendering needed in the page.

**Budget link on expenses page:**
Add a secondary navigation element (tab or button) on the expenses page header that links to `/expenses/budgets`. Something like:
```
<div className="flex gap-4">
  <Link href="/expenses" className={...active styles if on /expenses}>Expenses</Link>
  <Link href="/expenses/budgets" className={...active styles if on /expenses/budgets}>Budgets</Link>
</div>
```
This can be done by modifying the expenses page.tsx from Plan 04. If Plan 04 already ran, modify the page. If not, include the nav links in the current page structure. Either way, the expenses page should have sub-navigation to budgets.

**canViewFinancials toggle on settings/team:**
Locate the team settings page (likely `apps/web/src/app/(dashboard)/settings/team/page.tsx` or similar). Find where invited users are listed. Add a checkbox/toggle per user: "Can view financials". On toggle, call `PATCH /api/users/${userId}` with `{ canViewFinancials: boolean }`. This requires:
- Check if the users endpoint supports updating canViewFinancials. If not, note that it needs to be added (the UsersController/Service may need a minor update to accept this field).
- If the users update endpoint doesn't exist or doesn't support this field, create a minimal `PATCH /api/users/:id/financial-access` endpoint inline in the existing users controller, or simply add `canViewFinancials` to the existing user update DTO.
- The toggle only appears for admin users viewing the team list.
  </action>
  <verify>
Run `pnpm --filter web build` -- should compile with no errors.
Verify notification bell renders in top nav with badge count.
Verify donut chart renders with Recharts (no blank areas or console errors).
Verify financial widget appears on dashboard for admin users.
Verify financial widget is hidden for non-admin users without canViewFinancials.
Verify budget navigation link exists on expenses page.
Verify budgets sub-page is accessible at /expenses/budgets.
  </verify>
  <done>
Notification bell shows in top nav with unread count badge and alert dropdown. Financial widget on dashboard shows donut chart, budget progress bars, and expense summary numbers. Widget respects canViewFinancials access control. Budget navigation integrated with expenses page. canViewFinancials toggle added to team settings (admin only). All Recharts components render correctly with theme colors.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web build` passes with no errors
- /expenses/budgets page shows budget list with progress bars
- Budget form creates budgets with overall + per-category limits
- Dashboard financial widget shows donut chart and progress bars
- Widget hidden for non-admin users without canViewFinancials
- Notification bell in top nav shows unread count
- Alert dropdown lists recent notifications
- canViewFinancials toggle on settings/team page
- Recharts donut chart renders with theme-consistent colors
</verification>

<success_criteria>
- Admin can create/edit/delete budgets with progress tracking
- Dashboard financial widget shows complete financial overview (current month)
- Donut chart visualizes category spending breakdown
- In-app notification system works end-to-end (bell, badge, dropdown, mark read)
- Budget threshold alerts visible in notification dropdown
- Access control enforced for financial widget
- Sub-navigation between expenses and budgets pages
</success_criteria>

<output>
After completion, create `.planning/phases/05-expenses-and-budgets/05-05-SUMMARY.md`
</output>
