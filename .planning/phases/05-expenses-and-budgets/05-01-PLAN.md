---
phase: 05-expenses-and-budgets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - packages/shared/src/types/expense.ts
  - packages/shared/src/types/budget.ts
  - packages/shared/src/types/notification.ts
  - packages/shared/src/validation/expense.schema.ts
  - packages/shared/src/validation/budget.schema.ts
  - packages/shared/src/constants/expenses.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Prisma schema has Expense, ExpenseReceipt, Budget, BudgetCategory, InAppNotification models with correct relations"
    - "Shared types exist for all new entities with Decimal-as-string pattern"
    - "Zod validation schemas exist for expense and budget create/update"
    - "Expense categories constant defines 14 preset insurance agency categories"
    - "User model has canViewFinancials boolean field"
    - "Recharts is installed in web package"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "5 new models, 2 new enums, updated Tenant/User relations"
      contains: "model Expense"
    - path: "packages/shared/src/types/expense.ts"
      provides: "Expense, ExpenseReceipt, ExpenseStatus, RecurrenceFrequency types"
      exports: ["Expense", "ExpenseReceipt", "ExpenseStatus", "RecurrenceFrequency"]
    - path: "packages/shared/src/types/budget.ts"
      provides: "Budget, BudgetCategory types"
      exports: ["Budget", "BudgetCategory"]
    - path: "packages/shared/src/types/notification.ts"
      provides: "InAppNotification type"
      exports: ["InAppNotification"]
    - path: "packages/shared/src/validation/expense.schema.ts"
      provides: "createExpenseSchema, updateExpenseSchema, submitExpenseSchema"
      exports: ["createExpenseSchema", "updateExpenseSchema", "CreateExpenseInput", "UpdateExpenseInput"]
    - path: "packages/shared/src/validation/budget.schema.ts"
      provides: "createBudgetSchema, updateBudgetSchema"
      exports: ["createBudgetSchema", "updateBudgetSchema", "CreateBudgetInput", "UpdateBudgetInput"]
    - path: "packages/shared/src/constants/expenses.ts"
      provides: "EXPENSE_CATEGORIES, EXPENSE_STATUSES, RECURRENCE_FREQUENCIES"
      exports: ["EXPENSE_CATEGORIES", "EXPENSE_STATUSES", "RECURRENCE_FREQUENCIES"]
    - path: "packages/shared/src/index.ts"
      provides: "Re-exports all new types, schemas, constants"
  key_links:
    - from: "packages/database/prisma/schema.prisma"
      to: "packages/shared/src/types/expense.ts"
      via: "Type definitions mirror Prisma models"
      pattern: "ExpenseStatus"
    - from: "packages/shared/src/validation/expense.schema.ts"
      to: "packages/shared/src/constants/expenses.ts"
      via: "Schema references category constants for validation"
      pattern: "EXPENSE_CATEGORIES"
---

<objective>
Create the data foundation for Phase 5: Prisma schema models, shared TypeScript types, Zod validation schemas, expense category constants, and install Recharts.

Purpose: All backend and frontend plans depend on these models, types, and schemas existing first. This is the horizontal foundation that enables parallel work in Wave 2.

Output: Updated Prisma schema with 5 new models (Expense, ExpenseReceipt, Budget, BudgetCategory, InAppNotification), 2 new enums (ExpenseStatus, RecurrenceFrequency), shared type definitions, Zod schemas, constants, and Recharts installed.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-expenses-and-budgets/05-RESEARCH.md
@.planning/phases/05-expenses-and-budgets/05-CONTEXT.md
@packages/database/prisma/schema.prisma
@packages/shared/src/index.ts
@packages/shared/src/types/document.ts
@packages/shared/src/types/task.ts
@packages/shared/src/validation/document.schema.ts
@packages/shared/src/validation/task.schema.ts
@packages/shared/src/constants/documents.ts
@packages/shared/src/constants/tasks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma Schema -- New Models and Enums</name>
  <files>
    packages/database/prisma/schema.prisma
  </files>
  <action>
Add the following to schema.prisma:

**New enums:**
1. `ExpenseStatus` with values: `draft`, `pending_approval`, `approved`, `rejected`. Map to `@@map("expense_status")`.
2. `RecurrenceFrequency` with values: `weekly`, `monthly`, `yearly`. Map to `@@map("recurrence_frequency")`.

**New models (follow exact patterns from RESEARCH.md):**
1. `Expense` -- id (UUID), tenantId, amount (Decimal 12,2), currency (default "CAD", VarChar 3), category (String -- not enum, supports custom), description (optional), date (Date), status (ExpenseStatus, default draft), submittedById (UUID), approvedById (optional UUID), approvedAt (optional), rejectionNote (optional), isRecurring (Boolean default false), recurrence (optional RecurrenceFrequency), nextOccurrence (optional Date), parentExpenseId (optional UUID, self-relation for recurring), createdAt, updatedAt. Relations: tenant, submittedBy (User "expenseSubmittedBy"), approvedBy (User? "expenseApprovedBy"), parentExpense/childExpenses self-relation ("recurringExpenses"), receipts[]. Indexes: tenantId, tenantId+status, tenantId+date, tenantId+category, tenantId+isRecurring+nextOccurrence. Map to "expenses".

2. `ExpenseReceipt` -- id (UUID), expenseId (UUID), tenantId (UUID), fileName, mimeType, fileSize (Int), storagePath, createdAt. Relations: expense (Expense, onDelete: Cascade), tenant. Indexes: expenseId, tenantId. Map to "expense_receipts".

3. `Budget` -- id (UUID), tenantId, month (Int 1-12), year (Int), totalLimit (Decimal 12,2), isActive (Boolean default true), createdById (UUID), createdAt, updatedAt. Relations: tenant, createdBy (User "budgetCreatedBy"), categories[]. Unique: @@unique([tenantId, month, year]). Indexes: tenantId, tenantId+isActive. Map to "budgets".

4. `BudgetCategory` -- id (UUID), budgetId (UUID), category (String), limitAmount (Decimal 12,2). Relations: budget (Budget, onDelete: Cascade). Unique: @@unique([budgetId, category]). Indexes: budgetId. Map to "budget_categories".

5. `InAppNotification` -- id (UUID), tenantId, userId (UUID), type (String), title, message, metadata (Json?), isRead (Boolean default false), createdAt. Relations: tenant, user. Indexes: tenantId+userId+isRead, userId+createdAt(sort: Desc). Map to "in_app_notifications".

**Update existing models:**
- `Tenant`: add relations `expenses Expense[]`, `expenseReceipts ExpenseReceipt[]`, `budgets Budget[]`, `notifications InAppNotification[]`
- `User`: add field `canViewFinancials Boolean @default(false) @map("can_view_financials")`. Add relations: `expensesSubmitted Expense[] @relation("expenseSubmittedBy")`, `expensesApproved Expense[] @relation("expenseApprovedBy")`, `budgetsCreated Budget[] @relation("budgetCreatedBy")`, `notifications InAppNotification[]`

**After editing schema, run:**
```bash
pnpm --filter database exec prisma db push
pnpm --filter database exec prisma generate
```

CRITICAL: Use `prisma db push` (not migrate) per established decision -- Supabase shadow DB fails on auth.users trigger.
  </action>
  <verify>
Run `pnpm --filter database exec prisma validate` -- should exit 0 with no errors.
Run `pnpm --filter database exec prisma generate` -- should complete without errors.
Run `pnpm --filter api build` -- should compile with new model types available (after prisma generate).
  </verify>
  <done>
Schema.prisma contains all 5 new models and 2 new enums. Prisma client is generated with new model accessors (prisma.expense, prisma.expenseReceipt, prisma.budget, prisma.budgetCategory, prisma.inAppNotification). User model has canViewFinancials field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Shared Types, Validation Schemas, and Constants</name>
  <files>
    packages/shared/src/types/expense.ts
    packages/shared/src/types/budget.ts
    packages/shared/src/types/notification.ts
    packages/shared/src/validation/expense.schema.ts
    packages/shared/src/validation/budget.schema.ts
    packages/shared/src/constants/expenses.ts
    packages/shared/src/index.ts
  </files>
  <action>
**1. Create `packages/shared/src/types/expense.ts`:**
- Export type `ExpenseStatus = 'draft' | 'pending_approval' | 'approved' | 'rejected'`
- Export type `RecurrenceFrequency = 'weekly' | 'monthly' | 'yearly'`
- Export interface `Expense` with all fields from Prisma model. Use `string` for amount (Decimal-as-string pattern per Phase 2 decision). Include submittedBy/approvedBy as optional nested `{ id: string; firstName: string; lastName: string; email: string }` for list display.
- Export interface `ExpenseReceipt` with all fields from Prisma model. fileSize as number.
- Export interface `ExpenseListItem` extending Expense with `receipts: ExpenseReceipt[]` and `submittedBy: { id: string; firstName: string; lastName: string }`.

**2. Create `packages/shared/src/types/budget.ts`:**
- Export interface `BudgetCategory` with id, budgetId, category, limitAmount (string -- Decimal).
- Export interface `Budget` with all fields from Prisma model. totalLimit as string (Decimal). Include `categories: BudgetCategory[]` and `createdBy: { id: string; firstName: string; lastName: string }`.

**3. Create `packages/shared/src/types/notification.ts`:**
- Export interface `InAppNotification` with all fields from Prisma model. metadata as `Record<string, unknown> | null`.

**4. Create `packages/shared/src/constants/expenses.ts`:**
- Export `EXPENSE_CATEGORIES` -- array of `{ value: string; label: string }` with 14 insurance agency presets:
  office_rent (Office Rent & Lease), office_supplies (Office Supplies), technology (Technology & Software), marketing (Marketing & Advertising), licensing (Licensing & Regulatory Fees), eo_insurance (E&O Insurance), travel (Travel & Mileage), professional_development (Professional Development), salaries (Salaries & Commissions), client_entertainment (Client Entertainment), telephone (Telephone & Internet), postage (Postage & Shipping), utilities (Utilities), other (Other).
- Export `EXPENSE_STATUSES` -- array of `{ value: ExpenseStatus; label: string }`: draft (Draft), pending_approval (Pending Approval), approved (Approved), rejected (Rejected).
- Export `RECURRENCE_FREQUENCIES` -- array of `{ value: RecurrenceFrequency; label: string }`: weekly, monthly, yearly.
- Export `RECEIPT_ALLOWED_MIME_TYPES` = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'] (per user decision).
- Export `RECEIPT_MAX_FILE_SIZE` = 10 * 1024 * 1024 (10MB, matching Phase 4 pattern).

**5. Create `packages/shared/src/validation/expense.schema.ts`:**
- `createExpenseSchema`: z.object with amount (z.coerce.number().positive()), category (z.string().min(1)), date (z.coerce.date()), description (z.string().optional()), isRecurring (z.boolean().default(false)), recurrence (z.enum(['weekly','monthly','yearly']).optional()). Add .refine: if isRecurring is true, recurrence must be provided.
- `updateExpenseSchema`: separate z.object (not .partial() -- per Phase 2 decision) with same fields all optional except keep the refine.
- Export types: `CreateExpenseInput = z.input<typeof createExpenseSchema>`, `UpdateExpenseInput = z.input<typeof updateExpenseSchema>`.

**6. Create `packages/shared/src/validation/budget.schema.ts`:**
- `createBudgetSchema`: z.object with month (z.number().int().min(1).max(12)), year (z.number().int().min(2020).max(2100)), totalLimit (z.coerce.number().positive()), categories (z.array(z.object({ category: z.string().min(1), limitAmount: z.coerce.number().positive() })).optional().default([])).
- `updateBudgetSchema`: separate z.object with totalLimit (optional), categories (optional array same shape).
- Export types using z.input<> pattern.

**7. Update `packages/shared/src/index.ts`:**
Add all new exports following existing patterns:
```typescript
// Types - Expenses & Budgets
export type { ExpenseStatus, RecurrenceFrequency, Expense, ExpenseReceipt, ExpenseListItem } from './types/expense';
export type { Budget, BudgetCategory } from './types/budget';
export type { InAppNotification } from './types/notification';

// Constants - Expenses
export { EXPENSE_CATEGORIES, EXPENSE_STATUSES, RECURRENCE_FREQUENCIES, RECEIPT_ALLOWED_MIME_TYPES, RECEIPT_MAX_FILE_SIZE } from './constants/expenses';

// Validation schemas - Expenses & Budgets
export { createExpenseSchema, updateExpenseSchema } from './validation/expense.schema';
export type { CreateExpenseInput, UpdateExpenseInput } from './validation/expense.schema';
export { createBudgetSchema, updateBudgetSchema } from './validation/budget.schema';
export type { CreateBudgetInput, UpdateBudgetInput } from './validation/budget.schema';
```

**8. Install Recharts:**
```bash
pnpm --filter web add recharts
```

Also ensure `@radix-ui/react-progress` is available for budget progress bars. Check if already installed; if not:
```bash
pnpm --filter web add @radix-ui/react-progress
```
  </action>
  <verify>
Run `pnpm --filter shared build` -- should compile with all new exports.
Run `pnpm --filter web build` -- should resolve recharts import (test with a temporary import if needed, then remove).
Verify all types are importable: `import { Expense, Budget, InAppNotification, EXPENSE_CATEGORIES, createExpenseSchema } from '@anchor/shared'` compiles.
  </verify>
  <done>
All shared types, validation schemas, and constants exist and are exported from @anchor/shared. Recharts is installed in the web package. The shared package builds successfully. Types use Decimal-as-string pattern. Zod schemas use z.input<> pattern for form types.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter database exec prisma validate` passes
- `pnpm --filter shared build` passes
- `pnpm --filter api build` passes (Prisma client generated with new models)
- `pnpm --filter web build` passes (recharts installed)
- Schema has Expense, ExpenseReceipt, Budget, BudgetCategory, InAppNotification models
- User model has canViewFinancials field
- 14 preset expense categories defined in constants
</verification>

<success_criteria>
- All 5 Prisma models created with correct relations, indexes, and constraints
- Shared types mirror Prisma models with Decimal-as-string pattern
- Zod validation schemas exist for expense and budget create/update
- Constants define 14 expense categories, statuses, and recurrence frequencies
- Recharts and @radix-ui/react-progress installed in web package
- All packages build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-expenses-and-budgets/05-01-SUMMARY.md`
</output>
