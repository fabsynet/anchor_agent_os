---
phase: 05-expenses-and-budgets
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - apps/web/src/app/(dashboard)/expenses/page.tsx
  - apps/web/src/components/expenses/expense-list.tsx
  - apps/web/src/components/expenses/expense-form-dialog.tsx
  - apps/web/src/components/expenses/expense-receipt-upload.tsx
  - apps/web/src/components/expenses/expense-receipt-preview.tsx
  - apps/web/src/components/expenses/expense-category-badge.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a list of expenses with pagination, status tabs, and category filter"
    - "User can create an expense with amount, category, date, description via form dialog"
    - "User can mark an expense as recurring (weekly/monthly/yearly)"
    - "User can upload multiple receipts with drag-and-drop zone in the expense form"
    - "User can view receipt thumbnails/previews inline (images as thumbnails, PDFs as icons)"
    - "Admin sees Approve/Reject buttons inline on pending expenses"
    - "Admin sees pending approval count badge on the expenses page header"
    - "User can edit draft/rejected expenses and resubmit"
    - "No client or policy linkage appears on expense forms"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/expenses/page.tsx"
      provides: "Full expense management page replacing placeholder"
      min_lines: 50
    - path: "apps/web/src/components/expenses/expense-list.tsx"
      provides: "Expense table with status tabs, filters, pagination, inline approval"
      min_lines: 100
    - path: "apps/web/src/components/expenses/expense-form-dialog.tsx"
      provides: "Create/edit expense dialog with all fields and receipt upload"
      min_lines: 100
    - path: "apps/web/src/components/expenses/expense-receipt-upload.tsx"
      provides: "Drag-and-drop receipt upload zone with file validation"
      min_lines: 50
    - path: "apps/web/src/components/expenses/expense-receipt-preview.tsx"
      provides: "Receipt thumbnail/lightbox preview"
      min_lines: 40
  key_links:
    - from: "apps/web/src/app/(dashboard)/expenses/page.tsx"
      to: "/api/expenses"
      via: "api.get/post for expense CRUD"
      pattern: "api\\.(get|post|patch|delete).*expenses"
    - from: "apps/web/src/components/expenses/expense-form-dialog.tsx"
      to: "/api/expenses"
      via: "Form submission creates/updates expense"
      pattern: "api\\.post.*expenses"
    - from: "apps/web/src/components/expenses/expense-receipt-upload.tsx"
      to: "/api/expenses/:id/receipts"
      via: "FormData upload with files"
      pattern: "FormData"
---

<objective>
Build the complete Expense management UI: replace the placeholder expenses page with a full-featured expense list (status tabs, filters, pagination, inline admin approval), expense form dialog (create/edit with receipt upload), and receipt preview components.

Purpose: This gives all users the ability to track expenses and admins the ability to approve/reject them. The UI follows existing patterns (Dialog forms, table lists, three-state loading) while adding the drag-and-drop receipt upload zone from Phase 4's document upload pattern.

Output: Fully functional /expenses page with expense CRUD, status-based workflows, receipt upload/preview, and admin approval inline.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-expenses-and-budgets/05-RESEARCH.md
@.planning/phases/05-expenses-and-budgets/05-CONTEXT.md
@.planning/phases/05-expenses-and-budgets/05-01-SUMMARY.md
@.planning/phases/05-expenses-and-budgets/05-02-SUMMARY.md
@apps/web/src/app/(dashboard)/expenses/page.tsx
@apps/web/src/components/documents/document-upload-zone.tsx
@apps/web/src/components/tasks/task-form-dialog.tsx
@apps/web/src/components/clients/client-list.tsx
@apps/web/src/lib/api.ts
@apps/web/src/hooks/use-user.ts
@packages/shared/src/constants/expenses.ts
@packages/shared/src/validation/expense.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expense List with Status Tabs, Filters, Pagination, and Inline Approval</name>
  <files>
    apps/web/src/components/expenses/expense-list.tsx
    apps/web/src/components/expenses/expense-category-badge.tsx
  </files>
  <action>
**expense-category-badge.tsx:**
Simple component that renders a category label with a colored badge. Map each preset category value to a label using EXPENSE_CATEGORIES constant. For custom categories, display the raw string with a default color. Use shadcn Badge component.

**expense-list.tsx:**
Create a comprehensive expense list component. Props: none (fetches its own data).

**Layout:**
1. **Status tabs** at the top: All, Pending ({count} badge), Approved, Rejected, Draft. Use shadcn Tabs component. Default to "All". If user is admin and there are pending expenses, default to "Pending" tab.
2. **Category filter** dropdown: Use Radix Select with _none sentinel for "All Categories" (per established pattern). Populate from `/api/expenses/categories`.
3. **Date range filter**: Optional from/to date inputs.
4. **Expense table** using the same table pattern as client-list.tsx (not @tanstack/react-table -- match the simpler pattern if that's what exists, or use DataTable if established). Columns:
   - Date (formatted with date-fns format)
   - Category (ExpenseCategoryBadge)
   - Description (truncated to ~50 chars)
   - Amount (CAD formatted using Intl.NumberFormat)
   - Submitted By (firstName lastName)
   - Status (colored badge: draft=gray, pending=yellow, approved=green, rejected=red)
   - Actions: View, Edit (if draft/rejected), Submit (if draft), Approve/Reject (if admin + pending)
5. **Pagination** at bottom: page numbers, prev/next. Match existing pagination pattern.

**Inline approval (admin only):**
When user.role === 'admin' and expense status is 'pending_approval':
- Show "Approve" button (green) and "Reject" button (red) in the actions column.
- Approve: call `api.post('/api/expenses/${id}/approve')`, show sonner toast on success, refetch list.
- Reject: show a small Dialog/Popover prompting for optional rejection note. On confirm: call `api.post('/api/expenses/${id}/reject', { rejectionNote })`, toast, refetch.

**Pending count badge:**
Fetch `/api/expenses/pending-count` on mount. Show badge on "Pending" tab.

**Three-state pattern:**
- Loading: Skeleton rows (match existing patterns).
- Empty: "No expenses found" message with icon.
- Data: Render table rows.

**Currency formatting:**
Use `Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' })` pattern from premium-income.tsx.

**Row click:** Opens expense detail (calls onView callback which parent page handles by opening form dialog in view/edit mode).

Use the `useUser` hook to check admin role for approval buttons.
  </action>
  <verify>
Run `pnpm --filter web build` -- should compile.
Verify expense-list.tsx renders status tabs, category filter, table, and pagination.
Verify admin-only approval buttons are conditionally rendered.
Verify currency formatting uses CAD.
  </verify>
  <done>
ExpenseList component displays expenses in a table with status tabs (All/Pending/Approved/Rejected/Draft), category filter, date range filter, pagination, and inline approval buttons for admin users. Category badges show preset labels. Currency formatted as CAD.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expense Form Dialog with Receipt Upload and Page Integration</name>
  <files>
    apps/web/src/components/expenses/expense-form-dialog.tsx
    apps/web/src/components/expenses/expense-receipt-upload.tsx
    apps/web/src/components/expenses/expense-receipt-preview.tsx
    apps/web/src/app/(dashboard)/expenses/page.tsx
  </files>
  <action>
**expense-receipt-upload.tsx:**
Drag-and-drop zone for receipt files. Reuse the pattern from `document-upload-zone.tsx` (Phase 4).
- Accept: JPEG, PNG, WebP, PDF (per user decision).
- Max file size: 10MB per file (RECEIPT_MAX_FILE_SIZE from shared constants).
- Show drop zone with dashed border, icon, and text "Drop receipts here or click to browse".
- On files selected/dropped: validate mime type and size, show errors inline via sonner toast for invalid files.
- Props: `onFilesSelected(files: File[])`, `existingReceipts?: ExpenseReceipt[]`, `disabled?: boolean`.
- Display already-uploaded receipts below the drop zone (for edit mode).
- Allow removing pending (not-yet-uploaded) files from the selection.

**expense-receipt-preview.tsx:**
Displays receipt thumbnails for already-uploaded receipts.
- For images (JPEG/PNG/WebP): show thumbnail using signed URL. On click, open in lightbox (simple fullscreen overlay with close button -- or use window.open to the signed URL for simplicity).
- For PDFs: show PDF icon with filename. On click, open in new tab using signed URL.
- Each receipt shows: filename, file size (human-readable KB/MB), delete button (X icon).
- Delete calls `api.delete('/api/expenses/receipts/${receiptId}')`, shows toast, calls onDeleted callback.
- Fetch signed URLs on mount: `api.get('/api/expenses/receipts/${receiptId}/url')`.

**expense-form-dialog.tsx:**
Dialog for creating and editing expenses. Props: `open`, `onOpenChange`, `expense?: Expense` (if editing), `onSaved: () => void`.

Form fields (use react-hook-form with zodResolver and createExpenseSchema):
1. **Amount** -- Number input with CAD prefix label. Required.
2. **Category** -- Radix Select dropdown. Options: preset categories from EXPENSE_CATEGORIES constant + any custom categories from `/api/expenses/categories`. Include a "Custom..." option that shows a text input for freeform entry.
3. **Date** -- Date input. Default to today for new expenses.
4. **Description** -- Textarea, optional.
5. **Recurring** -- Checkbox "This is a recurring expense". When checked, show:
   - **Frequency** -- Radix Select: Weekly, Monthly, Yearly.
6. **Receipts** -- ExpenseReceiptUpload component below the form fields.

**NO client or policy linkage fields** -- per user decision, expenses stand alone.

**Create flow:**
1. Submit form data to `POST /api/expenses` to create the expense (status: draft).
2. If files were selected in the upload zone, upload them to `POST /api/expenses/${newId}/receipts` as FormData with multiple files.
3. Show sonner toast "Expense created".
4. Optionally prompt "Submit for approval?" -- or let user do it from the list.

**Edit flow:**
1. Populate form with existing expense data (useEffect reset pattern from Phase 2).
2. Show existing receipts via ExpenseReceiptPreview.
3. Allow adding new receipts.
4. Submit updates to `PATCH /api/expenses/${id}`.
5. If status was 'rejected', inform user it's been reset to 'draft'.

**View mode:** When expense is approved/pending, form is read-only. Show all fields as text, receipts as preview-only.

**expenses/page.tsx (replace placeholder):**
Replace the current placeholder with a full page:
```
'use client';

- Header: "Expenses" title + description + "Add Expense" button (opens form dialog).
- If admin: show pending count badge next to title.
- ExpenseList component.
- ExpenseFormDialog component (controlled by state: open, selectedExpense).
```
Wire callbacks: list row click opens dialog in edit/view mode. "Add Expense" opens dialog in create mode. On save, refetch list.
  </action>
  <verify>
Run `pnpm --filter web build` -- should compile without errors.
Verify the expenses page replaces the placeholder content.
Verify form dialog has all required fields (amount, category, date, description, recurring, receipts).
Verify no client/policy linkage fields exist on the form.
Verify receipt upload zone accepts JPEG, PNG, WebP, PDF.
  </verify>
  <done>
Expenses page is fully functional with expense list (tabs, filters, pagination, approval), form dialog (create/edit with all fields), receipt upload zone (drag-and-drop, file validation), and receipt preview (thumbnails, signed URLs, delete). No client/policy linkage. Admin can approve/reject inline. All patterns follow established codebase conventions.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web build` passes with no errors
- /expenses page loads with expense list (not placeholder)
- Form dialog creates expenses with amount, category, date, description
- Receipt upload zone accepts JPEG/PNG/WebP/PDF with 10MB limit
- Admin sees approve/reject buttons on pending expenses
- Status tabs filter correctly (All/Pending/Approved/Rejected/Draft)
- Category filter shows presets + custom categories
- CAD currency formatting throughout
- No client or policy linkage on expense forms
</verification>

<success_criteria>
- Complete expense CRUD UI with list, form, and detail views
- Receipt upload/preview with drag-and-drop and inline thumbnails
- Admin approval workflow with inline approve/reject and rejection notes
- Status-based filtering with tab interface
- Recurring expense configuration in form
- Page replaces placeholder entirely
</success_criteria>

<output>
After completion, create `.planning/phases/05-expenses-and-budgets/05-04-SUMMARY.md`
</output>
