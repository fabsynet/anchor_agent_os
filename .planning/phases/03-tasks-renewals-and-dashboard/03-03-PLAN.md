---
phase: 03-tasks-renewals-and-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/api/src/dashboard/dashboard.module.ts
  - apps/api/src/dashboard/dashboard.controller.ts
  - apps/api/src/dashboard/dashboard.service.ts
  - apps/api/src/notifications/notifications.module.ts
  - apps/api/src/notifications/notifications.service.ts
  - apps/api/src/notifications/notifications.scheduler.ts
  - apps/api/src/notifications/emails/daily-digest.tsx
  - apps/api/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard API returns summary counts (overdue, due today, renewals in 30 days, active clients)"
    - "Dashboard API returns upcoming renewals, overdue tasks, recent activity, and premium income"
    - "Daily digest email sends at 8 AM with overdue tasks and renewal milestones"
    - "Users with digestOptOut=true do not receive digest emails"
    - "Premium income shows current month, YTD, and trend percentage vs previous month"
    - "Premium income aggregation uses policy startDate (effective date) not createdAt (data entry date)"
    - "Daily digest includes renewal milestones at ALL upcoming intervals (60/30/7 days), not just 7-day"
  artifacts:
    - path: "apps/api/src/dashboard/dashboard.controller.ts"
      provides: "5 dashboard endpoints: summary, renewals, overdue-tasks, recent-activity, premium-income"
      exports: ["DashboardController"]
    - path: "apps/api/src/dashboard/dashboard.service.ts"
      provides: "Aggregation queries for dashboard data with manual tenantId in count/aggregate"
      exports: ["DashboardService"]
    - path: "apps/api/src/notifications/notifications.service.ts"
      provides: "Daily digest email composition and sending via Resend"
      exports: ["NotificationsService"]
    - path: "apps/api/src/notifications/notifications.scheduler.ts"
      provides: "Daily cron at 8 AM for digest emails"
      exports: ["NotificationsScheduler"]
    - path: "apps/api/src/notifications/emails/daily-digest.tsx"
      provides: "React Email template for daily digest"
  key_links:
    - from: "apps/api/src/dashboard/dashboard.service.ts"
      to: "prisma.task.count"
      via: "manual tenantId in count queries"
      pattern: "this\\.prisma\\.task\\.count.*tenantId"
    - from: "apps/api/src/notifications/notifications.service.ts"
      to: "resend.emails.send"
      via: "Resend SDK for email delivery"
      pattern: "resend\\.emails\\.send"
    - from: "apps/api/src/notifications/notifications.scheduler.ts"
      to: "apps/api/src/notifications/notifications.service.ts"
      via: "@Cron at 8 AM calls sendDailyDigestForAllTenants"
      pattern: "@Cron.*sendDailyDigest"
---

<objective>
Build the Dashboard API endpoints (5 data sources for the frontend dashboard) and the Email Notifications module (daily digest with overdue tasks + renewal milestones via Resend).

Purpose: The dashboard frontend (Plan 05) needs backend data endpoints. Email notifications fulfill the "no quiet failures" promise by sending daily digests so nothing slips through the cracks.
Output: DashboardModule with 5 endpoints, NotificationsModule with Resend integration and daily cron.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tasks-renewals-and-dashboard/03-CONTEXT.md
@.planning/phases/03-tasks-renewals-and-dashboard/03-RESEARCH.md
@.planning/phases/03-tasks-renewals-and-dashboard/03-01-SUMMARY.md
@apps/api/src/app.module.ts
@apps/api/src/common/prisma/prisma.service.ts
@apps/api/src/common/decorators/tenant-id.decorator.ts
@apps/api/src/policies/policies.service.ts
@apps/api/src/timeline/timeline.service.ts
@packages/shared/src/types/activity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard API module -- 5 endpoints for dashboard data</name>
  <files>
    apps/api/src/dashboard/dashboard.module.ts
    apps/api/src/dashboard/dashboard.controller.ts
    apps/api/src/dashboard/dashboard.service.ts
    apps/api/src/app.module.ts
  </files>
  <action>
**DashboardService (`apps/api/src/dashboard/dashboard.service.ts`):**

Inject `PrismaService`. All queries use raw `this.prisma` with manual `tenantId` in where clauses (count() and aggregate() are NOT overridden by tenant extension per Phase 2 lesson).

Methods:

1. `getSummary(tenantId)`: Return 4 counts using `Promise.all`:
   - `overdueCount`: tasks where dueDate < today AND status != 'done', tenantId matches
   - `dueTodayCount`: tasks where dueDate is today AND status != 'done', tenantId matches
   - `renewalsIn30Days`: policies where endDate is between today and 30 days from now AND status in ['active', 'pending_renewal'], tenantId matches
   - `activeClients`: clients where status = 'client', tenantId matches

   Use `startOfDay(new Date())` from date-fns for consistent date comparison.

2. `getUpcomingRenewals(tenantId)`: Find policies expiring within next 60 days. Use `this.prisma.policy.findMany()` with where: `{ tenantId, endDate: { gte: today, lte: addDays(today, 60) }, status: { in: ['active', 'pending_renewal'] } }`. Include client relation `{ select: { id, firstName, lastName } }`. Order by endDate asc. Limit to 20.

   Map results to include `daysRemaining: differenceInDays(endDate, today)`.

3. `getOverdueTasks(tenantId)`: Find tasks where dueDate < today AND status != 'done'. Use `this.prisma.task.findMany()` with manual tenantId. Include client relation. Order by dueDate asc (oldest overdue first). Limit to 20.

4. `getRecentActivity(tenantId)`: Query latest 10 activity events. Use `this.prisma.activityEvent.findMany()` with manual tenantId. Include client `{ select: { id, firstName, lastName } }` and user `{ select: { id, firstName, lastName } }`. Order by createdAt desc. Limit to 10.

   Claude's discretion: Show all event types (client_created, policy_created, task_created, task_completed, etc.) for a comprehensive view.

5. `getPremiumIncome(tenantId)`: Calculate current month total, YTD total, and trend vs previous month.
   - Use `this.prisma.policy.aggregate()` with `_sum: { premium: true }` and manual tenantId.
   - Three parallel queries: currentMonth (startDate >= startOfMonth(now)), YTD (startDate >= startOfYear(now)), previousMonth (startDate between start and end of previous month).
   - CRITICAL: Use `startDate` (policy effective date) NOT `createdAt` (data entry date) for premium income aggregation. startDate represents when the policy actually took effect, which is the correct date for income reporting. Add a fallback: if startDate is null for some policies, those policies should still be included -- use a combined filter: `OR: [{ startDate: { gte: startOfMonth(now) } }, { AND: [{ startDate: null }, { createdAt: { gte: startOfMonth(now) } }] }]`. Apply the same OR pattern for YTD and previousMonth queries.
   - Filter by status in ['active', 'pending_renewal', 'renewed'] and premium not null.
   - Convert Decimal to Number: `Number(result._sum.premium ?? 0)`.
   - Calculate trendPercentage: `((currentMonth - previousMonth) / previousMonth) * 100`, round to 1 decimal. Return 0 if previousMonth is 0.

   Return: `{ currentMonth, ytd, previousMonth, trendPercentage }`.

CRITICAL: Use `startOfMonth`, `startOfYear`, `endOfMonth`, `subMonths`, `addDays`, `differenceInDays`, `startOfDay` from date-fns for all date calculations.

**DashboardController (`apps/api/src/dashboard/dashboard.controller.ts`):**

```
@Controller('dashboard')
@UseGuards(JwtAuthGuard)
```

5 GET endpoints, each extracting `@TenantId() tenantId`:
- `GET /dashboard/summary` -> getSummary
- `GET /dashboard/renewals` -> getUpcomingRenewals
- `GET /dashboard/overdue-tasks` -> getOverdueTasks
- `GET /dashboard/recent-activity` -> getRecentActivity
- `GET /dashboard/premium-income` -> getPremiumIncome

**DashboardModule:** Import PrismaModule. Provide DashboardService, DashboardController.

**AppModule:** Add DashboardModule to imports.
  </action>
  <verify>
Run `pnpm --filter api build` -- compiles cleanly.
Test endpoints (after API start):
- `GET /dashboard/summary` returns `{ overdueCount, dueTodayCount, renewalsIn30Days, activeClients }`
- `GET /dashboard/renewals` returns array of policies with client info and daysRemaining
- `GET /dashboard/overdue-tasks` returns array of tasks with client info
- `GET /dashboard/recent-activity` returns array of activity events
- `GET /dashboard/premium-income` returns `{ currentMonth, ytd, previousMonth, trendPercentage }` using startDate-based aggregation
  </verify>
  <done>Dashboard API serves all 5 data sources: summary counts, upcoming renewals, overdue tasks, recent activity feed, and premium income with trend percentage. Premium income uses policy startDate (with createdAt fallback for null startDate). All queries use manual tenantId for count/aggregate operations.</done>
</task>

<task type="auto">
  <name>Task 2: Email notifications -- daily digest via Resend + React Email + cron scheduler</name>
  <files>
    apps/api/src/notifications/notifications.module.ts
    apps/api/src/notifications/notifications.service.ts
    apps/api/src/notifications/notifications.scheduler.ts
    apps/api/src/notifications/emails/daily-digest.tsx
    apps/api/src/app.module.ts
  </files>
  <action>
**React Email template (`apps/api/src/notifications/emails/daily-digest.tsx`):**

Create using `@react-email/components`. The file uses JSX/TSX -- the API tsconfig was updated with `"jsx": "react-jsx"` in Plan 01.

Template structure:
- Preview text: "X overdue tasks, Y upcoming renewals"
- Heading: "Good morning, {userName}"
- Section 1: **Upcoming Renewal Milestones** (if any) -- table with columns: Policy Type, Client, Days Remaining, Expiry Date
- Section 2: **Overdue Tasks** (if any) -- list with title, client name, due date, priority badge
- Footer: "This is your daily digest from Anchor. Manage notification preferences in Settings."

Export a function component `DailyDigestEmail(props: DigestData)` where:
```typescript
interface DigestData {
  userName: string;
  overdueTasksCount: number;
  overdueTasks: Array<{ title: string; dueDate: string; clientName: string; priority: string }>;
  renewalMilestones: Array<{ policyType: string; clientName: string; daysRemaining: number; expiryDate: string }>;
  dashboardUrl: string;
}
```

Style with inline CSS (email-safe). Use Anchor navy color (#1e3a5f or similar) for headers.

**NotificationsService (`apps/api/src/notifications/notifications.service.ts`):**

Inject `PrismaService` and `ConfigService`.

Initialize Resend client: `new Resend(this.configService.get('RESEND_API_KEY'))`.

Methods:

1. `sendDailyDigestForAllTenants()`:
   - Query all tenants.
   - For each tenant, query all users where `digestOptOut === false`.
   - For each user, gather their digest data (overdue tasks, renewal milestones).
   - If user has no overdue tasks AND no renewal milestones, skip (don't send empty digests).
   - Call `sendDigestToUser(user, data)`.

   CRITICAL: Use raw `this.prisma` (not tenantClient) -- cron job has no HTTP context.

2. `sendDigestToUser(user, data)`:
   - Use `render()` from `@react-email/render` to convert the DailyDigestEmail component to HTML.
   - Send via `this.resend.emails.send({ from: 'Anchor <notifications@anchor.app>', to: user.email, subject: ..., html })`.
   - Wrap in try/catch -- log errors but don't throw (one user's failure shouldn't block others).
   - Handle missing RESEND_API_KEY gracefully (log warning and skip).

3. `getDigestDataForUser(tenantId, userId)`:
   - Overdue tasks: tasks where tenantId matches, dueDate < today, status != 'done'. Include client relation.
   - Renewal milestones: tasks where tenantId matches, type = 'renewal', status = 'todo', dueDate within next **61 days** (NOT 7 days). This MUST cover all three renewal milestone intervals (60/30/7 days before policy expiry). Using 61 days ensures that the 60-day renewal task appears in the digest on its due date. Include policy and client relations.

   CRITICAL: The renewal milestone query window MUST be 61 days (or simply "all pending renewal tasks with dueDate >= today"), NOT 7 days. The user decision specifies 3 renewal tasks at 60/30/7 days before expiration. If the query only covers 7 days, the 60-day and 30-day renewal task emails would never be sent in the daily digest, violating NOTF-01.

   - Return DigestData object.

**NotificationsScheduler (`apps/api/src/notifications/notifications.scheduler.ts`):**

```typescript
@Cron('0 0 8 * * *', { name: 'daily-digest-email', timeZone: 'America/Toronto' })
async handleDailyDigest() {
  this.logger.log('Starting daily digest email send...');
  try {
    await this.notificationsService.sendDailyDigestForAllTenants();
    this.logger.log('Daily digest complete.');
  } catch (error) {
    this.logger.error('Daily digest failed', error);
  }
}
```

Runs at 8:00 AM Toronto time daily (per user decision: 8 AM local time, fixed for MVP).

**NotificationsModule:** Import PrismaModule. Provide NotificationsService, NotificationsScheduler.

**AppModule:** Add NotificationsModule to imports.

IMPORTANT: The `from` email address should use a domain configured in Resend. For development, Resend provides a sandbox domain. Use `configService.get('RESEND_FROM_EMAIL')` with fallback to `'Anchor <onboarding@resend.dev>'` for dev.
  </action>
  <verify>
Run `pnpm --filter api build` -- should compile cleanly INCLUDING the .tsx email template.
Verify the daily-digest.tsx file compiles (the "jsx": "react-jsx" in tsconfig should handle it).
If RESEND_API_KEY is set, can manually trigger the digest by calling the service method or hitting a test endpoint.
Verify the renewal milestone query uses a 61-day window (or all pending renewal tasks), NOT a 7-day window.
  </verify>
  <done>NotificationsModule sends daily digest at 8 AM Toronto time. Digest includes overdue tasks and upcoming renewal milestones across ALL intervals (60/30/7 days, queried with 61-day window). Empty digests are skipped. Users with digestOptOut=true are excluded. Email uses React Email template rendered to HTML via @react-email/render, sent via Resend SDK.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter api build` compiles cleanly (including .tsx email template)
2. All 5 dashboard endpoints return correct data shapes
3. Dashboard counts use manual tenantId (not relying on tenant extension for count/aggregate)
4. Premium income uses startDate (with createdAt fallback) not createdAt alone
5. Premium income trend calculation handles zero previous month gracefully
6. Notification scheduler registered with correct cron expression and timezone
7. Digest skips users with digestOptOut=true
8. Empty digests (no overdue tasks, no renewal milestones) are not sent
9. Renewal milestones in digest cover 61-day window (captures all 60/30/7 day tasks)
</verification>

<success_criteria>
- GET /dashboard/summary returns { overdueCount, dueTodayCount, renewalsIn30Days, activeClients }
- GET /dashboard/renewals returns policies with client info and daysRemaining
- GET /dashboard/overdue-tasks returns overdue tasks with client info
- GET /dashboard/recent-activity returns 10 most recent events
- GET /dashboard/premium-income returns { currentMonth, ytd, previousMonth, trendPercentage } based on startDate
- Daily digest email template compiles and renders to valid HTML
- Cron job scheduled at 8 AM America/Toronto
- digestOptOut respected, empty digests skipped
- Renewal milestones query covers all three intervals (60/30/7 days)
</success_criteria>

<output>
After completion, create `.planning/phases/03-tasks-renewals-and-dashboard/03-03-SUMMARY.md`
</output>
