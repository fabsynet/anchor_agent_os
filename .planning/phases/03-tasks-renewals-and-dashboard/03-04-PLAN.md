---
phase: 03-tasks-renewals-and-dashboard
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - apps/web/src/app/(dashboard)/tasks/page.tsx
  - apps/web/src/components/tasks/task-list.tsx
  - apps/web/src/components/tasks/task-table.tsx
  - apps/web/src/components/tasks/task-kanban.tsx
  - apps/web/src/components/tasks/kanban-column.tsx
  - apps/web/src/components/tasks/task-card.tsx
  - apps/web/src/components/tasks/task-form.tsx
  - apps/web/src/components/tasks/task-view-toggle.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a list of tasks in table view with sortable/filterable columns"
    - "User can see tasks in kanban board view grouped by status columns"
    - "User can toggle between table and kanban views"
    - "User can create a new task with title, description, due date, priority, status, assignee, linked client, linked policy"
    - "User can edit an existing manual task"
    - "User can drag a task card between kanban columns to change status"
    - "Renewal tasks are visually distinguishable from manual tasks"
    - "Renewal tasks cannot have content edited (only status changeable)"
    - "Assignee dropdown works for both admin and agent users"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/tasks/page.tsx"
      provides: "Tasks page with data fetching and routing"
    - path: "apps/web/src/components/tasks/task-list.tsx"
      provides: "Container managing view toggle, search, filters, data fetching, task state"
      min_lines: 80
    - path: "apps/web/src/components/tasks/task-table.tsx"
      provides: "Table view with @tanstack/react-table columns for status, priority, title, client, due date"
    - path: "apps/web/src/components/tasks/task-kanban.tsx"
      provides: "Kanban board with DndContext, 4 status columns, drag-and-drop between columns"
    - path: "apps/web/src/components/tasks/task-card.tsx"
      provides: "Task card used in kanban view showing title, priority badge, client, due date, type indicator"
    - path: "apps/web/src/components/tasks/task-form.tsx"
      provides: "Create/edit task form in a dialog with all fields"
  key_links:
    - from: "apps/web/src/components/tasks/task-list.tsx"
      to: "/tasks API endpoint"
      via: "api.get for fetching, api.post/patch/delete for mutations"
      pattern: "api\\.(get|post|patch|delete).*tasks"
    - from: "apps/web/src/components/tasks/task-kanban.tsx"
      to: "/tasks/:id API endpoint"
      via: "api.patch on drag end to update status"
      pattern: "api\\.patch.*tasks.*status"
    - from: "apps/web/src/components/tasks/task-form.tsx"
      to: "/tasks/assignees API endpoint"
      via: "api.get for assignee dropdown"
      pattern: "api\\.get.*tasks/assignees"
    - from: "apps/web/src/components/tasks/task-list.tsx"
      to: "apps/web/src/components/tasks/task-table.tsx"
      via: "conditional render based on view mode"
      pattern: "viewMode.*table.*TaskTable|viewMode.*kanban.*TaskKanban"
---

<objective>
Build the Task frontend: a /tasks page with list view (sortable/filterable table) and kanban board view with drag-and-drop, plus task create/edit forms. The view toggle follows the same UI pattern as the client list's table/card toggle per user decision.

Purpose: Users need a visual interface to manage tasks -- creating, filtering, status transitions, and the kanban board for workflow visualization.
Output: Complete /tasks page with table view, kanban view, task cards, and create/edit form dialog.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tasks-renewals-and-dashboard/03-CONTEXT.md
@.planning/phases/03-tasks-renewals-and-dashboard/03-RESEARCH.md
@.planning/phases/03-tasks-renewals-and-dashboard/03-01-SUMMARY.md
@.planning/phases/03-tasks-renewals-and-dashboard/03-02-SUMMARY.md
@apps/web/src/components/clients/client-list.tsx
@apps/web/src/components/clients/client-table.tsx
@apps/web/src/components/clients/view-toggle.tsx
@apps/web/src/lib/api.ts
@packages/shared/src/types/task.ts
@packages/shared/src/validation/task.schema.ts
@packages/shared/src/constants/tasks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Task list container, table view, and view toggle</name>
  <files>
    apps/web/src/app/(dashboard)/tasks/page.tsx
    apps/web/src/components/tasks/task-list.tsx
    apps/web/src/components/tasks/task-table.tsx
    apps/web/src/components/tasks/task-view-toggle.tsx
  </files>
  <action>
**Task View Toggle (`task-view-toggle.tsx`):**

Follow the existing `view-toggle.tsx` pattern but support two modes: "table" and "kanban" (per user decision: list view + kanban board toggle, similar pattern to client list's table/card toggle).

Use `List` and `Columns3` (or `LayoutGrid`) icons from lucide-react. Export `TaskViewMode = "table" | "kanban"`.

**Task List Container (`task-list.tsx`):**

"use client" component. This is the main orchestrator, similar to `client-list.tsx`.

State:
- `viewMode: TaskViewMode` (default "table", persist in localStorage)
- `tasks: TaskWithRelations[]`
- `loading: boolean`
- `searchQuery: string`
- `statusFilter: TaskStatus | 'all'`
- `priorityFilter: TaskPriority | 'all'`
- `typeFilter: TaskType | 'all'` (to filter manual vs renewal)
- `page/limit/total` for pagination
- `isFormOpen: boolean`, `editingTask: TaskWithRelations | null`

Fetch tasks from `api.get<{ data: TaskWithRelations[], total: number, page: number, limit: number, totalPages: number }>('/tasks', ...)` with query params built from filters.

Refetch whenever filters/page change (useEffect with deps).

Layout:
- Header row: "Tasks" title + "New Task" button (opens task form dialog)
- Filter bar: search input, status dropdown (using Select from shadcn), priority dropdown, type dropdown ("All", "Manual", "Renewal"), view toggle
- Content: conditionally render `<TaskTable>` or `<TaskKanban>` based on viewMode
- Pagination below content (match existing client list pagination pattern)

Pass to children: tasks array, loading state, onStatusChange callback, onEdit callback, onDelete callback.

Import types from `@anchor/shared`: `TaskWithRelations`, `TaskStatus`, `TaskPriority`, `TaskType`, `TASK_STATUSES`, `TASK_PRIORITIES`.

**Task Table (`task-table.tsx`):**

"use client" component using `@tanstack/react-table` (follow `client-table.tsx` pattern).

Columns:
1. **Status** -- colored badge (e.g., blue for To Do, yellow for In Progress, orange for Waiting, green for Done)
2. **Priority** -- icon + text (arrow-up for urgent/high, minus for medium, arrow-down for low). Urgent shows red.
3. **Title** -- text. If task.type === 'renewal', show a small "Renewal" tag/badge next to title (per TASK-06: auto-generated distinguishable from manual).
4. **Client** -- client name (linked to client profile) or "--" if no client
5. **Due Date** -- formatted date. If overdue (past date + not done), show in red text.
6. **Assignee** -- assignee name or "Unassigned"
7. **Actions** -- dropdown menu: Edit (disabled for renewal tasks), Delete, Mark as Done / Reopen

Use the same table styling as client-table.tsx. Click on a row could expand or open edit dialog.

**Tasks Page (`page.tsx`):**

Simple wrapper that renders `<TaskList />`. "use client" if needed, or keep as server component if TaskList handles everything client-side.

  </action>
  <verify>
Run `pnpm --filter web build` -- should compile with no errors.
Navigate to `/tasks` in browser:
- Table view loads with task data (or empty state)
- Filters work (status, priority, type dropdowns)
- Search input filters tasks
- Pagination works
- View toggle switches between table and kanban (kanban view implemented in Task 2)
- "New Task" button opens form (form implemented in Task 2)
  </verify>
  <done>Task list page renders with table view, search, filters (status/priority/type), pagination, and view toggle. Table shows status, priority, title (with renewal badge), client, due date, assignee, and actions. Overdue tasks highlighted in red.</done>
</task>

<task type="auto">
  <name>Task 2: Kanban board with drag-and-drop, task card, and task form dialog</name>
  <files>
    apps/web/src/components/tasks/task-kanban.tsx
    apps/web/src/components/tasks/kanban-column.tsx
    apps/web/src/components/tasks/task-card.tsx
    apps/web/src/components/tasks/task-form.tsx
  </files>
  <action>
**Task Card (`task-card.tsx`):**

"use client" component. Used in both kanban columns and potentially card view.

Card displays:
- Title (bold)
- Type indicator: if renewal, show a small colored badge "Renewal" (e.g., blue-ish). Manual tasks show no badge.
- Priority indicator: colored dot or icon (red for urgent, orange for high, yellow for medium, gray for low)
- Client name (if linked), shown as subtle text
- Due date with relative text ("Due in 3 days", "Overdue by 2 days"). Red text if overdue.
- Assignee avatar circle with initials (or "Unassigned" text)

Card should be compact but informative (Claude's discretion on density).

For kanban use, make the card draggable via @dnd-kit/sortable's `useSortable` hook. The card receives a `task` prop and renders within a `SortableContext`.

**Kanban Column (`kanban-column.tsx`):**

"use client" component. Each column represents a TaskStatus.

Props: `status`, `tasks`, `label`, `color` (for header accent).

Uses `useDroppable` from @dnd-kit/core to accept dropped items.
Contains `SortableContext` with `verticalListSortingStrategy` from @dnd-kit/sortable.
Renders header (status label + task count) and list of `<TaskCard>` components.

Column header colors (per status):
- To Do: slate/gray
- In Progress: blue
- Waiting: amber/orange
- Done: green

**Kanban Board (`task-kanban.tsx`):**

"use client" component. The main kanban container.

Uses `DndContext` from @dnd-kit/core with:
- `sensors`: `useSensors(useSensor(PointerSensor, { activationConstraint: { distance: 5 } }))` (5px drag threshold prevents accidental drags)
- `collisionDetection`: `closestCorners`
- `onDragStart`: set activeTask state (for DragOverlay)
- `onDragEnd`: determine target column, call `onStatusChange(taskId, newStatus)` prop
- `DragOverlay`: renders a `<TaskCard>` for the dragged item (prevents layout shift)

Four columns: To Do, In Progress, Waiting, Done.

Groups received `tasks` array by status and distributes to columns.

When drag ends on a different column, calls the parent's `onStatusChange(taskId, newStatus)` which triggers `api.patch('/tasks/${taskId}', { status: newStatus })` and refetches.

CRITICAL: ALL kanban-related components MUST have "use client" at the top (DndContext, useSensor, useSortable, useDroppable are React hooks -- server component error otherwise).

**Task Form (`task-form.tsx`):**

"use client" component. Dialog-based form for creating and editing tasks.

Uses `@hookform/resolvers/zod` with `createTaskSchema` from `@anchor/shared` (per Phase 2 pattern: use createSchema for both create and edit).

Fields (all in a Dialog from shadcn):
- Title (required text input)
- Description (optional textarea)
- Status (Select dropdown with TASK_STATUSES)
- Priority (Select dropdown with TASK_PRIORITIES)
- Due Date (date input -- use native `<input type="date">` or a simple date picker)
- Assignee (Select dropdown -- fetch team members from `GET /tasks/assignees` endpoint, NOT from `GET /users` which is admin-only. The `/tasks/assignees` endpoint returns `{ id, firstName, lastName }` for all tenant users without role restriction.)
- Client (Select dropdown or combobox -- fetch clients from `/clients` endpoint. When selected, also fetch that client's policies for the policy field)
- Policy (Select dropdown -- fetch policies for selected client from `/clients/:clientId/policies`. Disabled if no client selected)

CRITICAL: The assignee dropdown MUST use `api.get('/tasks/assignees')` and NOT `api.get('/users')`. The `/users` endpoint has `@Roles('admin')` guard and will return 403 for agent users. The `/tasks/assignees` endpoint was specifically created in Plan 03-02 to be accessible by any authenticated user.

For **edit mode** with renewal tasks (type === 'renewal'): disable title, description, dueDate, and priority fields. Only allow status changes. Show a notice: "This is an auto-generated renewal task. Only the status can be changed."

Form submission:
- Create: `api.post('/tasks', data)` then close dialog and refetch
- Edit: `api.patch('/tasks/${task.id}', data)` then close dialog and refetch

Strip empty strings to undefined before submission (per Phase 2 pattern to avoid sending empty strings for optional UUID fields).

  </action>
  <verify>
Run `pnpm --filter web build` -- should compile cleanly.
Test in browser:
1. Toggle to kanban view -- 4 columns render (To Do, In Progress, Waiting, Done)
2. Drag a task card from "To Do" to "In Progress" -- status updates
3. DragOverlay shows card while dragging
4. Click "New Task" -- form dialog opens with all fields
5. Assignee dropdown loads team members (verify as both admin AND agent user -- should work for both)
6. Create task with client + policy linked -- appears in task list
7. Edit a renewal task -- title/description/dueDate/priority fields disabled
8. Edit a manual task -- all fields editable
  </verify>
  <done>Kanban board renders 4 status columns with drag-and-drop between columns. Task cards show title, priority, client, due date, type badge. Task form dialog supports create and edit with client/policy linking, assignee selection via /tasks/assignees endpoint (accessible to all authenticated users, not admin-only). Renewal tasks enforce read-only content fields in edit mode.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` compiles cleanly
2. /tasks page loads with table view by default
3. View toggle switches between table and kanban
4. Table view: columns for status, priority, title, client, due date, assignee, actions
5. Kanban view: 4 columns, drag-and-drop status changes work
6. Task form: create and edit modes, all fields present
7. Assignee dropdown uses /tasks/assignees (works for admin AND agent users)
8. Renewal tasks: visually distinguished (badge), content fields read-only in edit
9. Filters: search, status, priority, type all work
10. Pagination works in table view
</verification>

<success_criteria>
- /tasks page accessible from sidebar navigation
- Table view shows sortable/filterable task list with all required columns
- Kanban view shows 4 status columns with draggable task cards
- Drag-and-drop changes task status via API call
- Task form creates and edits tasks with all specified fields
- Assignee dropdown fetches from /tasks/assignees (not /users) -- works for all roles
- Renewal tasks visually distinguished (TASK-06) and content non-editable
- Client/policy linking works in task form
- Overdue tasks highlighted in both views
</success_criteria>

<output>
After completion, create `.planning/phases/03-tasks-renewals-and-dashboard/03-04-SUMMARY.md`
</output>
