---
phase: 06-trust-and-reputation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - apps/api/src/badge/badge.module.ts
  - apps/api/src/badge/badge.service.ts
  - apps/api/src/badge/badge.controller.ts
  - apps/api/src/badge/badge-public.controller.ts
  - apps/api/src/badge/dto/create-profile.dto.ts
  - apps/api/src/badge/dto/update-profile.dto.ts
  - apps/api/src/badge/dto/submit-testimonial.dto.ts
  - apps/api/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated agent can create and update their badge profile via API"
    - "Authenticated agent can list and toggle visibility/featured on their testimonials"
    - "Public visitor can fetch an agent's badge profile by slug without authentication"
    - "Public visitor can submit a testimonial by slug without authentication"
    - "Agent receives in-app notification when a new testimonial is submitted"
    - "Max 2 featured testimonials enforced server-side"
    - "Rate limit: max 1 testimonial per email per agent per 24 hours"
  artifacts:
    - path: "apps/api/src/badge/badge.module.ts"
      provides: "Badge NestJS module registering controllers, service, and imports"
      exports: ["BadgeModule"]
    - path: "apps/api/src/badge/badge.service.ts"
      provides: "All badge business logic - profile CRUD, testimonial submission, curation, image upload"
      exports: ["BadgeService"]
    - path: "apps/api/src/badge/badge.controller.ts"
      provides: "Authenticated endpoints for agent to manage profile and testimonials"
      exports: ["BadgeController"]
    - path: "apps/api/src/badge/badge-public.controller.ts"
      provides: "Public endpoints for badge page view and testimonial submission"
      exports: ["BadgePublicController"]
  key_links:
    - from: "apps/api/src/badge/badge.service.ts"
      to: "prisma.agentProfile"
      via: "Prisma queries for profile CRUD"
      pattern: "prisma\\.agentProfile\\.(create|findUnique|update)"
    - from: "apps/api/src/badge/badge.service.ts"
      to: "apps/api/src/alerts/alerts.service.ts"
      via: "AlertsService.create() for new testimonial notification"
      pattern: "alertsService\\.create"
    - from: "apps/api/src/badge/badge-public.controller.ts"
      to: "apps/api/src/badge/badge.service.ts"
      via: "Direct service calls without JwtAuthGuard"
      pattern: "badgeService\\.(getPublicProfile|submitTestimonial)"
    - from: "apps/api/src/app.module.ts"
      to: "apps/api/src/badge/badge.module.ts"
      via: "Module import registration"
      pattern: "BadgeModule"
---

<objective>
Create the NestJS backend badge module with both authenticated (agent profile management, testimonial curation) and public (badge page data, testimonial submission) endpoints. Includes image upload for cover photos via Supabase Storage, notification on testimonial submission, slug generation, and rate limiting.

Purpose: Provides the API layer that both the public pages and the management UI will consume.
Output: Complete badge API with ~12 endpoints covering profile CRUD, testimonial submission, testimonial curation, and image upload.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-trust-and-reputation/06-CONTEXT.md
@.planning/phases/06-trust-and-reputation/06-RESEARCH.md
@.planning/phases/06-trust-and-reputation/06-01-SUMMARY.md
@apps/api/src/app.module.ts
@apps/api/src/alerts/alerts.service.ts
@apps/api/src/alerts/alerts.module.ts
@apps/api/src/documents/documents.service.ts
@apps/api/src/auth/guards/jwt-auth.guard.ts
@packages/shared/src/constants/badge.ts
@packages/shared/src/validation/badge.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Badge Service with profile CRUD, slug generation, testimonial submission, curation, and image upload</name>
  <files>
    apps/api/src/badge/badge.service.ts
    apps/api/src/badge/dto/create-profile.dto.ts
    apps/api/src/badge/dto/update-profile.dto.ts
    apps/api/src/badge/dto/submit-testimonial.dto.ts
  </files>
  <action>
**Create DTOs first:**

`create-profile.dto.ts`: class-validator DTO for initial profile creation. Fields: licenseNumber?, bio?, phone?, email?, website?, linkedIn?, twitter?, facebook?, instagram?, whatsApp?, productsOffered? (string[]), customLinks? (array of {label, url}), accentColor?, isPublished?. All optional except none -- the profile is created with defaults and the agent fills it in.

`update-profile.dto.ts`: class-validator DTO mirroring the Zod updateAgentProfileSchema. All fields optional. Use @IsOptional(), @IsString(), @IsEmail(), @IsUrl(), @IsBoolean(), @IsArray(), @Matches() for accentColor hex pattern, @MaxLength() for text limits.

`submit-testimonial.dto.ts`: class-validator DTO mirroring submitTestimonialSchema. Fields: authorName (required, @IsString, @MinLength(1), @MaxLength(100)), authorEmail? (@IsEmail, @IsOptional), isAnonymous (@IsBoolean, @IsOptional with default false), rating (@IsInt, @Min(1), @Max(5)), content (@IsString, @MinLength(10), @MaxLength(2000)), strengths (@IsArray, @ArrayMinSize(1), @ArrayMaxSize(5)).

**Create `badge.service.ts`:**

Inject: `PrismaService`, `AlertsService`, `ConfigService`

Create a Supabase admin client in the constructor (same pattern as documents.service.ts -- using SUPABASE_URL + SUPABASE_SERVICE_ROLE_KEY from ConfigService). Auto-create `badge-assets` bucket as PUBLIC on startup (same pattern as documents bucket creation but with `{ public: true }`).

**Profile methods:**

1. `getMyProfile(userId: string, tenantId: string)`: Find AgentProfile by userId. If not found, auto-create one with a generated slug (from User's firstName + lastName). Return the profile.

2. `updateProfile(userId: string, tenantId: string, dto: UpdateProfileDto)`: Update AgentProfile fields. If profile doesn't exist, create it first (same auto-create logic). Return updated profile.

3. `generateSlug(firstName: string, lastName: string)`: Generate URL-safe slug: lowercase, replace non-alphanumeric with hyphens, trim hyphens, limit to 50 chars. Call `ensureUniqueSlug()` to handle conflicts.

4. `ensureUniqueSlug(baseSlug: string, excludeProfileId?: string)`: Check for existing profile with same slug (excluding current profile if editing). If conflict, append -1, -2, etc. until unique.

5. `uploadCoverPhoto(userId: string, tenantId: string, file: { originalname, mimetype, size, buffer })`: Validate file type (jpeg/png/webp) and size (<=5MB). Upload to Supabase Storage `badge-assets` bucket at path `${tenantId}/${userId}/cover-${uuid}.${ext}`. Delete old cover photo if exists. Update AgentProfile.coverPhotoPath. Return the public URL.

6. `getPublicUrl(storagePath: string)`: Use Supabase's `getPublicUrl()` to get the direct URL for a badge-assets file. The bucket is public so no signed URLs needed.

**Testimonial methods:**

7. `submitTestimonial(slug: string, dto: SubmitTestimonialDto)`: Find AgentProfile by slug (use raw `this.prisma` NOT tenantClient -- public endpoint has no CLS context). Validate rate limit: if authorEmail provided, check if a testimonial from this email for this profile exists within last 24 hours -- if so, throw BadRequestException. Create testimonial with isVisible: true (auto-approved per user decision). Send in-app notification via AlertsService: type 'new_testimonial', title 'New Testimonial Received', message includes author name (or 'Someone' if anonymous) and star rating. Return created testimonial.

8. `getPublicProfile(slug: string)`: Find AgentProfile by slug with relations: user (select firstName, lastName, avatarUrl), tenant (select name). Include testimonials where isVisible=true, ordered by isFeatured DESC then createdAt DESC. Only return if isPublished=true, otherwise throw NotFoundException. Shape the response as PublicBadgeProfile type.

9. `getMyTestimonials(userId: string, tenantId: string)`: Find all testimonials for the agent's profile (both visible and hidden), ordered by createdAt DESC. Return with count.

10. `toggleTestimonialVisibility(userId: string, tenantId: string, testimonialId: string)`: Find testimonial, verify it belongs to the agent's profile. Toggle isVisible. If hiding a featured testimonial, also set isFeatured=false. Return updated testimonial.

11. `toggleTestimonialFeatured(userId: string, tenantId: string, testimonialId: string)`: Find testimonial, verify ownership. If setting isFeatured=true, count current featured -- if already MAX_FEATURED_TESTIMONIALS (2), auto-unfeature the oldest featured one (by createdAt). Also ensure testimonial isVisible=true before featuring (can't feature a hidden one). Toggle isFeatured. Return updated testimonial.

12. `deleteTestimonial(userId: string, tenantId: string, testimonialId: string)`: Find testimonial, verify ownership, delete it.

**CRITICAL NOTES:**
- Public methods (submitTestimonial, getPublicProfile) use raw `this.prisma` -- NOT tenantClient. No CLS tenant context exists for public endpoints.
- Authenticated methods use raw `this.prisma` too for simplicity (with explicit tenantId in where clauses) -- the pattern used in cron services and compliance.
- AlertsService.create() needs tenantId and userId from the AgentProfile record (looked up by slug).
- Import MAX_FEATURED_TESTIMONIALS from @anchor/shared constants.
  </action>
  <verify>
The service file should compile: `pnpm --filter api exec tsc --noEmit` (or check via build).
Verify AlertsService is properly imported and used.
Verify all 12 methods exist with correct signatures.
  </verify>
  <done>BadgeService has complete business logic for profile CRUD (with auto-create and slug generation), cover photo upload to Supabase Storage (public bucket), testimonial submission (with rate limiting and notification), and testimonial curation (visibility toggle, featured toggle with max 2 enforcement, delete).</done>
</task>

<task type="auto">
  <name>Task 2: Badge controllers (authenticated + public) and module registration</name>
  <files>
    apps/api/src/badge/badge.controller.ts
    apps/api/src/badge/badge-public.controller.ts
    apps/api/src/badge/badge.module.ts
    apps/api/src/app.module.ts
  </files>
  <action>
**Create `badge.controller.ts` (Authenticated):**

Use `@UseGuards(JwtAuthGuard)` at the class level. Controller route prefix: `badge`.

Endpoints:
1. `GET /api/badge/profile` -- Get authenticated agent's own profile. Calls `badgeService.getMyProfile(user.id, user.tenant_id)`. Returns profile data.

2. `PATCH /api/badge/profile` -- Update agent's profile. Accepts UpdateProfileDto body. Calls `badgeService.updateProfile(user.id, user.tenant_id, dto)`.

3. `POST /api/badge/profile/cover-photo` -- Upload cover photo. Use `@UseInterceptors(FileInterceptor('file'))` with multer. Validate file exists. Calls `badgeService.uploadCoverPhoto(user.id, user.tenant_id, file)`. Return { url: string, path: string }.

4. `GET /api/badge/testimonials` -- List all testimonials for the agent (visible + hidden). Calls `badgeService.getMyTestimonials(user.id, user.tenant_id)`.

5. `PATCH /api/badge/testimonials/:id/visibility` -- Toggle testimonial visibility. Calls `badgeService.toggleTestimonialVisibility(user.id, user.tenant_id, id)`.

6. `PATCH /api/badge/testimonials/:id/featured` -- Toggle testimonial featured status. Calls `badgeService.toggleTestimonialFeatured(user.id, user.tenant_id, id)`.

7. `DELETE /api/badge/testimonials/:id` -- Delete a testimonial. Calls `badgeService.deleteTestimonial(user.id, user.tenant_id, id)`.

Extract user from request using `@Req() req` and cast `req.user` as `AuthenticatedUser` (same pattern as other controllers -- import from jwt-auth.guard.ts).

**Create `badge-public.controller.ts` (Public -- NO auth guard):**

NO `@UseGuards(JwtAuthGuard)` -- this is the critical difference. Controller route prefix: `public/badge`.

Endpoints:
1. `GET /api/public/badge/:slug` -- Get public badge profile for display. Calls `badgeService.getPublicProfile(slug)`. Returns PublicBadgeProfile shape.

2. `POST /api/public/badge/:slug/testimonials` -- Submit a testimonial. Accepts SubmitTestimonialDto body. Calls `badgeService.submitTestimonial(slug, dto)`. Returns 201 with created testimonial (minus authorEmail for privacy).

**Create `badge.module.ts`:**

```typescript
@Module({
  imports: [AlertsModule],
  controllers: [BadgeController, BadgePublicController],
  providers: [BadgeService],
  exports: [BadgeService],
})
export class BadgeModule {}
```

Import AlertsModule so AlertsService is available for injection. The PrismaService is globally available via PrismaModule (already global in app.module.ts). ConfigModule is also global.

**Update `app.module.ts`:**

Add `BadgeModule` to the imports array. Add the import statement at the top:
```typescript
import { BadgeModule } from './badge/badge.module.js';
```

**CRITICAL:**
- badge-public.controller.ts must NOT have @UseGuards at class or method level
- badge.controller.ts MUST have @UseGuards(JwtAuthGuard) at class level
- Use @Param('slug') for slug-based routes, @Param('id') for testimonial ID routes
- FileInterceptor for cover photo upload (same pattern as documents controller)
- Return 201 for testimonial submission (@HttpCode(201) or default POST behavior)
  </action>
  <verify>
Run `pnpm --filter api build` -- should compile successfully.
Test endpoints manually or via curl:
- `curl http://localhost:3001/api/public/badge/test-slug` should return 404 (no profile yet) -- proves the public route is accessible without auth.
- `curl -X GET http://localhost:3001/api/badge/profile` without auth header should return 401 -- proves authenticated routes are protected.
  </verify>
  <done>Badge module is registered in AppModule. Authenticated controller has 7 endpoints for profile management and testimonial curation. Public controller has 2 endpoints for badge page view and testimonial submission. Public endpoints are accessible without authentication. Cover photo upload uses Supabase Storage. New testimonial submissions trigger in-app notifications.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter api build` compiles without errors
2. Public endpoint `/api/public/badge/:slug` is accessible without JWT
3. Authenticated endpoints require JWT (401 without token)
4. AlertsService is properly wired for testimonial notifications
5. BadgeModule appears in AppModule imports
</verification>

<success_criteria>
- Badge API has 9 total endpoints (7 authenticated, 2 public)
- Profile auto-creates with slug on first access
- Cover photo uploads to public badge-assets Supabase Storage bucket
- Testimonial submission creates record + sends in-app notification
- Rate limiting: 1 testimonial per email per agent per 24h
- Featured toggle enforces max 2 (auto-unfeatures oldest)
- Visibility toggle: hiding a featured testimonial also unfeatures it
- Public profile only returned if isPublished=true
- No CLS tenant context used in public service methods
</success_criteria>

<output>
After completion, create `.planning/phases/06-trust-and-reputation/06-02-SUMMARY.md`
</output>
