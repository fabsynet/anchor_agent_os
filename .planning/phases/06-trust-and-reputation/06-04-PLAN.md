---
phase: 06-trust-and-reputation
plan: 04
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - apps/web/src/app/(dashboard)/settings/badge/page.tsx
  - apps/web/src/app/(dashboard)/settings/page.tsx
  - apps/web/src/components/badge/profile-editor.tsx
  - apps/web/src/components/badge/testimonial-manager.tsx
  - apps/web/src/components/badge/cover-photo-upload.tsx
  - packages/shared/src/constants/roles.ts
autonomous: true

must_haves:
  truths:
    - "Agent can access Settings > Badge page to manage their public profile"
    - "Agent can edit profile fields: license, bio, phone, email, social links, products, custom links, accent color"
    - "Agent can upload a cover photo for their badge page"
    - "Agent can toggle isPublished to make their badge page live"
    - "Agent can see their shareable testimonial link and copy it"
    - "Agent can see all testimonials (visible + hidden) and toggle visibility"
    - "Agent can pin up to 2 testimonials as featured"
    - "Agent can delete testimonials"
    - "Settings nav shows Badge tab alongside existing Team/Profile tabs"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/settings/badge/page.tsx"
      provides: "Badge management page under settings"
    - path: "apps/web/src/components/badge/profile-editor.tsx"
      provides: "Form for editing agent badge profile"
    - path: "apps/web/src/components/badge/testimonial-manager.tsx"
      provides: "List of testimonials with visibility/featured/delete controls"
    - path: "apps/web/src/components/badge/cover-photo-upload.tsx"
      provides: "Cover photo upload and preview component"
    - path: "packages/shared/src/constants/roles.ts"
      provides: "Updated NAV_ITEMS or settings sub-nav for badge"
  key_links:
    - from: "apps/web/src/components/badge/profile-editor.tsx"
      to: "/api/badge/profile"
      via: "Authenticated api.ts PATCH request"
      pattern: "api\\.(patch|put).*badge/profile"
    - from: "apps/web/src/components/badge/testimonial-manager.tsx"
      to: "/api/badge/testimonials"
      via: "Authenticated api.ts GET/PATCH/DELETE requests"
      pattern: "api\\.(get|patch|delete).*badge/testimonials"
    - from: "apps/web/src/components/badge/cover-photo-upload.tsx"
      to: "/api/badge/profile/cover-photo"
      via: "Authenticated file upload via FormData"
      pattern: "badge/profile/cover-photo"
    - from: "apps/web/src/app/(dashboard)/settings/badge/page.tsx"
      to: "apps/web/src/components/badge/profile-editor.tsx"
      via: "Component composition"
      pattern: "ProfileEditor"
---

<objective>
Create the agent-facing badge management UI under Settings > Badge. Agents can edit their public profile, upload cover photos, manage testimonials (show/hide/feature/delete), copy their testimonial link, and publish/unpublish their badge page.

Purpose: This is the agent's control panel for their public reputation -- where they configure what appears on their badge page and curate testimonials.
Output: Complete settings page with profile editor, cover photo upload, testimonial manager, and link sharing.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-trust-and-reputation/06-CONTEXT.md
@.planning/phases/06-trust-and-reputation/06-RESEARCH.md
@.planning/phases/06-trust-and-reputation/06-01-SUMMARY.md
@.planning/phases/06-trust-and-reputation/06-02-SUMMARY.md
@apps/web/src/app/(dashboard)/settings/page.tsx
@apps/web/src/lib/api.ts
@packages/shared/src/constants/roles.ts
@packages/shared/src/constants/badge.ts
@packages/shared/src/validation/badge.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Profile editor, cover photo upload, and settings page</name>
  <files>
    apps/web/src/app/(dashboard)/settings/badge/page.tsx
    apps/web/src/app/(dashboard)/settings/page.tsx
    apps/web/src/components/badge/profile-editor.tsx
    apps/web/src/components/badge/cover-photo-upload.tsx
  </files>
  <action>
**Create `cover-photo-upload.tsx`:**

'use client' component. Props: currentPhotoPath (string|null), onUpload (callback returning new path). Shows:
- Current cover photo preview if exists (image with object-cover, aspect-ratio 3:1). Construct public URL: `${NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/badge-assets/${currentPhotoPath}`.
- Placeholder gradient if no photo
- "Upload Cover Photo" button or "Change" button if photo exists
- Hidden file input (accept: image/jpeg, image/png, image/webp)
- On file select: validate size <=5MB and type (from COVER_PHOTO_ALLOWED_TYPES), then upload via authenticated api.ts POST to `/badge/profile/cover-photo` as FormData. Show loading spinner during upload. Call onUpload with new path on success. Show error toast via sonner on failure.
- "Remove" button if photo exists (PATCH profile with coverPhotoPath: null)

**Create `profile-editor.tsx`:**

'use client' component. Uses react-hook-form + zodResolver with updateAgentProfileSchema from @anchor/shared.

On mount: fetch current profile from `/api/badge/profile` via authenticated api.ts GET. Populate form with existing values using form.reset().

Form sections (use shadcn/ui Card for each section):

1. **Publish Status** (at top):
   - Toggle switch for isPublished with descriptive label
   - When published: show the public badge URL as a clickable link (`/agent/${slug}`)
   - "Preview" button that opens badge page in new tab

2. **Professional Info:**
   - License Number (text input)
   - Bio (textarea, max 500 chars, with character count)
   - Public Email (email input, helper: "Displayed on your badge page")
   - Phone (text input)

3. **Social Links:**
   - Website (URL input)
   - LinkedIn (URL input)
   - Twitter / X (URL input)
   - Facebook (URL input)
   - Instagram (URL input)
   - WhatsApp (text input, phone number)
   - Each with appropriate icon from lucide-react

4. **Products Offered:**
   - Multi-select using INSURANCE_PRODUCTS constant
   - Render as a grid of toggleable badge-style buttons (click to select/deselect)
   - Selected products highlighted with accent background

5. **Custom Links:** (max 5)
   - Dynamic field array (useFieldArray from react-hook-form)
   - Each row: Label (text input) + URL (url input) + Remove button
   - "Add Link" button (disabled if 5 links already)

6. **Accent Color:**
   - Grid of ACCENT_COLOR_PRESETS as clickable color circles
   - Selected color has a check icon or ring indicator
   - Current accent color preview strip

7. **Cover Photo:**
   - CoverPhotoUpload component

Save button at bottom. On submit: PATCH `/api/badge/profile` via authenticated api.ts. Show success toast on save. Show validation errors inline.

**Create settings/badge/page.tsx:**

'use client' page that renders the ProfileEditor at the top and TestimonialManager below (Task 2). Include:
- Page title: "Badge & Testimonials"
- Two-section layout: profile editing section and testimonials management section
- The testimonial link sharing section between them

For the testimonial link section:
- Display the shareable link: `${window.location.origin}/testimonial/${slug}`
- "Copy Link" button that copies to clipboard and shows "Copied!" toast
- Brief instruction text: "Share this link with clients to collect testimonials"

**Update settings/page.tsx:**

Currently redirects to /settings/team. Keep that behavior but also add sub-navigation. The settings section needs tabs: Team | Profile | Badge. Check if sub-navigation already exists in the settings layout or pages.

If no sub-nav exists yet: Add a simple tab bar / link navigation at the top of the settings pages. Create a shared settings sub-nav component or add tabs directly:
- Team: `/settings/team` (existing)
- Profile: `/settings/profile` (existing)
- Badge: `/settings/badge` (new)

The badge tab should be available to ALL roles (not admin-only). Every agent should be able to create their badge page.

If a settings layout with sub-nav already exists, just add the Badge tab to it. If not, create a minimal sub-nav component rendered in each settings sub-page.
  </action>
  <verify>
1. Navigate to `/settings/badge` -- page loads with profile editor form
2. Fill in profile fields and save -- PATCH request succeeds, fields persist on reload
3. Upload cover photo -- file appears in Supabase Storage, preview updates
4. Select products -- toggleable badges work
5. Add/remove custom links -- field array works
6. Select accent color -- color circle highlights
7. Toggle isPublished -- status updates
8. Settings sub-nav shows Team, Profile, Badge tabs
  </verify>
  <done>Settings > Badge page renders profile editor with all fields (professional info, social links, products, custom links, accent color, cover photo). Form loads existing data, saves via API, and shows appropriate feedback. Settings sub-nav includes Badge tab.</done>
</task>

<task type="auto">
  <name>Task 2: Testimonial manager with curation controls and link sharing</name>
  <files>
    apps/web/src/components/badge/testimonial-manager.tsx
  </files>
  <action>
**Create `testimonial-manager.tsx`:**

'use client' component. Props: slug (string).

On mount: fetch all testimonials from `/api/badge/testimonials` via authenticated api.ts GET.

Layout:
- Section heading: "Testimonials" with count badge
- If no testimonials: empty state with illustration/icon and text "No testimonials yet. Share your link to start collecting reviews!"

For each testimonial, render a card showing:
1. **Header row:** Author name (or "Anonymous"), star rating (readonly), relative date
2. **Content:** Testimonial text (truncated to ~3 lines with "Show more" expand)
3. **Strengths:** StrengthBadges component
4. **Action buttons row:**
   - **Visibility toggle:** Eye/EyeOff icon button. If visible: eye icon, tooltip "Hide from badge page". If hidden: eye-off icon with muted card styling, tooltip "Show on badge page". Calls PATCH `/api/badge/testimonials/${id}/visibility`.
   - **Featured toggle:** Star/StarOff icon button. If featured: filled star icon with gold color, tooltip "Remove from featured". If not featured: outline star, tooltip "Feature on badge page". Calls PATCH `/api/badge/testimonials/${id}/featured`. If max featured (2) reached and trying to feature another, show info toast: "Maximum 2 featured testimonials. The oldest featured was unfeatured."
   - **Delete button:** Trash icon, red. Shows confirmation dialog (shadcn AlertDialog): "Delete this testimonial? This action cannot be undone." On confirm: DELETE `/api/badge/testimonials/${id}`.
5. **Status badges:** Small labels showing "Featured" (gold), "Hidden" (gray) as applicable

Cards should be ordered: featured first, then by createdAt DESC.

After any action (toggle visibility, toggle featured, delete), refetch the testimonials list to get updated state.

Loading state: skeleton cards while fetching.

**Integration with settings/badge/page.tsx:**
The TestimonialManager is rendered on the badge settings page (created in Task 1) below the profile editor. Pass the agent's slug as a prop (obtained from the profile fetch).
  </action>
  <verify>
1. Testimonial manager lists all testimonials (visible + hidden)
2. Clicking eye icon toggles visibility -- card styling changes (muted when hidden)
3. Clicking star icon toggles featured -- badge appears/disappears
4. Featuring a 3rd testimonial auto-unfeatures the oldest -- info toast appears
5. Delete button shows confirmation dialog -- confirming deletes the testimonial
6. Empty state shows when no testimonials exist
7. After each action, list refreshes to show updated state
  </verify>
  <done>Testimonial manager displays all testimonials with visibility toggle (eye icon), featured toggle (star icon, max 2 enforced), and delete with confirmation. Cards show author, rating, content, strengths, and status badges. Empty state and loading skeleton work correctly.</done>
</task>

</tasks>

<verification>
1. `/settings/badge` page loads and shows profile editor + testimonial manager
2. Profile editor loads existing data, saves changes, shows success feedback
3. Cover photo uploads to Supabase Storage and previews correctly
4. Testimonial link section displays correct URL and copy-to-clipboard works
5. Testimonial curation (show/hide/feature/delete) all function correctly
6. Settings sub-nav includes Badge alongside Team and Profile
7. `pnpm --filter web build` succeeds
</verification>

<success_criteria>
- Settings > Badge page is accessible to all authenticated users (not admin-only)
- Profile editor covers: license, bio, phone, email, social links (6), products offered, custom links (max 5), accent color, cover photo, isPublished toggle
- Cover photo uploads to badge-assets public bucket
- Shareable testimonial link displayed and copyable
- Testimonial manager shows all testimonials with curation controls
- Visibility toggle hides/shows testimonials on badge page (also unfeatures if hiding featured)
- Featured toggle pins up to 2 (auto-unfeatures oldest on overflow)
- Delete has confirmation dialog
- Settings sub-navigation includes Badge tab
</success_criteria>

<output>
After completion, create `.planning/phases/06-trust-and-reputation/06-04-SUMMARY.md`
</output>
