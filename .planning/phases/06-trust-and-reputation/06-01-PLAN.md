---
phase: 06-trust-and-reputation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - packages/shared/src/types/badge.ts
  - packages/shared/src/validation/badge.schema.ts
  - packages/shared/src/constants/badge.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "AgentProfile and Testimonial models exist in the database after prisma db push"
    - "Shared types, Zod schemas, and constants are importable from @anchor/shared"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "AgentProfile and Testimonial models with all fields per CONTEXT.md decisions"
      contains: "model AgentProfile"
    - path: "packages/shared/src/types/badge.ts"
      provides: "AgentProfile, Testimonial, PublicBadgeProfile types"
      exports: ["AgentProfile", "Testimonial", "PublicBadgeProfile"]
    - path: "packages/shared/src/validation/badge.schema.ts"
      provides: "Zod schemas for testimonial submission and profile update"
      exports: ["submitTestimonialSchema", "updateAgentProfileSchema"]
    - path: "packages/shared/src/constants/badge.ts"
      provides: "Strength categories, insurance products, accent colors, max featured count"
      exports: ["STRENGTH_CATEGORIES", "INSURANCE_PRODUCTS", "ACCENT_COLOR_PRESETS", "MAX_FEATURED_TESTIMONIALS"]
    - path: "packages/shared/src/index.ts"
      provides: "Re-exports all badge types, schemas, and constants"
  key_links:
    - from: "packages/shared/src/index.ts"
      to: "packages/shared/src/types/badge.ts"
      via: "export statement"
      pattern: "export.*from.*types/badge"
    - from: "packages/shared/src/index.ts"
      to: "packages/shared/src/validation/badge.schema.ts"
      via: "export statement"
      pattern: "export.*from.*validation/badge.schema"
---

<objective>
Create the data foundation for Phase 6: Trust & Reputation. Add AgentProfile and Testimonial models to the Prisma schema, create shared types, Zod validation schemas, and constants for badge/testimonial features.

Purpose: All subsequent plans (backend module, public pages, management UI) depend on these models and shared types existing first.
Output: Updated Prisma schema pushed to DB, shared package with badge types/schemas/constants.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-trust-and-reputation/06-CONTEXT.md
@.planning/phases/06-trust-and-reputation/06-RESEARCH.md
@packages/database/prisma/schema.prisma
@packages/shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma Schema - AgentProfile and Testimonial models</name>
  <files>packages/database/prisma/schema.prisma</files>
  <action>
Add two new models to the end of schema.prisma (before any closing content):

**AgentProfile model:**
- id: UUID PK with @default(uuid())
- userId: String @unique @map("user_id") @db.Uuid (1:1 with User)
- tenantId: String @map("tenant_id") @db.Uuid
- slug: String @unique (globally unique vanity URL slug)
- licenseNumber: String? @map("license_number")
- bio: String?
- phone: String?
- email: String? (public contact email, may differ from auth email)
- website: String?
- linkedIn: String? @map("linkedin")
- twitter: String?
- facebook: String?
- instagram: String?
- whatsApp: String? @map("whatsapp")
- productsOffered: String[] @map("products_offered") (array of insurance product values)
- customLinks: Json? @map("custom_links") @default("[]") (array of {label, url} objects)
- coverPhotoPath: String? @map("cover_photo_path") (Supabase Storage path)
- accentColor: String? @map("accent_color") @default("#0f172a")
- isPublished: Boolean @default(false) @map("is_published")
- createdAt: DateTime @default(now()) @map("created_at")
- updatedAt: DateTime @updatedAt @map("updated_at")
- Relations: user (User), tenant (Tenant), testimonials (Testimonial[])
- Indexes: @@index([tenantId]), @@index([slug])
- @@map("agent_profiles")

**Testimonial model:**
- id: UUID PK with @default(uuid())
- agentProfileId: String @map("agent_profile_id") @db.Uuid
- authorName: String @map("author_name")
- authorEmail: String? @map("author_email") (for rate limiting, not displayed publicly)
- isAnonymous: Boolean @default(false) @map("is_anonymous")
- rating: Int (1-5)
- content: String
- strengths: String[] (array of strength category values)
- isVisible: Boolean @default(true) @map("is_visible") (auto-approved per user decision)
- isFeatured: Boolean @default(false) @map("is_featured") (manual pin, max 2)
- createdAt: DateTime @default(now()) @map("created_at")
- Relations: agentProfile (AgentProfile, onDelete: Cascade)
- Indexes: @@index([agentProfileId, isVisible, createdAt(sort: Desc)]), @@index([agentProfileId, isFeatured])
- @@map("testimonials")

**Also update existing models with back-relations:**
- On the User model, add: `agentProfile AgentProfile?`
- On the Tenant model, add: `agentProfiles AgentProfile[]`

After editing schema, run:
1. `pnpm --filter database exec prisma db push` to push schema to Supabase
2. `pnpm --filter database exec prisma generate` to regenerate Prisma client

IMPORTANT: The `prisma db push` is used (not migrate) per project decision -- shadow DB fails on Supabase auth.users trigger.
  </action>
  <verify>
Run `pnpm --filter database exec prisma db push` -- should succeed with no errors.
Run `pnpm --filter database exec prisma generate` -- should succeed.
Verify models exist: `pnpm --filter database exec prisma studio` or check that `@prisma/client` exports AgentProfile and Testimonial types (build the database package).
  </verify>
  <done>AgentProfile and Testimonial tables exist in Supabase PostgreSQL. Prisma client is regenerated with new model accessors (.agentProfile, .testimonial).</done>
</task>

<task type="auto">
  <name>Task 2: Shared Package - Badge types, Zod schemas, and constants</name>
  <files>
    packages/shared/src/types/badge.ts
    packages/shared/src/validation/badge.schema.ts
    packages/shared/src/constants/badge.ts
    packages/shared/src/index.ts
  </files>
  <action>
**Create `packages/shared/src/types/badge.ts`:**

Define TypeScript types matching the Prisma models:
- `AgentProfile` type with all fields from the model (use string for dates, string for id/uuid fields -- matching existing type patterns in the shared package)
- `Testimonial` type with all fields
- `PublicBadgeProfile` type -- the shape returned by the public badge API endpoint. Includes: agent's full name (from User), agency name (from Tenant), all AgentProfile fields, and `testimonials: Testimonial[]` (only visible ones). Also include `avatarUrl` from User.
- `CustomLink` type: `{ label: string; url: string }`
- `TestimonialWithProfile` type: Testimonial with nested agentProfile (for admin listing)

**Create `packages/shared/src/constants/badge.ts`:**

```typescript
export const STRENGTH_CATEGORIES = [
  { value: 'responsiveness', label: 'Responsiveness' },
  { value: 'knowledge', label: 'Knowledge & Expertise' },
  { value: 'trustworthiness', label: 'Trustworthiness' },
  { value: 'communication', label: 'Communication' },
  { value: 'professionalism', label: 'Professionalism' },
  { value: 'claims_support', label: 'Claims Support' },
  { value: 'value', label: 'Value for Money' },
  { value: 'availability', label: 'Availability' },
] as const;

export type StrengthCategory = typeof STRENGTH_CATEGORIES[number]['value'];

export const INSURANCE_PRODUCTS = [
  { value: 'auto', label: 'Auto Insurance' },
  { value: 'home', label: 'Home Insurance' },
  { value: 'life', label: 'Life Insurance' },
  { value: 'health', label: 'Health & Dental' },
  { value: 'commercial', label: 'Commercial Insurance' },
  { value: 'travel', label: 'Travel Insurance' },
  { value: 'tenant', label: 'Tenant Insurance' },
  { value: 'condo', label: 'Condo Insurance' },
  { value: 'umbrella', label: 'Umbrella/Liability' },
  { value: 'disability', label: 'Disability Insurance' },
  { value: 'critical_illness', label: 'Critical Illness' },
] as const;

export const ACCENT_COLOR_PRESETS = [
  { value: '#0f172a', label: 'Navy' },
  { value: '#1e40af', label: 'Blue' },
  { value: '#0d9488', label: 'Teal' },
  { value: '#059669', label: 'Emerald' },
  { value: '#7c3aed', label: 'Purple' },
  { value: '#dc2626', label: 'Red' },
  { value: '#ea580c', label: 'Orange' },
  { value: '#000000', label: 'Black' },
] as const;

export const MAX_FEATURED_TESTIMONIALS = 2;

export const COVER_PHOTO_MAX_SIZE = 5 * 1024 * 1024; // 5MB
export const COVER_PHOTO_ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
export const BADGE_ASSETS_BUCKET = 'badge-assets';
```

**Create `packages/shared/src/validation/badge.schema.ts`:**

Two Zod v4 schemas:

1. `submitTestimonialSchema`:
   - authorName: z.string().min(1, 'Name is required').max(100)
   - authorEmail: z.string().email('Invalid email').optional().or(z.literal(''))
   - isAnonymous: z.boolean().default(false)
   - rating: z.coerce.number().int().min(1).max(5)
   - content: z.string().min(10, 'Please write at least 10 characters').max(2000)
   - strengths: z.array(z.string()).min(1, 'Select at least one strength').max(5)

2. `updateAgentProfileSchema`:
   - licenseNumber: z.string().max(50).optional().or(z.literal(''))
   - bio: z.string().max(500).optional().or(z.literal(''))
   - phone: z.string().max(20).optional().or(z.literal(''))
   - email: z.string().email().optional().or(z.literal(''))
   - website: z.string().url().optional().or(z.literal(''))
   - linkedIn: z.string().url().optional().or(z.literal(''))
   - twitter: z.string().url().optional().or(z.literal(''))
   - facebook: z.string().url().optional().or(z.literal(''))
   - instagram: z.string().url().optional().or(z.literal(''))
   - whatsApp: z.string().max(20).optional().or(z.literal(''))
   - productsOffered: z.array(z.string()).optional()
   - customLinks: z.array(z.object({ label: z.string().min(1).max(50), url: z.string().url() })).max(5).optional()
   - accentColor: z.string().regex(/^#[0-9a-fA-F]{6}$/).optional()
   - isPublished: z.boolean().optional()

Export input types: `SubmitTestimonialInput`, `UpdateAgentProfileInput` using `z.input<typeof schema>`.

**Update `packages/shared/src/index.ts`:**

Add exports at the end, following the existing section pattern:

```typescript
// Types - Badge & Testimonials
export type { AgentProfile, Testimonial, PublicBadgeProfile, CustomLink, TestimonialWithProfile } from './types/badge';

// Constants - Badge
export { STRENGTH_CATEGORIES, INSURANCE_PRODUCTS, ACCENT_COLOR_PRESETS, MAX_FEATURED_TESTIMONIALS, COVER_PHOTO_MAX_SIZE, COVER_PHOTO_ALLOWED_TYPES, BADGE_ASSETS_BUCKET } from './constants/badge';
export type { StrengthCategory } from './constants/badge';

// Validation schemas - Badge & Testimonials
export { submitTestimonialSchema, updateAgentProfileSchema } from './validation/badge.schema';
export type { SubmitTestimonialInput, UpdateAgentProfileInput } from './validation/badge.schema';
```
  </action>
  <verify>
Run `pnpm --filter shared build` (or `pnpm --filter shared tsc --noEmit` if no build script) -- should compile with no type errors.
Verify imports work: the types, schemas, and constants should all be importable from '@anchor/shared'.
  </verify>
  <done>Shared types (AgentProfile, Testimonial, PublicBadgeProfile), Zod schemas (submitTestimonialSchema, updateAgentProfileSchema), and constants (STRENGTH_CATEGORIES, INSURANCE_PRODUCTS, etc.) are all created and exported from @anchor/shared. Database schema is pushed and Prisma client regenerated.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter database exec prisma db push` succeeds
2. `pnpm --filter database exec prisma generate` succeeds
3. Shared package compiles without errors
4. All new exports are accessible from @anchor/shared
</verification>

<success_criteria>
- AgentProfile and Testimonial tables exist in Supabase DB
- Prisma client has .agentProfile and .testimonial accessors
- @anchor/shared exports badge types, schemas, and constants
- No build errors in database or shared packages
</success_criteria>

<output>
After completion, create `.planning/phases/06-trust-and-reputation/06-01-SUMMARY.md`
</output>
