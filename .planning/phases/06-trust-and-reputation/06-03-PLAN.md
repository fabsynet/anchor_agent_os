---
phase: 06-trust-and-reputation
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - apps/web/src/middleware.ts
  - apps/web/src/app/(public)/layout.tsx
  - apps/web/src/app/(public)/testimonial/[slug]/page.tsx
  - apps/web/src/app/(public)/agent/[slug]/page.tsx
  - apps/web/src/components/badge/testimonial-form.tsx
  - apps/web/src/components/badge/star-rating.tsx
  - apps/web/src/components/badge/strength-badges.tsx
  - apps/web/src/components/badge/badge-page-view.tsx
  - apps/web/src/components/badge/testimonial-card.tsx
autonomous: true

must_haves:
  truths:
    - "Public visitor can access /testimonial/[slug] without being redirected to login"
    - "Public visitor can access /agent/[slug] without being redirected to login"
    - "Testimonial form collects name, email, star rating, content, strengths, and anonymity toggle"
    - "Submitted testimonial shows success confirmation"
    - "Badge page displays agent photo, name, agency, license, bio, products, social links, custom links"
    - "Badge page shows featured testimonials prominently, then remaining testimonials below"
    - "Badge page uses agent's chosen accent color"
    - "Badge page is responsive (mobile-friendly)"
  artifacts:
    - path: "apps/web/src/middleware.ts"
      provides: "Updated PUBLIC_ROUTES with /agent and /testimonial"
      contains: "/agent"
    - path: "apps/web/src/app/(public)/layout.tsx"
      provides: "Minimal public layout without sidebar/nav"
    - path: "apps/web/src/app/(public)/testimonial/[slug]/page.tsx"
      provides: "Public testimonial submission page"
    - path: "apps/web/src/app/(public)/agent/[slug]/page.tsx"
      provides: "Public badge page (server component fetching from API)"
    - path: "apps/web/src/components/badge/testimonial-form.tsx"
      provides: "Client-facing testimonial submission form"
    - path: "apps/web/src/components/badge/badge-page-view.tsx"
      provides: "Full badge page display component"
    - path: "apps/web/src/components/badge/star-rating.tsx"
      provides: "Reusable star rating input/display component"
    - path: "apps/web/src/components/badge/testimonial-card.tsx"
      provides: "Individual testimonial display card"
    - path: "apps/web/src/components/badge/strength-badges.tsx"
      provides: "Strength category badge display"
  key_links:
    - from: "apps/web/src/middleware.ts"
      to: "apps/web/src/app/(public)/"
      via: "PUBLIC_ROUTES allowing unauthenticated access"
      pattern: "/agent.*|/testimonial"
    - from: "apps/web/src/app/(public)/agent/[slug]/page.tsx"
      to: "/api/public/badge/:slug"
      via: "Server-side fetch (no auth headers)"
      pattern: "fetch.*public/badge"
    - from: "apps/web/src/app/(public)/testimonial/[slug]/page.tsx"
      to: "/api/public/badge/:slug/testimonials"
      via: "Client-side form submission (no auth headers)"
      pattern: "fetch.*public/badge.*testimonials"
---

<objective>
Create the public-facing pages for Phase 6: the testimonial submission form at `/testimonial/[slug]` and the public agent badge page at `/agent/[slug]`. Includes middleware update to allow unauthenticated access, a minimal public layout, and all badge display components.

Purpose: These are the customer-facing touchpoints -- how clients submit testimonials and how agents showcase their reputation publicly.
Output: Two fully functional public pages with supporting components, accessible without login.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-trust-and-reputation/06-CONTEXT.md
@.planning/phases/06-trust-and-reputation/06-RESEARCH.md
@.planning/phases/06-trust-and-reputation/06-01-SUMMARY.md
@.planning/phases/06-trust-and-reputation/06-02-SUMMARY.md
@apps/web/src/middleware.ts
@apps/web/src/app/(dashboard)/layout.tsx
@packages/shared/src/constants/badge.ts
@packages/shared/src/validation/badge.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Middleware update, public layout, and testimonial submission page</name>
  <files>
    apps/web/src/middleware.ts
    apps/web/src/app/(public)/layout.tsx
    apps/web/src/app/(public)/testimonial/[slug]/page.tsx
    apps/web/src/components/badge/testimonial-form.tsx
    apps/web/src/components/badge/star-rating.tsx
    apps/web/src/components/badge/strength-badges.tsx
  </files>
  <action>
**Update `middleware.ts`:**

Add `/agent` and `/testimonial` to the PUBLIC_ROUTES array:
```typescript
const PUBLIC_ROUTES = [
  '/login',
  '/signup',
  '/verify',
  '/reset-password',
  '/update-password',
  '/accept-invite',
  '/auth/callback',
  '/agent',        // Public badge pages
  '/testimonial',  // Public testimonial submission
];
```

Also update the authenticated-user redirect logic: when a logged-in user visits /agent/* or /testimonial/*, do NOT redirect them to dashboard. Add these paths to the exceptions alongside /verify, /update-password, etc.:
```typescript
if (
  user &&
  isPublicRoute &&
  pathname !== '/verify' &&
  pathname !== '/update-password' &&
  !pathname.startsWith('/accept-invite') &&
  !pathname.startsWith('/auth/callback') &&
  !pathname.startsWith('/agent') &&
  !pathname.startsWith('/testimonial')
) {
  // redirect to dashboard
}
```

**Create `(public)/layout.tsx`:**

Minimal layout with no sidebar, no dashboard nav, no auth check. Just a clean container:
```tsx
export default function PublicLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen bg-background">
      {children}
    </div>
  );
}
```

Import globals.css if not inherited from root layout (check -- it likely IS inherited from root layout.tsx).

**Create `star-rating.tsx`:**

Reusable star rating component using lucide-react `Star` icon. Props: value (number), onChange? (for input mode), readonly? (for display mode), size? ('sm'|'md'|'lg'). Uses `fill-yellow-400 text-yellow-400` for filled stars, `fill-none text-muted-foreground/30` for empty. Interactive mode has hover states. Accessible with aria-label and role="radiogroup". Include a hover preview state (show fill on hover up to hovered star). Type="button" on each star to prevent form submission.

**Create `strength-badges.tsx`:**

Display component for strength category badges. Props: strengths (string[]), size? ('sm'|'md'). Maps strength values to labels using STRENGTH_CATEGORIES from @anchor/shared. Renders as rounded pill badges with a subtle background. Also export a `StrengthPicker` component variant for the form: renders checkboxes with badge-style labels, props: selected (string[]), onChange (callback), max? (default 5).

**Create `testimonial-form.tsx`:**

'use client' component. Uses react-hook-form + zodResolver with submitTestimonialSchema from @anchor/shared. Props: slug (string), agentName (string).

Form fields:
1. **Name** -- text input, required
2. **Email** -- text input, optional, helper text: "Only used to prevent duplicate submissions. Never displayed."
3. **Anonymous toggle** -- checkbox: "Submit anonymously (your name won't be displayed)"
4. **Star rating** -- StarRating component, required, default unset (user must click)
5. **Strengths** -- StrengthPicker component, required (min 1), renders STRENGTH_CATEGORIES as clickable badge-style checkboxes
6. **Testimonial content** -- textarea, min 10 chars, max 2000, with character count display

Submit button with loading state. On submit:
- POST to `${NEXT_PUBLIC_API_URL}/api/public/badge/${slug}/testimonials` using plain fetch (NOT the authenticated api.ts helper)
- On success: show a success state with thank-you message and star animation or checkmark
- On error: show error toast (use sonner) with the error message (e.g., rate limit message)

The form should look clean and professional -- this is client-facing. Use shadcn/ui Card, Input, Textarea, Checkbox, Button, Label components.

**Create `(public)/testimonial/[slug]/page.tsx`:**

Server component that:
1. Awaits params to get slug (Next.js 16 pattern: `const { slug } = await params;`)
2. Fetches minimal agent info from `${API_BASE_URL}/api/public/badge/${slug}` server-side using plain fetch (to get agent name for the form header). If 404, call notFound().
3. Renders a centered layout with:
   - Agent's name and avatar at top ("Leave a review for [Agent Name]")
   - TestimonialForm component (client component) below
4. Add generateMetadata for SEO: title "Review for [Agent Name] | Anchor", description.

IMPORTANT: Use `process.env.NEXT_PUBLIC_API_URL` for the API base URL (available server-side). Use plain fetch -- NOT the authenticated api.ts helper. This page has NO authentication context.
  </action>
  <verify>
1. Visit `/testimonial/test-slug` in browser (incognito) -- should NOT redirect to login
2. Visit `/testimonial/test-slug` while logged in -- should NOT redirect to dashboard
3. Form renders with all fields (star rating, strengths, name, email, content, anonymous toggle)
4. Submit with valid data -- should POST to API and show success
5. Submit same email again within 24h -- should show rate limit error
  </verify>
  <done>Middleware allows public access to /agent and /testimonial routes. Testimonial form at /testimonial/[slug] collects star rating, content, strengths, and author info. Form submits to public API without authentication. Success/error states work correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Public badge page at /agent/[slug]</name>
  <files>
    apps/web/src/app/(public)/agent/[slug]/page.tsx
    apps/web/src/components/badge/badge-page-view.tsx
    apps/web/src/components/badge/testimonial-card.tsx
  </files>
  <action>
**Create `testimonial-card.tsx`:**

Display component for a single testimonial. Props: testimonial object (rating, content, authorName, isAnonymous, strengths, createdAt), variant ('featured'|'standard'). Featured variant: larger card with accent border, slightly larger text, background highlight. Standard variant: clean card with border. Both show:
- Star rating (readonly StarRating component)
- Testimonial content text
- Strength badges (StrengthBadges component)
- Author name (or "Anonymous" if isAnonymous) and relative date
- Featured badge icon/label if featured variant

**Create `badge-page-view.tsx`:**

Full badge page display component. Props: profile (PublicBadgeProfile type from @anchor/shared).

Layout (responsive -- mobile-first):

1. **Cover Banner Section:**
   - Full-width banner image if coverPhotoPath exists (use public URL from Supabase). Fallback: gradient background using agent's accentColor.
   - Agent's profile photo overlapping the banner bottom edge (circular, bordered white, ~96px)
   - Agent's full name (large heading)
   - Agency name (subtitle)
   - License number with a small shield icon if present

2. **Contact & Social Links Section:**
   - Email, phone as clickable links (mailto:, tel:)
   - Social icons row: website, LinkedIn, Twitter/X, Facebook, Instagram, WhatsApp (only show icons for links that exist). Use lucide-react icons (Globe, Linkedin, Twitter, Facebook, Instagram, MessageCircle for WhatsApp). Links open in new tab.

3. **Products Offered Section:**
   - Heading: "Products & Services"
   - Grid/flex of product badges (map values to labels using INSURANCE_PRODUCTS constant)
   - Styled as rounded pills with accent color background (light tint)

4. **Custom Links Section:** (only render if customLinks has items)
   - Heading: "Links"
   - List of clickable links with label text and external link icon

5. **Featured Testimonials Section:** (only render if featured testimonials exist)
   - 1-2 featured TestimonialCard components with 'featured' variant
   - Visually prominent -- slightly larger, accent-colored border

6. **All Testimonials Section:**
   - Heading: "What Clients Say" with count
   - Average rating display (computed from all visible testimonials)
   - Grid of TestimonialCard components with 'standard' variant
   - Ordered by createdAt DESC (API returns them in this order)
   - If no testimonials: "No testimonials yet" message

7. **Footer:**
   - "Powered by Anchor" subtle text with link
   - Link to `/testimonial/${slug}`: "Leave a review" button

Apply accentColor throughout: use CSS custom properties or inline styles. The accent color from the agent's profile should tint headings, borders, and badges. Use `style={{ '--accent': profile.accentColor }}` pattern and reference with Tailwind arbitrary values or inline styles.

**Create `(public)/agent/[slug]/page.tsx`:**

Server component:
1. Await params to get slug
2. Fetch profile from `${API_BASE_URL}/api/public/badge/${slug}` server-side (plain fetch, no auth headers, cache: 'no-store')
3. If not OK, call notFound()
4. Render BadgePageView with the profile data
5. Add generateMetadata:
   - title: "[Agent Name] - Insurance Agent | Anchor"
   - description: "[Agent Name] at [Agency Name] - [bio snippet or products]"
   - openGraph image: agent's avatar or cover photo URL if available

IMPORTANT: This is a server component. Use `process.env.NEXT_PUBLIC_API_URL` for API URL. Plain fetch -- NOT authenticated api.ts. The page should work perfectly for visitors with NO Supabase session. For cover photo and avatar image URLs, construct the Supabase Storage public URL: `${SUPABASE_URL}/storage/v1/object/public/badge-assets/${path}`. The SUPABASE_URL is available as NEXT_PUBLIC_SUPABASE_URL.
  </action>
  <verify>
1. Visit `/agent/test-slug` in incognito -- should display the badge page (or 404 if no profile)
2. Badge page renders all sections: banner, profile info, products, links, testimonials
3. Page is responsive -- check mobile viewport
4. Featured testimonials appear at top, regular ones below
5. "Leave a review" button links to /testimonial/[slug]
6. Accent color applies to UI elements
7. Cover photo/avatar display correctly from Supabase Storage public URLs
  </verify>
  <done>Public badge page at /agent/[slug] displays full agent profile with cover banner, professional info, social links, products offered, custom links, featured testimonials, and all testimonials. Page is responsive, uses agent's accent color, and includes SEO metadata. "Leave a review" CTA links to testimonial form.</done>
</task>

</tasks>

<verification>
1. Incognito browser can access /testimonial/[slug] and /agent/[slug] without login redirect
2. Logged-in user can also access these pages without being redirected to dashboard
3. Testimonial form submits successfully and shows confirmation
4. Badge page displays all profile sections correctly
5. No authenticated api.ts usage on public pages (plain fetch only)
6. `pnpm --filter web build` succeeds
</verification>

<success_criteria>
- Middleware allows /agent/* and /testimonial/* as public routes
- Testimonial form collects all required fields (rating 1-5, content, strengths, name, optional email, anonymous toggle)
- Form submits to public API endpoint without auth headers
- Badge page is a server component fetching data server-side
- Badge page displays: cover photo/banner, avatar, name, agency, license, bio, contact, social links, products, custom links, featured testimonials, all testimonials
- Badge page uses agent's accent color for theming
- Both pages are responsive (mobile-friendly)
- SEO metadata (title, description, og) generated for badge page
</success_criteria>

<output>
After completion, create `.planning/phases/06-trust-and-reputation/06-03-SUMMARY.md`
</output>
