---
phase: 04-documents-and-compliance
plan: 04
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - apps/web/src/app/(dashboard)/compliance/page.tsx
  - apps/web/src/components/compliance/compliance-table.tsx
  - apps/web/src/components/compliance/compliance-filters.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /compliance from the sidebar"
    - "Compliance page shows a paginated table of activity events across all clients"
    - "User can filter by client, action type, date range, user who performed action, and linked policy"
    - "Compliance entries are immutable — no edit or delete buttons exist"
    - "Newest events appear first by default"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/compliance/page.tsx"
      provides: "/compliance route page"
      min_lines: 30
    - path: "apps/web/src/components/compliance/compliance-table.tsx"
      provides: "Compliance data table with pagination"
      exports: ["ComplianceTable"]
    - path: "apps/web/src/components/compliance/compliance-filters.tsx"
      provides: "Filter controls for compliance log"
      exports: ["ComplianceFilters"]
  key_links:
    - from: "apps/web/src/app/(dashboard)/compliance/page.tsx"
      to: "/api/compliance"
      via: "api.get() with filter query params"
      pattern: "api\\.get.*compliance"
    - from: "apps/web/src/components/compliance/compliance-filters.tsx"
      to: "/api/compliance/action-types"
      via: "api.get() to fetch available action types for dropdown"
      pattern: "api\\.get.*action-types"
    - from: "NAV_ITEMS in roles.ts"
      to: "/compliance"
      via: "Sidebar navigation link (updated in Plan 01)"
      pattern: "compliance.*\\/compliance"
---

<objective>
Build the standalone compliance page at /compliance with a filtered, paginated activity log table accessible from the sidebar.

Purpose: Agency-wide compliance view showing all logged actions across all clients, with rich filtering capabilities. This is the primary audit trail interface.
Output: /compliance page with table, filters, and pagination — linked from sidebar via the Compliance nav item (updated in Plan 01).
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-documents-and-compliance/04-RESEARCH.md
@.planning/phases/04-documents-and-compliance/04-CONTEXT.md
@.planning/phases/04-documents-and-compliance/04-02-SUMMARY.md
@apps/web/src/app/(dashboard)/clients/page.tsx
@apps/web/src/components/clients/client-list.tsx
@apps/web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Compliance page, table, and filter components</name>
  <files>
    apps/web/src/app/(dashboard)/compliance/page.tsx
    apps/web/src/components/compliance/compliance-table.tsx
    apps/web/src/components/compliance/compliance-filters.tsx
  </files>
  <action>
Create the `apps/web/src/components/compliance/` directory and the compliance page.

**1. Create `apps/web/src/components/compliance/compliance-filters.tsx`:**

A filter bar component for the compliance log (per user decision: filters for client, action type, date range, user who performed action, linked policy).

Props: `filters: ComplianceFilters`, `onFiltersChange: (filters: ComplianceFilters) => void`, `clients: { id: string; firstName: string; lastName: string }[]`, `users: { id: string; firstName: string; lastName: string }[]`, `actionTypes: { value: string; label: string }[]`

ComplianceFilters type:
```typescript
interface ComplianceFilterState {
  clientId?: string;
  type?: string;
  userId?: string;
  policyId?: string;
  startDate?: string;
  endDate?: string;
}
```

Implementation:
- Horizontal filter bar with responsive wrapping (flex-wrap)
- **Client filter**: Select dropdown populated with client list. Show "All Clients" as default. Use Radix Select (already available).
- **Action type filter**: Select dropdown populated from `actionTypes` prop (fetched from `/api/compliance/action-types`). Show "All Actions" as default.
- **User filter**: Select dropdown populated with user list. Show "All Users" as default.
- **Date range filter**: Two date inputs (Start Date, End Date) using native `<input type="date">` — simple, no new dependency needed.
- **Clear filters button**: Resets all filters to empty. Only visible when at least one filter is active.
- Each filter change immediately calls `onFiltersChange` with updated state.
- Use the `_none` sentinel value pattern for Select "all" options (same as established in Phase 3 — Radix Select doesn't support empty string values). When `_none` is selected, treat as no filter (omit from query).

**2. Create `apps/web/src/components/compliance/compliance-table.tsx`:**

Compliance data table with pagination (per user decision: default sort newest first, per research: 25 entries per page, same pagination pattern as other lists).

Props: `data: ComplianceEvent[]`, `total: number`, `page: number`, `limit: number`, `totalPages: number`, `onPageChange: (page: number) => void`, `loading?: boolean`

ComplianceEvent type (for frontend display):
```typescript
interface ComplianceEvent {
  id: string;
  type: string;
  description: string;
  createdAt: string;
  user?: { firstName: string; lastName: string };
  client?: { id: string; firstName: string; lastName: string };
  policyId?: string | null;
  metadata?: Record<string, unknown> | null;
}
```

Implementation:
- Use @tanstack/react-table for the table (already installed, used in other list pages).
- Columns: Date/Time (formatted with date-fns: "MMM d, yyyy h:mm a"), Action Type (color-coded badge), Description, Client (name, linked to client profile), User (name), Policy (show policyId or "-" if null).
- Action type badges: use distinct muted colors per category (document events = blue, policy events = green, task events = amber, client events = purple, note events = gray).
- NO action column — compliance log is immutable (no edit/delete per user decision).
- Pagination controls at bottom: Previous/Next buttons, page info ("Page X of Y"), same pattern as client/policy lists.
- Loading state: skeleton rows.
- Empty state: "No compliance events found" with a note about adjusting filters.

**3. Create `apps/web/src/app/(dashboard)/compliance/page.tsx`:**

The main compliance page at `/compliance`.

Implementation:
- "use client" component
- Page header: "Compliance Log" title with subtitle "Immutable record of all tracked actions"
- Fetch compliance events: `api.get<PaginatedResponse>(`/api/compliance?${queryParams}`)` where queryParams includes all active filters + page + limit
- Fetch supporting data on mount:
  - Action types from `api.get<ActionType[]>('/api/compliance/action-types')`
  - Client list from `api.get<PaginatedClients>('/api/clients?limit=500')` (for client filter dropdown — MVP scale is small)
  - User list from `api.get<User[]>('/api/users')` (for user filter dropdown — existing endpoint)
- State: filters, page, loading, data
- Re-fetch events when filters or page changes (useEffect with dependencies)
- Layout:
  - ComplianceFilters at top
  - ComplianceTable below
  - Pagination at bottom (part of ComplianceTable)
- URL query params sync (optional nice-to-have): Update URL search params when filters change so the view is shareable. Use `useSearchParams` from next/navigation if feasible, otherwise skip for MVP.

Data flow:
1. Page mounts -> fetch action types, clients, users (one-time) + fetch compliance events
2. User changes filter -> update filter state -> re-fetch events with new filters
3. User changes page -> update page state -> re-fetch events with new page
4. Results render in ComplianceTable

Ensure the Compliance sidebar nav link works (NAV_ITEMS was updated in Plan 01 to point to /compliance).
  </action>
  <verify>
Run `pnpm --filter web build` — must succeed.
Run `pnpm build` from monorepo root — must succeed.
Verify /compliance page file exists at apps/web/src/app/(dashboard)/compliance/page.tsx.
Verify compliance components exist in apps/web/src/components/compliance/.
  </verify>
  <done>
Compliance page at /compliance is fully functional with: paginated table of all activity events (newest first), filter bar with client/action type/user/date range filters, immutable read-only view (no edit/delete), proper empty and loading states. Page is accessible via the Compliance sidebar link. Full monorepo builds successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Policy detail document section</name>
  <files>
    apps/web/src/components/policies/policy-document-section.tsx
  </files>
  <action>
Create a document section component for the policy detail view (per user decision: "Documents also appear in a documents section on the policy detail view — only that policy's docs").

**1. Create `apps/web/src/components/policies/policy-document-section.tsx`:**

Props: `clientId: string`, `policyId: string`

Implementation:
- Fetch documents filtered by policyId: `api.get<DocumentListItem[]>(`/api/clients/${clientId}/documents?policyId=${policyId}`)`
- Show DocumentUploadZone (for uploading directly to this policy's folder)
- Show DocumentList (documents for this policy only)
- Show DocumentPreviewModal (reuse from documents/ components)
- Upload flow: opens DocumentUploadDialog with policyId pre-set
- Compact layout suitable for embedding in a policy detail view or dialog
- Empty state: "No documents for this policy" with upload prompt

**2. Integration point:**

Check where the policy detail is currently shown. In the existing codebase, policy details may appear in:
- A policy detail dialog/modal (from policy-cards.tsx or policy-table.tsx)
- A dedicated policy page

Find the existing policy detail view and add this PolicyDocumentSection component below the policy details. If the policy detail is in a dialog, add a scrollable section at the bottom. If it's a page, add as a new section.

Look at `apps/web/src/components/policies/policy-cards.tsx` and `apps/web/src/components/clients/client-policies-tab.tsx` to understand where policy detail views are shown.

If no suitable existing policy detail view exists for embedding (e.g., policies are only shown in list/card form without an expanded detail view), then skip the embedding and note in the summary that this component is ready to be integrated when a policy detail page/dialog is created.
  </action>
  <verify>
Run `pnpm --filter web build` — must succeed.
Verify policy-document-section.tsx exists in apps/web/src/components/policies/.
  </verify>
  <done>
PolicyDocumentSection component created and integrated into the policy detail view (or ready for integration if no detail view exists). Shows documents specific to one policy with upload capability. Reuses document components from Plan 03 Task 1.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with no errors
2. /compliance page renders with table and filters
3. Compliance filters work: client, action type, user, date range
4. Compliance table shows events newest-first with pagination
5. Compliance log has NO edit/delete capabilities (immutable)
6. Policy document section shows only that policy's documents
7. Sidebar "Compliance" link navigates to /compliance
</verification>

<success_criteria>
- /compliance page is accessible from sidebar and shows agency-wide compliance log
- All 5 filter types work (client, action type, date range, user, policy)
- Pagination works with 25 events per page
- Compliance entries are strictly immutable (read-only UI)
- Policy document section shows/uploads docs for a specific policy
- All builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-documents-and-compliance/04-04-SUMMARY.md`
</output>
