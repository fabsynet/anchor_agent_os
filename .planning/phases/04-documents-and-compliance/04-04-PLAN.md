---
phase: 04-documents-and-compliance
plan: 04
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - apps/web/src/app/(dashboard)/compliance/page.tsx
  - apps/web/src/components/compliance/compliance-table.tsx
  - apps/web/src/components/compliance/compliance-filters.tsx
  - apps/web/src/components/policies/policy-document-section.tsx
  - apps/web/src/components/policies/policy-cards.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /compliance from the sidebar"
    - "Compliance page shows a paginated table of activity events across all clients"
    - "User can filter by client, action type, date range, user who performed action, and linked policy"
    - "Compliance entries are immutable -- no edit or delete buttons exist"
    - "Newest events appear first by default"
    - "Linked policy filter dropdown exists in compliance filters"
    - "Policy cards have a View button that opens a detail dialog showing policy info and documents"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/compliance/page.tsx"
      provides: "/compliance route page"
      min_lines: 30
    - path: "apps/web/src/components/compliance/compliance-table.tsx"
      provides: "Compliance data table with pagination"
      exports: ["ComplianceTable"]
    - path: "apps/web/src/components/compliance/compliance-filters.tsx"
      provides: "Filter controls for compliance log including linked policy filter"
      exports: ["ComplianceFilters"]
    - path: "apps/web/src/components/policies/policy-document-section.tsx"
      provides: "Document section for policy detail view"
      exports: ["PolicyDocumentSection"]
  key_links:
    - from: "apps/web/src/app/(dashboard)/compliance/page.tsx"
      to: "/api/compliance"
      via: "api.get() with filter query params"
      pattern: "api\\.get.*compliance"
    - from: "apps/web/src/components/compliance/compliance-filters.tsx"
      to: "/api/compliance/action-types"
      via: "api.get() to fetch available action types for dropdown"
      pattern: "api\\.get.*action-types"
    - from: "apps/web/src/components/compliance/compliance-filters.tsx"
      to: "policies data"
      via: "Policies prop for linked policy filter dropdown"
      pattern: "policyId"
    - from: "NAV_ITEMS in roles.ts"
      to: "/compliance"
      via: "Sidebar navigation link (updated in Plan 01)"
      pattern: "compliance.*\\/compliance"
    - from: "apps/web/src/components/policies/policy-cards.tsx"
      to: "PolicyDocumentSection"
      via: "View button opens dialog with PolicyDocumentSection"
      pattern: "PolicyDocumentSection|policy-document-section"
---

<objective>
Build the standalone compliance page at /compliance with a filtered, paginated activity log table accessible from the sidebar. Create policy detail dialog with document section on policy cards. Ensure all 5 compliance filters are implemented including linked policy.

Purpose: Agency-wide compliance view showing all logged actions across all clients, with rich filtering capabilities. Policy detail dialog provides the required "documents on policy detail view" per user decision.
Output: /compliance page with table, filters (including linked policy), and pagination. Policy detail dialog with documents. Both linked from their respective entry points.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-documents-and-compliance/04-RESEARCH.md
@.planning/phases/04-documents-and-compliance/04-CONTEXT.md
@.planning/phases/04-documents-and-compliance/04-02-SUMMARY.md
@apps/web/src/app/(dashboard)/clients/page.tsx
@apps/web/src/components/clients/client-list.tsx
@apps/web/src/components/policies/policy-cards.tsx
@apps/web/src/lib/api.ts
@apps/web/src/components/documents/document-upload-zone.tsx
@apps/web/src/components/documents/document-upload-dialog.tsx
@apps/web/src/components/documents/document-list.tsx
@apps/web/src/components/documents/document-preview-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Compliance page, table, and filter components (with linked policy filter)</name>
  <files>
    apps/web/src/app/(dashboard)/compliance/page.tsx
    apps/web/src/components/compliance/compliance-table.tsx
    apps/web/src/components/compliance/compliance-filters.tsx
  </files>
  <action>
Create the `apps/web/src/components/compliance/` directory and the compliance page.

**1. Create `apps/web/src/components/compliance/compliance-filters.tsx`:**

A filter bar component for the compliance log (per user decision: filters for client, action type, date range, user who performed action, linked policy).

Props: `filters: ComplianceFilterState`, `onFiltersChange: (filters: ComplianceFilterState) => void`, `clients: { id: string; firstName: string; lastName: string }[]`, `users: { id: string; firstName: string; lastName: string }[]`, `actionTypes: { value: string; label: string }[]`, `policies: { id: string; policyNumber?: string; type: string; clientId: string }[]`

ComplianceFilterState type:
```typescript
interface ComplianceFilterState {
  clientId?: string;
  type?: string;
  userId?: string;
  policyId?: string;
  startDate?: string;
  endDate?: string;
}
```

Implementation:
- Horizontal filter bar with responsive wrapping (flex-wrap)
- **Client filter**: Select dropdown populated with client list. Show "All Clients" as default. Use Radix Select (already available).
- **Action type filter**: Select dropdown populated from `actionTypes` prop (fetched from `/api/compliance/action-types`). Show "All Actions" as default.
- **User filter**: Select dropdown populated with user list. Show "All Users" as default.
- **Linked policy filter**: Select dropdown populated from `policies` prop. Show "All Policies" as default. Display each option as policy type + policy number (e.g., "Auto - #POL-001"). If a client filter is active, only show policies for that client (filter the policies array by clientId).
- **Date range filter**: Two date inputs (Start Date, End Date) using native `<input type="date">` -- simple, no new dependency needed.
- **Clear filters button**: Resets all filters to empty. Only visible when at least one filter is active.
- Each filter change immediately calls `onFiltersChange` with updated state.
- Use the `_none` sentinel value pattern for Select "all" options (same as established in Phase 3 -- Radix Select doesn't support empty string values). When `_none` is selected, treat as no filter (omit from query).

**2. Create `apps/web/src/components/compliance/compliance-table.tsx`:**

Compliance data table with pagination (per user decision: default sort newest first, per research: 25 entries per page, same pagination pattern as other lists).

Props: `data: ComplianceEvent[]`, `total: number`, `page: number`, `limit: number`, `totalPages: number`, `onPageChange: (page: number) => void`, `loading?: boolean`

ComplianceEvent type (for frontend display):
```typescript
interface ComplianceEvent {
  id: string;
  type: string;
  description: string;
  createdAt: string;
  user?: { firstName: string; lastName: string };
  client?: { id: string; firstName: string; lastName: string };
  policyId?: string | null;
  policy?: { id: string; policyNumber?: string; type: string } | null;
  metadata?: Record<string, unknown> | null;
}
```

Implementation:
- Use @tanstack/react-table for the table (already installed, used in other list pages).
- Columns: Date/Time (formatted with date-fns: "MMM d, yyyy h:mm a"), Action Type (color-coded badge), Description, Client (name, linked to client profile), User (name), Policy (show policy number/type or "-" if null).
- Action type badges: use distinct muted colors per category (document events = blue, policy events = green, task events = amber, client events = purple, note events = gray).
- NO action column -- compliance log is immutable (no edit/delete per user decision).
- Pagination controls at bottom: Previous/Next buttons, page info ("Page X of Y"), same pattern as client/policy lists.
- Loading state: skeleton rows.
- Empty state: "No compliance events found" with a note about adjusting filters.

**3. Create `apps/web/src/app/(dashboard)/compliance/page.tsx`:**

The main compliance page at `/compliance`.

Implementation:
- "use client" component
- Page header: "Compliance Log" title with subtitle "Immutable record of all tracked actions"
- Fetch compliance events: `api.get<PaginatedResponse>(`/api/compliance?${queryParams}`)` where queryParams includes all active filters + page + limit
- Fetch supporting data on mount:
  - Action types from `api.get<ActionType[]>('/api/compliance/action-types')`
  - Client list from `api.get<PaginatedClients>('/api/clients?limit=500')` (for client filter dropdown -- MVP scale is small)
  - User list from `api.get<User[]>('/api/users')` (for user filter dropdown -- existing endpoint). NOTE: This endpoint is admin-only (@Roles('admin')). If the current user is not admin, the call will return 403. Handle this gracefully: wrap in try/catch, and if 403, simply hide the user filter or show it as disabled. For MVP this is acceptable since the compliance page is primarily used by admins.
  - Policy list from `api.get<PaginatedPolicies>('/api/policies?limit=500')` (for linked policy filter dropdown -- reuse the existing standalone policies endpoint)
- State: filters, page, loading, data
- Re-fetch events when filters or page changes (useEffect with dependencies)
- Layout:
  - ComplianceFilters at top (pass clients, users, actionTypes, policies as props)
  - ComplianceTable below
  - Pagination at bottom (part of ComplianceTable)
- URL query params sync (optional nice-to-have): Update URL search params when filters change so the view is shareable. Use `useSearchParams` from next/navigation if feasible, otherwise skip for MVP.

Data flow:
1. Page mounts -> fetch action types, clients, users, policies (one-time) + fetch compliance events
2. User changes filter -> update filter state -> re-fetch events with new filters
3. User changes page -> update page state -> re-fetch events with new page
4. Results render in ComplianceTable

Ensure the Compliance sidebar nav link works (NAV_ITEMS was updated in Plan 01 to point to /compliance).
  </action>
  <verify>
Run `pnpm --filter web build` -- must succeed.
Run `pnpm build` from monorepo root -- must succeed.
Verify /compliance page file exists at apps/web/src/app/(dashboard)/compliance/page.tsx.
Verify compliance components exist in apps/web/src/components/compliance/.
Verify compliance-filters.tsx has a Select dropdown for policyId (linked policy filter).
Confirm the page fetches /api/users and handles 403 gracefully (try/catch).
  </verify>
  <done>
Compliance page at /compliance is fully functional with: paginated table of all activity events (newest first), filter bar with client/action type/user/date range/linked policy filters (all 5 per user decision), immutable read-only view (no edit/delete), proper empty and loading states. Linked policy filter is populated from policies endpoint. User filter handles admin-only endpoint gracefully. Page is accessible via the Compliance sidebar link. Full monorepo builds successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Policy detail dialog with document section on policy cards</name>
  <files>
    apps/web/src/components/policies/policy-document-section.tsx
    apps/web/src/components/policies/policy-cards.tsx
  </files>
  <action>
Per user decision: "Documents also appear in a documents section on the policy detail view (only that policy's docs)". The codebase currently has NO policy detail page or dialog -- policies are shown in card/table list form only. This task creates a policy detail dialog accessible from policy cards, which includes the required document section.

**1. Create `apps/web/src/components/policies/policy-document-section.tsx`:**

A document section component for embedding in a policy detail view.

Props: `clientId: string`, `policyId: string`

Implementation:
- Fetch documents filtered by policyId: `api.get<DocumentListItem[]>(`/api/clients/${clientId}/documents?policyId=${policyId}`)`
- Show DocumentUploadZone (for uploading directly to this policy's folder)
- Show DocumentList (documents for this policy only) -- reuse from documents/ components
- Show DocumentPreviewModal (reuse from documents/ components)
- Upload flow: opens DocumentUploadDialog with policyId pre-set
- Compact layout suitable for embedding in a dialog (no extra padding/margins)
- Empty state: "No documents for this policy" with upload prompt

**2. Update `apps/web/src/components/policies/policy-cards.tsx` -- add View button and policy detail dialog:**

Add a "View" button to each policy card that opens a detail dialog. The detail dialog shows the policy information and the PolicyDocumentSection below it.

Changes to PolicyCards component:
- Add state: `viewingPolicy: Policy | null` (which policy's detail dialog is open)
- Add a "View" button in the CardFooter (before Edit button): `<Button variant="ghost" size="xs" onClick={() => setViewingPolicy(policy)}><Eye className="size-3" /> View</Button>`
- Import `Eye` from lucide-react
- Add a Dialog component that opens when `viewingPolicy` is set:

```tsx
<Dialog open={!!viewingPolicy} onOpenChange={(open) => !open && setViewingPolicy(null)}>
  <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
    <DialogHeader>
      <DialogTitle>{policyLabel} - {viewingPolicy?.policyNumber || 'Details'}</DialogTitle>
    </DialogHeader>

    {/* Policy details summary */}
    <div className="space-y-2 text-sm">
      <div className="flex justify-between">
        <span className="text-muted-foreground">Status</span>
        <PolicyStatusBadge status={viewingPolicy.status} />
      </div>
      <div className="flex justify-between">
        <span className="text-muted-foreground">Carrier</span>
        <span>{viewingPolicy.carrier || '--'}</span>
      </div>
      <div className="flex justify-between">
        <span className="text-muted-foreground">Premium</span>
        <span>{formatCurrency(viewingPolicy.premium)}</span>
      </div>
      <div className="flex justify-between">
        <span className="text-muted-foreground">Coverage</span>
        <span>{formatCurrency(viewingPolicy.coverageAmount)}</span>
      </div>
      <div className="flex justify-between">
        <span className="text-muted-foreground">Deductible</span>
        <span>{formatCurrency(viewingPolicy.deductible)}</span>
      </div>
      <div className="flex justify-between">
        <span className="text-muted-foreground">Start Date</span>
        <span>{formatDate(viewingPolicy.startDate)}</span>
      </div>
      <div className="flex justify-between">
        <span className="text-muted-foreground">Expiry Date</span>
        <span>{formatDate(viewingPolicy.endDate)}</span>
      </div>
      {viewingPolicy.notes && (
        <div>
          <span className="text-muted-foreground">Notes</span>
          <p className="mt-1">{viewingPolicy.notes}</p>
        </div>
      )}
    </div>

    {/* Separator */}
    <Separator />

    {/* Documents section */}
    <div>
      <h3 className="text-sm font-semibold mb-3">Documents</h3>
      <PolicyDocumentSection
        clientId={clientId}
        policyId={viewingPolicy.id}
      />
    </div>
  </DialogContent>
</Dialog>
```

- Import Dialog, DialogContent, DialogHeader, DialogTitle from `@/components/ui/dialog`
- Import Separator from `@/components/ui/separator` (or use a simple `<hr>` if separator component doesn't exist)
- Import PolicyDocumentSection from `./policy-document-section`
- The `clientId` prop is already available on PolicyCardsProps

This satisfies the locked user decision: "Documents also appear in a documents section on the policy detail view (only that policy's docs)". The policy detail dialog IS the policy detail view, since the codebase uses a card/dialog pattern (not dedicated pages) for policy details.
  </action>
  <verify>
Run `pnpm --filter web build` -- must succeed.
Verify policy-document-section.tsx exists in apps/web/src/components/policies/.
Verify policy-cards.tsx has a View button and Dialog import.
Verify the Dialog renders PolicyDocumentSection with clientId and policyId props.
  </verify>
  <done>
PolicyDocumentSection component created and integrated into a new policy detail dialog on policy-cards.tsx. Each policy card has a "View" button that opens a detail dialog showing policy information and a documents section (upload + list for that policy only). This satisfies the locked user decision that documents appear on the policy detail view.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with no errors
2. /compliance page renders with table and filters
3. Compliance filters include all 5 types: client, action type, user, date range, linked policy
4. Linked policy filter Select dropdown is present in compliance-filters.tsx
5. Compliance table shows events newest-first with pagination
6. Compliance log has NO edit/delete capabilities (immutable)
7. Policy cards have a "View" button that opens a detail dialog
8. Policy detail dialog shows policy info + PolicyDocumentSection with that policy's documents
9. PolicyDocumentSection allows uploading documents to the specific policy
10. Sidebar "Compliance" link navigates to /compliance
</verification>

<success_criteria>
- /compliance page is accessible from sidebar and shows agency-wide compliance log
- All 5 filter types work (client, action type, date range, user, linked policy)
- Pagination works with 25 events per page
- Compliance entries are strictly immutable (read-only UI)
- Policy detail dialog opens from View button on policy cards
- Policy detail dialog shows PolicyDocumentSection with policy-specific documents
- All builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-documents-and-compliance/04-04-SUMMARY.md`
</output>
