---
phase: 04-documents-and-compliance
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - apps/web/src/components/documents/document-upload-zone.tsx
  - apps/web/src/components/documents/document-upload-dialog.tsx
  - apps/web/src/components/documents/document-folder-view.tsx
  - apps/web/src/components/documents/document-list.tsx
  - apps/web/src/components/documents/document-preview-modal.tsx
  - apps/web/src/components/documents/document-category-badge.tsx
  - apps/web/src/components/clients/client-documents-tab.tsx
  - apps/web/src/components/clients/client-compliance-tab.tsx
  - apps/web/src/app/(dashboard)/clients/[id]/page.tsx
  - apps/web/src/components/policies/policy-cards.tsx
  - apps/web/src/components/clients/client-list.tsx
  - apps/web/src/components/clients/client-table.tsx
  - apps/web/src/components/clients/client-cards.tsx
autonomous: true

must_haves:
  truths:
    - "User can upload documents via drag-and-drop or click-to-browse on a client's Documents tab"
    - "Multi-file upload works with per-file category selection before confirming"
    - "Documents tab shows folder-like navigation: General folder + one folder per policy"
    - "User can preview PDFs and images in-app via modal, with download button always available"
    - "User can delete documents from the document list"
    - "Document count badges appear on client list rows and policy cards"
    - "Client profile has a Compliance tab showing per-client activity events"
    - "Word docs and unsupported types show download-only (no preview)"
  artifacts:
    - path: "apps/web/src/components/documents/document-category-badge.tsx"
      provides: "Category badge display for document items"
      exports: ["DocumentCategoryBadge"]
    - path: "apps/web/src/components/documents/document-upload-zone.tsx"
      provides: "Drag-and-drop zone with click-to-browse fallback"
      exports: ["DocumentUploadZone"]
    - path: "apps/web/src/components/documents/document-upload-dialog.tsx"
      provides: "Multi-file upload confirmation dialog with per-file category selection"
      exports: ["DocumentUploadDialog"]
    - path: "apps/web/src/components/documents/document-folder-view.tsx"
      provides: "Breadcrumb-style folder navigation (General + per-policy folders)"
      exports: ["DocumentFolderView"]
    - path: "apps/web/src/components/documents/document-list.tsx"
      provides: "File list within a folder context with preview/download/delete actions"
      exports: ["DocumentList"]
    - path: "apps/web/src/components/documents/document-preview-modal.tsx"
      provides: "PDF iframe / image preview in dialog with download button"
      exports: ["DocumentPreviewModal"]
    - path: "apps/web/src/components/clients/client-documents-tab.tsx"
      provides: "Full Documents tab for client profile"
      exports: ["ClientDocumentsTab"]
    - path: "apps/web/src/components/clients/client-compliance-tab.tsx"
      provides: "Per-client compliance activity log section"
      exports: ["ClientComplianceTab"]
  key_links:
    - from: "apps/web/src/components/documents/document-upload-dialog.tsx"
      to: "/api/clients/:clientId/documents"
      via: "api.upload() with FormData"
      pattern: "api\\.upload.*clients.*documents"
    - from: "apps/web/src/components/documents/document-list.tsx"
      to: "/api/clients/:clientId/documents/:id/url"
      via: "api.get() for signed URL, then open in preview modal"
      pattern: "api\\.get.*documents.*url"
    - from: "apps/web/src/components/clients/client-documents-tab.tsx"
      to: "/api/clients/:clientId/documents"
      via: "api.get() for document list with folder grouping"
      pattern: "api\\.get.*documents"
    - from: "apps/web/src/components/clients/client-compliance-tab.tsx"
      to: "/api/compliance?clientId="
      via: "api.get() for per-client compliance events"
      pattern: "api\\.get.*compliance.*clientId"
---

<objective>
Build the complete document management frontend: upload zone, upload dialog, folder navigation, document list, preview modal, and integrate into client profile (Documents tab + Compliance tab). Add document count badges to client list and policy cards.

Purpose: Users can upload, browse, preview, download, and delete documents linked to clients and policies, with a folder-like experience. Users can also see per-client compliance activity.
Output: Full document UI on client profile, document count badges across the app, per-client compliance section.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-documents-and-compliance/04-RESEARCH.md
@.planning/phases/04-documents-and-compliance/04-CONTEXT.md
@.planning/phases/04-documents-and-compliance/04-01-SUMMARY.md
@.planning/phases/04-documents-and-compliance/04-02-SUMMARY.md
@apps/web/src/lib/api.ts
@apps/web/src/app/(dashboard)/clients/[id]/page.tsx
@apps/web/src/components/clients/client-list.tsx
@apps/web/src/components/clients/client-table.tsx
@apps/web/src/components/clients/client-cards.tsx
@apps/web/src/components/clients/client-policies-tab.tsx
@apps/web/src/components/policies/policy-cards.tsx
@apps/web/src/components/ui/dialog.tsx
@apps/web/src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document UI components (upload, browse, preview, delete)</name>
  <files>
    apps/web/src/components/documents/document-upload-zone.tsx
    apps/web/src/components/documents/document-upload-dialog.tsx
    apps/web/src/components/documents/document-folder-view.tsx
    apps/web/src/components/documents/document-list.tsx
    apps/web/src/components/documents/document-preview-modal.tsx
    apps/web/src/components/documents/document-category-badge.tsx
  </files>
  <action>
Create the `apps/web/src/components/documents/` directory and build 6 components:

**1. `document-category-badge.tsx`:**
Simple badge component that displays a document's category with a color-coded label. Import `DOCUMENT_CATEGORIES` from `@anchor/shared` to map enum values to display labels. Use a subtle colored badge (similar to status badges elsewhere in the app). Each category can have a distinct muted background color.

**2. `document-upload-zone.tsx`:**
Drag-and-drop zone with click-to-browse fallback (per user decision: BOTH must be available).

Props: `onFilesSelected: (files: File[]) => void`, `disabled?: boolean`

Implementation:
- Use HTML5 native drag events (onDragOver, onDragLeave, onDrop) -- do NOT add react-dropzone dependency
- Hidden `<input type="file" multiple>` triggered by click
- Accept attribute: `.pdf,.jpg,.jpeg,.png,.gif,.webp,.doc,.docx`
- Visual states: default (dashed border), dragging (highlighted border + bg), disabled (greyed out)
- Show upload icon (Upload from lucide-react), text "Drag and drop files here, or click to browse", size limit note "PDF, images, Word documents up to 10MB"
- Client-side validation: reject files > 10MB with toast notification (import `MAX_FILE_SIZE` from `@anchor/shared`). Use `sonner` toast for errors.

**3. `document-upload-dialog.tsx`:**
Multi-file upload confirmation dialog (per user decision: multi-file with per-file category selection).

Props: `clientId: string`, `policyId?: string`, `open: boolean`, `onOpenChange: (open: boolean) => void`, `onUploadComplete: () => void`

Implementation:
- Receives files from the upload zone
- Shows a table/list of selected files with: filename, size (formatted), category dropdown per file
- Default category: "correspondence" for all files; user can change each individually
- Category dropdown uses DOCUMENT_CATEGORIES from @anchor/shared
- "Upload" button that:
  1. Creates FormData with files under key "files"
  2. Appends policyId if provided
  3. Appends categories as JSON string array
  4. Calls `api.upload<Document[]>(`/api/clients/${clientId}/documents`, formData)`
  5. Shows loading spinner during upload ("Uploading X of Y files..." or simple "Uploading...")
  6. On success: toast success, call onUploadComplete(), close dialog
  7. On error: toast error with message
- Cancel button to close without uploading
- Remove file button (X) next to each file row to remove from batch before upload

**4. `document-folder-view.tsx`:**
Breadcrumb-style folder navigation (per user decision: folder-like structure, per research: breadcrumb not full tree).

Props: `clientId: string`, `policies: { id: string; policyNumber?: string; type: string; carrier?: string }[]`, `selectedFolder: string | null` (null = root view showing all folders, string = policyId or "general"), `onFolderSelect: (folder: string | null) => void`, `documentCounts: Record<string, number>` (folder id -> count)

Implementation:
- Root view shows a grid of folder cards: one "General" folder (for docs without a policy) + one folder per policy
- Each folder card shows: folder icon (FolderOpen from lucide-react), policy name/number (or "General"), document count badge
- Breadcrumb at top: "Documents" > [folder name] -- clicking "Documents" goes back to root view
- When a folder is selected, the parent component shows DocumentList filtered to that folder's policyId (or null for General)

**5. `document-list.tsx`:**
File list within a folder showing documents with actions.

Props: `documents: DocumentListItem[]`, `onPreview: (doc: DocumentListItem) => void`, `onDelete: (doc: DocumentListItem) => void`, `loading?: boolean`

Implementation:
- Table or card list of documents showing: file icon (based on mimeType -- FileText for PDF, Image for images, File for others from lucide-react), fileName, category badge (DocumentCategoryBadge), file size (formatted: KB/MB), uploaded by name, upload date (formatted with date-fns)
- Action buttons per row: Preview (Eye icon -- only for PDF/images), Download (Download icon), Delete (Trash2 icon with confirmation dialog)
- Empty state: "No documents in this folder" with upload zone prompt
- Loading state: skeleton rows
- Delete confirmation: "Are you sure you want to delete {fileName}?" with destructive confirm button

**6. `document-preview-modal.tsx`:**
In-app preview for PDFs and images (per user decision: modal/panel within the app).

Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `url: string | null`, `mimeType: string`, `fileName: string`

Implementation:
- Use Dialog (Radix) -- already available in UI components
- For PDFs: `<iframe src={url + '#toolbar=1'} className="w-full h-[70vh]" />`
- For images: `<img src={url} alt={fileName} className="max-w-full max-h-[70vh] mx-auto object-contain" />`
- For Word docs / unsupported types: message "Preview not available for this file type"
- Download button always visible in dialog footer: `<a href={url} download={fileName}>Download</a>`
- Dialog title shows the file name
- Max width: `max-w-4xl`, max height: `max-h-[90vh]`
  </action>
  <verify>
Run `pnpm --filter web build` -- must succeed with no type errors.
Verify all 6 component files exist in apps/web/src/components/documents/.
Each component must be a "use client" component.
  </verify>
  <done>
All 6 document UI components created: upload zone (drag-and-drop + click), upload dialog (multi-file with per-file category), folder view (breadcrumb navigation), document list (with preview/download/delete), preview modal (iframe for PDF, img for images), category badge. All components use existing UI primitives and shared types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Client profile tabs (Documents + Compliance) + count badges on client list and policy cards</name>
  <files>
    apps/web/src/components/clients/client-documents-tab.tsx
    apps/web/src/components/clients/client-compliance-tab.tsx
    apps/web/src/app/(dashboard)/clients/[id]/page.tsx
    apps/web/src/components/policies/policy-cards.tsx
    apps/web/src/components/clients/client-list.tsx
    apps/web/src/components/clients/client-table.tsx
    apps/web/src/components/clients/client-cards.tsx
  </files>
  <action>
**1. Create `apps/web/src/components/clients/client-documents-tab.tsx`:**

The Documents tab for the client profile page. This is the main document management interface.

Props: `clientId: string`

Implementation:
- Fetch documents from `GET /api/clients/${clientId}/documents` on mount
- Fetch document counts from `GET /api/clients/${clientId}/documents/counts`
- Fetch client's policies from existing API (for folder names): `GET /api/clients/${clientId}/policies` (this data may already be available from the parent page -- accept as prop if convenient, or re-fetch)
- State: `selectedFolder: string | null` (null = root/folder view)
- Layout:
  - Upload zone at top (DocumentUploadZone) -- opens DocumentUploadDialog when files selected
  - DocumentFolderView below (showing folders when no folder selected)
  - DocumentList when a folder IS selected (filtered to that policyId or null for General)
  - DocumentPreviewModal (controlled by state)
- Upload flow: files selected -> open upload dialog with clientId + policyId (if in a policy folder) -> upload completes -> refresh document list
- Preview flow: click preview on document -> fetch signed URL from `/api/clients/${clientId}/documents/${docId}/url` -> open preview modal with URL
- Delete flow: click delete -> confirmation -> call `api.delete(/api/clients/${clientId}/documents/${docId})` -> refresh list -> toast success
- Download flow: click download -> fetch signed URL -> `window.open(url)` or create temporary `<a>` link

**2. Create `apps/web/src/components/clients/client-compliance-tab.tsx`:**

Per-client compliance activity log section for the client profile (per user decision: per-client compliance section on each client's profile).

Props: `clientId: string`

Implementation:
- Fetch compliance events from `GET /api/compliance?clientId=${clientId}&page=${page}&limit=20`
- Display as a simple chronological list (newest first) -- similar to the existing timeline but read-only
- Each entry shows: event type badge (color-coded by type), description, user name, timestamp (formatted with date-fns)
- Pagination at bottom (same pattern as other lists in the app)
- Empty state: "No compliance events for this client"
- This is a READ-ONLY view -- no editing, deleting, or annotating per user decision (immutable)
- Do NOT add filtering here -- the full filter UI is on the standalone /compliance page (Plan 04). This tab is a simple chronological view filtered to the client.

**3. Update `apps/web/src/app/(dashboard)/clients/[id]/page.tsx`:**

Replace the "Documents coming soon" placeholder with the real ClientDocumentsTab component. Add a new "Compliance" tab.

Changes:
- Import `ClientDocumentsTab` and `ClientComplianceTab`
- Replace the placeholder Card in the documents TabsContent with: `<ClientDocumentsTab clientId={id} />`
- Add a new TabsTrigger for "Compliance" and corresponding TabsContent: `<ClientComplianceTab clientId={id} />`
- Add the Tab after "Documents" tab

Updated tabs order: Overview | Policies | Timeline / Notes | Documents | Compliance

**4. Add document count badges to client list views:**

The backend now returns `documentCount` in the client list response (updated in Plan 04-02). Display it in the frontend:

- **`apps/web/src/components/clients/client-table.tsx`**: Add a "Docs" column showing the document count as a badge number. Use a small `FileText` icon with count: `<span className="flex items-center gap-1 text-xs text-muted-foreground"><FileText className="size-3" /> {client.documentCount}</span>`. Only show if documentCount > 0.

- **`apps/web/src/components/clients/client-cards.tsx`**: Add document count to the card metadata (next to policies count if it exists). Same small badge style.

- **`apps/web/src/components/clients/client-list.tsx`**: If this is a wrapper component, update any type definitions to include `documentCount` from the API response.

**5. Add document count badges to policy cards:**

- **`apps/web/src/components/policies/policy-cards.tsx`**: Add a document count indicator to each policy card. The backend now returns `_count.documents` in the policy list response (updated in Plan 04-02). Add a small doc count in the card content area: `<span className="flex items-center gap-1 text-xs text-muted-foreground"><FileText className="size-3" /> {policy._count?.documents ?? 0} docs</span>`. Only show if count > 0.

Note: The Policy type may need to be extended in the component's local interface to include `_count?: { documents: number }`. Use `Policy & { _count?: { documents: number } }` or update the PolicyCardsProps interface.
  </action>
  <verify>
Run `pnpm build` from monorepo root -- must succeed.
Verify client profile page at /clients/[id] shows Documents tab with folder view and upload zone.
Verify client profile page shows Compliance tab with activity log.
Verify client list table/cards show document count badges.
Verify policy cards show document count badges.
  </verify>
  <done>
Client profile Documents tab fully functional: upload zone, folder navigation (General + per-policy), document list with preview/download/delete, preview modal for PDFs and images. Client profile Compliance tab shows per-client activity events in chronological order. Document count badges visible on client list rows (table and card views) and policy cards. Full monorepo builds successfully.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with no errors
2. Client profile Documents tab shows folder-like navigation with General + policy folders
3. Drag-and-drop upload zone works with click-to-browse fallback
4. Multi-file upload dialog allows per-file category selection
5. PDF preview shows in iframe within dialog
6. Image preview shows in img tag within dialog
7. Word docs show "download only" message in preview
8. Delete confirms before removing document
9. Client list shows document count badges (from backend documentCount field)
10. Policy cards show document count badges (from backend _count.documents field)
11. Client profile Compliance tab shows per-client activity events
12. Compliance tab is read-only (no edit/delete buttons)
</verification>

<success_criteria>
- Documents tab replaces "coming soon" placeholder with full document management UI
- Folder navigation works: root shows folders, clicking folder shows its documents
- Upload works: drag-and-drop, click-to-browse, multi-file, per-file category
- Preview works: PDFs in iframe, images in img tag, others download-only
- Delete works: confirmation dialog, removes from list after delete
- Count badges visible on client list rows and policy cards
- Compliance tab shows per-client events chronologically
- All builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-documents-and-compliance/04-03-SUMMARY.md`
</output>
