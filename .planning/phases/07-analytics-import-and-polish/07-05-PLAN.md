---
phase: 07-analytics-import-and-polish
plan: 05
type: execute
wave: 4
depends_on: ["07-02", "07-03", "07-04"]
files_modified:
  - apps/web/src/app/(dashboard)/page.tsx
  - apps/web/src/app/(dashboard)/clients/page.tsx
  - apps/web/src/app/(dashboard)/policies/page.tsx
  - apps/web/src/app/(dashboard)/tasks/page.tsx
  - apps/web/src/app/(dashboard)/expenses/page.tsx
  - apps/web/src/app/(dashboard)/compliance/page.tsx
  - apps/web/src/app/(dashboard)/analytics/page.tsx
  - apps/web/src/app/(dashboard)/settings/import/page.tsx
  - packages/database/prisma/schema.prisma
autonomous: false

must_haves:
  truths:
    - "Dashboard loads within 2 seconds at 200-client scale"
    - "All pages load within 2 seconds at 200-client scale"
    - "All pages are usable on mobile screens"
    - "All pages have consistent loading states (skeleton screens)"
    - "All pages have consistent error handling and empty states"
    - "No UX inconsistencies across the application"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "New indexes for analytics query performance"
      contains: "@@index"
  key_links:
    - from: "packages/database/prisma/schema.prisma"
      to: "database"
      via: "prisma db push"
      pattern: "@@index"
---

<objective>
Performance optimization and UX polish across the entire application. Profile actual bottlenecks, add targeted optimizations, and ensure consistent mobile-responsive UX.

Purpose: Ensures the app meets the 2-second load target at 200-client scale and provides a polished, consistent experience on both desktop and mobile. This is the final polish pass before the MVP ships.
Output: Optimized queries, new database indexes, consistent loading/error/empty states, mobile-responsive layouts across all pages.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-analytics-import-and-polish/07-CONTEXT.md
@.planning/phases/07-analytics-import-and-polish/07-RESEARCH.md
@.planning/phases/07-analytics-import-and-polish/07-01-SUMMARY.md
@.planning/phases/07-analytics-import-and-polish/07-02-SUMMARY.md
@.planning/phases/07-analytics-import-and-polish/07-03-SUMMARY.md
@.planning/phases/07-analytics-import-and-polish/07-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Performance profiling and database/query optimization</name>
  <files>
    packages/database/prisma/schema.prisma
  </files>
  <action>
    LOCKED DECISION: Profile and identify specific bottlenecks rather than guessing. 2-second load target for ALL pages at 200-client scale.

    **Phase A: Profile (identify actual bottlenecks)**

    1. Review all API service files and identify potential slow queries:
       - Client list with policy counts and next renewal (likely N+1 or over-fetching)
       - Dashboard summary (4 parallel counts -- should be fast)
       - Analytics endpoints (multiple groupBy queries)
       - Policies page with client includes
       - Tasks page with client + policy includes
       - Compliance page with joins
       - Expense list with receipt includes

    2. For each endpoint, assess query pattern:
       - Does it use `include` to fetch more data than needed? Replace with `select` where possible.
       - Does it have N+1 patterns (loop with individual queries)? Batch with `_count` or `include`.
       - Does it fetch all records when only a page is needed? Ensure pagination is in place.
       - Does it use count()/aggregate()/groupBy() with correct tenantId in where?

    **Phase B: Add database indexes**

    3. Add missing indexes to `packages/database/prisma/schema.prisma`:
       - `@@index([tenantId, type])` on Policy model -- needed for policy type groupBy queries (analytics). RESEARCH.md confirmed this does NOT exist yet.
       - `@@index([tenantId, endDate])` on Policy model -- needed for renewal pipeline queries
       - Review other models: if any analytics query filters on a non-indexed field combination, add the index
       - IMPORTANT: Do NOT duplicate existing indexes. Check what already exists first.

    4. Run `pnpm --filter database exec prisma db push` to apply schema changes (per project convention -- no shadow DB migrations).

    **Phase C: Query optimizations**

    5. Optimize the identified slow queries:
       - Replace `include: { policies: true }` with `include: { _count: { select: { policies: true } } }` where only counts are needed (client list)
       - Add `select` clauses to limit fetched fields where full records aren't needed
       - Ensure all list endpoints have proper pagination (take/skip) with reasonable defaults
       - For analytics renewal pipeline: if the per-month individual queries are slow, consolidate to use fewer queries with date range grouping
       - Add `useMemo` to frontend chart data transformations to prevent unnecessary re-computation on re-renders
       - Verify PDF/jsPDF is dynamic-imported (not in main bundle)

    6. Apply any query optimizations directly to the relevant service files. Document what was changed and why.

    NOTE: If profiling reveals NO significant bottlenecks (everything already under 2s), that's a valid outcome. Document it. The goal is verified performance, not change for change's sake.
  </action>
  <verify>
    1. `pnpm --filter database exec prisma generate` succeeds after schema changes
    2. `pnpm --filter api build` passes after query optimizations
    3. `pnpm --filter web build` passes
    4. Schema has new indexes (grep for the added @@index lines)
    5. No N+1 query patterns remain in API service files
  </verify>
  <done>
    Database indexes added for analytics query patterns. Query optimizations applied to any identified bottlenecks. All builds pass. Performance profile documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile responsiveness and UX consistency audit</name>
  <files>
    apps/web/src/app/(dashboard)/page.tsx
    apps/web/src/app/(dashboard)/clients/page.tsx
    apps/web/src/app/(dashboard)/policies/page.tsx
    apps/web/src/app/(dashboard)/tasks/page.tsx
    apps/web/src/app/(dashboard)/expenses/page.tsx
    apps/web/src/app/(dashboard)/compliance/page.tsx
    apps/web/src/app/(dashboard)/analytics/page.tsx
    apps/web/src/app/(dashboard)/settings/import/page.tsx
  </files>
  <action>
    LOCKED DECISION: Must work on mobile -- all pages usable on mobile screens -- but desktop experience is primary and must not be compromised. Systematic UX audit.

    **Audit all pages systematically for these concerns:**

    1. **Loading states:** Every page that fetches data must show skeleton loading (using existing ui/skeleton.tsx). Check each page:
       - Dashboard (page.tsx) -- should have skeletons for each widget
       - Client list -- skeleton for table/cards
       - Policies list -- skeleton for table
       - Tasks list -- skeleton for table/kanban
       - Compliance -- skeleton for table
       - Expenses -- skeleton for table
       - Analytics -- each tab should have skeleton (verified in 07-02/07-03)
       - Import wizard -- loading state during import submission
       - If any page is missing skeleton loading, add it following the three-state pattern (loading/empty/data)

    2. **Empty states:** Every list/table must have a meaningful empty state (not just blank). Check each page:
       - Should show an icon + message like "No clients yet" with a CTA button when applicable
       - Analytics tabs should show "No data for the selected period" when no results
       - If any page has a blank/broken empty state, fix it

    3. **Error states:** API error handling should show toast or inline error message (using sonner). Check:
       - All api.get() calls should have .catch() handling
       - Errors should show user-friendly messages, not raw error objects

    4. **Mobile responsiveness audit** (check each page):
       - **Dashboard:** Summary cards should stack (grid-cols-1 on mobile, 2 on sm, 4 on lg). Widgets should stack vertically.
       - **Client list:** Table should have horizontal scroll wrapper (`overflow-x-auto`). Card view should be single column.
       - **Policies list:** Table with horizontal scroll. Filters should stack vertically on mobile.
       - **Tasks list:** Kanban board should stack columns vertically or offer list-only view on mobile. Table with horizontal scroll.
       - **Compliance:** Table with horizontal scroll. Filters should wrap.
       - **Expenses:** Table with horizontal scroll. Form dialog should be full-width on mobile.
       - **Analytics:** Tabs should scroll horizontally (verified in 07-02). Charts should reduce height on mobile. Summary card grids should stack.
       - **Import wizard:** Steps should be single column. Table preview should have horizontal scroll.
       - **Settings pages:** Sub-nav tabs should scroll horizontally if needed.

    5. **Form validation consistency:** Check all forms use the same pattern:
       - Zod validation with zodResolver
       - Error messages displayed below inputs consistently
       - Submit buttons show loading state during submission

    6. **Visual consistency:**
       - All page headers should use the same typography (h1/h2 with consistent sizing)
       - All action buttons should use consistent variants (primary for main action, outline for secondary)
       - All tables should use the same styling pattern
       - All card components should have consistent border-radius, shadow, padding

    For each issue found, fix it directly. Keep changes minimal and targeted -- this is polish, not a redesign.

    NOTE: Desktop experience must NOT be compromised by mobile fixes. Use responsive Tailwind classes (sm:, md:, lg:) to differentiate.
  </action>
  <verify>
    1. `pnpm --filter web build` passes after all changes
    2. Every page has loading skeletons during data fetch
    3. Every list has a meaningful empty state
    4. All tables have horizontal scroll wrappers for mobile
    5. Summary card grids use responsive grid-cols
    6. No page breaks or overflows on 375px viewport width
    7. Desktop layout unchanged at 1280px viewport width
  </verify>
  <done>
    All pages audited and polished: consistent loading skeletons, meaningful empty states, error handling, mobile-responsive layouts, and visual consistency. Desktop experience preserved. Mobile usable across all pages.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 7 delivery:
    - Analytics page with 7 tabs (Overview, Clients, Policies, Renewals, Expenses, Compliance, Cross-Sell)
    - Charts: policy type donut, renewal pipeline stacked bar, expense donut, compliance bar, premium bar
    - CSV/PDF export on all analytics tabs
    - Time range filtering (3mo/6mo/YTD/12mo/All)
    - Cross-sell intelligence with summary cards and detail table
    - Cross-sell badge on client profiles
    - CSV import wizard (Upload -> Map -> Preview -> Import -> Summary)
    - Template download for CSV import
    - Performance optimization (indexes, query optimization)
    - Mobile responsive and UX polish across all pages
  </what-built>
  <how-to-verify>
    Start both servers:
    ```
    pnpm --filter api dev
    pnpm --filter web dev
    ```

    **Analytics verification:**
    1. Navigate to /analytics from sidebar -- page loads with tabs
    2. Check Overview tab: 4 summary cards + policy distribution donut chart
    3. Check Policies tab: donut chart + premium bar chart + detail table
    4. Check Renewals tab: stacked bar chart with monthly data
    5. Check Expenses tab: expense donut + stat cards
    6. Check Compliance tab: event type chart + user activity table
    7. Check Cross-Sell tab: summary cards with gap counts + detail table (view-only)
    8. Change time range selector -- data should refresh across tabs
    9. Click "Export CSV" on any tab -- downloads .csv file
    10. Click "Export PDF" on any tab -- downloads .pdf file

    **Cross-sell badge:**
    11. Go to a client profile (/clients/[id]) for a client with policies -- check for coverage gap badge/indicator

    **CSV Import verification:**
    12. Go to /settings/import -- wizard page loads
    13. Download template -- check CSV has headers and example rows
    14. Upload a CSV file -- rows parsed and count shown
    15. Column mapping: auto-detected columns shown, can adjust manually
    16. Preview: rows displayed, errors highlighted if any
    17. Click Import -- results shown with counts

    **Mobile:**
    18. Resize browser to 375px width -- all pages should be usable
    19. Check analytics tabs scroll horizontally
    20. Check tables have horizontal scroll

    **Performance:**
    21. Navigate between pages -- each should load within 2 seconds (subjective check)
  </how-to-verify>
  <resume-signal>Type "approved" to mark Phase 7 complete, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm --filter database exec prisma generate` succeeds
2. `pnpm --filter api build` passes
3. `pnpm --filter web build` passes
4. New database indexes exist in schema.prisma
5. All pages have loading skeletons, empty states, and error handling
6. Mobile responsive: no overflows at 375px width
7. Desktop layout preserved at 1280px width
8. Analytics page has 7 fully populated tabs
9. Import wizard completes full flow
10. Human verification checkpoint passed
</verification>

<success_criteria>
- All pages load within 2 seconds at 200-client scale (database indexes + query optimizations applied)
- All pages usable on mobile screens (375px width) without breaking desktop layout
- Consistent loading skeletons across all pages
- Consistent empty states with meaningful messages
- Consistent error handling with toast notifications
- Visual consistency (typography, buttons, cards, tables)
- Human verification passed for analytics, import, and overall polish
</success_criteria>

<output>
After completion, create `.planning/phases/07-analytics-import-and-polish/07-05-SUMMARY.md`
</output>
