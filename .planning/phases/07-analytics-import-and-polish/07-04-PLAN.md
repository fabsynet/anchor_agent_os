---
phase: 07-analytics-import-and-polish
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/web/src/app/(dashboard)/settings/import/page.tsx
  - apps/web/src/components/import/import-wizard.tsx
  - apps/web/src/components/import/file-upload-step.tsx
  - apps/web/src/components/import/column-mapping-step.tsx
  - apps/web/src/components/import/preview-step.tsx
  - apps/web/src/components/import/import-summary.tsx
  - apps/web/src/components/settings/settings-nav.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to import page from Settings sub-nav"
    - "User can upload a CSV file and see parsed results in the wizard"
    - "User can map CSV columns to expected fields with auto-detection"
    - "User can preview rows with errors highlighted before committing"
    - "User can fix or skip individual error rows inline"
    - "User can download a CSV template with expected headers and example rows"
    - "After import, user sees a summary with counts of created/skipped/duplicate/error records"
  artifacts:
    - path: "apps/web/src/components/import/import-wizard.tsx"
      provides: "Multi-step wizard container managing 4 steps"
      min_lines: 60
    - path: "apps/web/src/components/import/file-upload-step.tsx"
      provides: "File upload with PapaParse parsing"
      min_lines: 50
    - path: "apps/web/src/components/import/column-mapping-step.tsx"
      provides: "Column mapping with auto-detect and manual adjust"
      min_lines: 80
    - path: "apps/web/src/components/import/preview-step.tsx"
      provides: "Row preview with error highlighting and inline edit/skip"
      min_lines: 100
    - path: "apps/web/src/components/import/import-summary.tsx"
      provides: "Import results summary with counts"
      min_lines: 40
  key_links:
    - from: "apps/web/src/components/import/file-upload-step.tsx"
      to: "papaparse"
      via: "Client-side CSV parsing"
      pattern: "Papa\\.parse"
    - from: "apps/web/src/components/import/preview-step.tsx"
      to: "/api/import/clients-policies"
      via: "POST validated rows"
      pattern: "api\\.post.*import"
    - from: "apps/web/src/components/settings/settings-nav.tsx"
      to: "/settings/import"
      via: "Settings sub-nav tab"
      pattern: "import"
---

<objective>
Build the CSV import wizard for bulk client+policy data import with column mapping, error handling, and duplicate detection.

Purpose: Enables agents to import their existing book of business from other systems via CSV. The wizard approach (upload -> map -> preview -> commit) gives agents confidence and control over the import process.
Output: Working /settings/import page with 4-step wizard, template download, and import execution with summary.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-analytics-import-and-polish/07-CONTEXT.md
@.planning/phases/07-analytics-import-and-polish/07-RESEARCH.md
@.planning/phases/07-analytics-import-and-polish/07-01-SUMMARY.md
@apps/web/src/components/settings/settings-nav.tsx
@apps/web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import wizard - file upload and column mapping steps</name>
  <files>
    apps/web/src/app/(dashboard)/settings/import/page.tsx
    apps/web/src/components/import/import-wizard.tsx
    apps/web/src/components/import/file-upload-step.tsx
    apps/web/src/components/import/column-mapping-step.tsx
    apps/web/src/components/settings/settings-nav.tsx
  </files>
  <action>
    1. Update `apps/web/src/components/settings/settings-nav.tsx`:
       - Add 'Import' tab to SETTINGS_TABS array: `{ label: 'Import', href: '/settings/import' }`
       - Position after Badge tab

    2. Create `apps/web/src/app/(dashboard)/settings/import/page.tsx`:
       - 'use client' page component
       - Renders SettingsNav at top (same pattern as other settings pages)
       - Page title "Import Clients & Policies"
       - Brief description: "Import your existing book of business from a CSV file. One row per policy -- clients are automatically deduplicated."
       - Template download link: Button that calls `GET /import/template` and triggers download. Use an anchor tag with href or fetch + blob download.
       - Renders ImportWizard component below

    3. Create `apps/web/src/components/import/import-wizard.tsx`:
       - 'use client' component
       - State management for 4-step wizard:
         - `step`: 1 (upload) | 2 (mapping) | 3 (preview) | 4 (summary)
         - `rawRows`: Record<string, string>[] (parsed CSV rows)
         - `headers`: string[] (CSV column headers)
         - `columnMapping`: Record<string, string> (expected field key -> CSV header name)
         - `mappedRows`: ImportRow[] (rows after applying column mapping)
         - `importResult`: ImportResult | null (after submission)
         - `errors`: parse errors from PapaParse
       - Step indicator bar at top: numbered steps with labels (Upload, Map Columns, Preview, Summary). Active step highlighted, completed steps show checkmark. Use Tailwind flexbox with circles and connecting lines.
       - Renders current step component with appropriate props
       - Back/Next buttons at bottom (except step 1 which has no Back, step 4 which has no Next)
       - "Start Over" button on step 4 to reset wizard

    4. Create `apps/web/src/components/import/file-upload-step.tsx`:
       - 'use client' component
       - Props: `onComplete(rows: Record<string, string>[], headers: string[], errors: any[])` callback
       - Drop zone with dashed border: accept .csv files only. Use native `<input type="file" accept=".csv">`
       - On file select: use PapaParse to parse:
         ```
         Papa.parse(file, {
           header: true,
           skipEmptyLines: true,
           complete: (results) => { onComplete(results.data, results.meta.fields, results.errors) }
         })
         ```
       - Show file name and row count after parsing: "Parsed 150 rows from clients-export.csv"
       - Show parse errors if any (PapaParse level errors like malformed CSV)
       - Auto-advance to step 2 after successful parse OR user clicks Next

    5. Create `apps/web/src/components/import/column-mapping-step.tsx`:
       - 'use client' component
       - Props: `headers: string[]`, `initialMapping: Record<string, string>`, `onComplete(mapping: Record<string, string>)` callback
       - LOCKED DECISION: Auto-detect from headers + manual adjust before import
       - Auto-detect logic (run on mount):
         - For each expected field (from IMPORT_EXPECTED_FIELDS constant or inline list), fuzzy match against CSV headers
         - Fuzzy match: normalize both sides (lowercase, remove underscores/hyphens/spaces) and check equality OR substring inclusion
         - Example: CSV header "First Name" matches expected field key "firstName" because normalized "firstname" === "firstname"
         - Example: CSV header "policy_type" matches "policyType" because normalized "policytype" === "policytype"
       - Render a 2-column layout:
         - Left column: Expected field name + required indicator (red asterisk)
         - Right column: Select dropdown populated with CSV headers + "-- Skip --" option
         - Pre-selected based on auto-detection results
       - Validation: all required fields (firstName, lastName, policyType) must be mapped. Show error if not.
       - User can manually change any mapping via the Select dropdowns
       - "Apply Mapping" button calls onComplete with final mapping
  </action>
  <verify>
    1. `pnpm --filter web build` passes
    2. Settings nav shows "Import" tab
    3. /settings/import page loads with wizard step 1
    4. Upload a .csv file -- PapaParse parses and shows row count
    5. Step 2 shows auto-detected column mapping with dropdowns
  </verify>
  <done>
    Import wizard steps 1 and 2 work: CSV file upload with PapaParse parsing, auto-detected column mapping with manual adjustment via Select dropdowns. Settings nav includes Import tab. Template download button present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Import wizard - preview, submission, and summary steps</name>
  <files>
    apps/web/src/components/import/preview-step.tsx
    apps/web/src/components/import/import-summary.tsx
    apps/web/src/components/import/import-wizard.tsx
  </files>
  <action>
    1. Create `apps/web/src/components/import/preview-step.tsx`:
       - 'use client' component
       - Props: `rawRows: Record<string, string>[]`, `columnMapping: Record<string, string>`, `onComplete(result: ImportResult)` callback
       - On mount or when props change: apply column mapping to rawRows to produce mappedRows
         - For each rawRow, create ImportRow by reading rawRow[mapping[fieldKey]] for each expected field
         - Apply lenient policy type mapping (use IMPORT_POLICY_TYPE_MAP from shared constants or inline): if policyType value is 'automobile', map to 'auto', etc.
       - LOCKED DECISION: Preview all rows with errors highlighted, user can fix inline or skip individual rows
       - Validation per row:
         - firstName and lastName must be non-empty
         - policyType must resolve to a valid PolicyType after lenient mapping (if unrecognized after mapping, it becomes 'other' with a warning, not an error)
         - email must be valid format if provided
         - premium must be a valid number if provided
         - startDate/endDate must be parseable dates if provided
       - Render a scrollable table (max-height with overflow-y-auto) showing all rows:
         - Columns: Row #, First Name, Last Name, Email, Policy Type (show mapped value), Carrier, Premium, Status (valid/warning/error icon), Actions
         - Error rows: highlighted with red/pink background, error message in tooltip or inline text
         - Warning rows: highlighted with yellow/amber background (e.g., unrecognized policy type mapped to 'other')
         - Valid rows: no highlight
       - LOCKED DECISION: User can fix inline or skip individual rows
         - "Skip" button per row: removes row from import (crossed out or removed from list)
         - Inline edit: click on a cell to edit its value (use contentEditable or input overlay). At minimum support editing firstName, lastName, email, policyType, premium.
         - Alternatively, simpler approach: "Edit" button opens a small form/dialog for that row's fields. Use a dialog or inline expandable row.
         - Pick the simpler approach: per-row "Edit" button that expands an inline edit form below the row
       - Stats bar at top: "X valid, Y warnings, Z errors, W skipped"
       - "Import" button (primary, only enabled if at least 1 valid row exists)
       - On "Import" click:
         - Filter out skipped rows
         - POST to `/import/clients-policies` with `{ rows: validMappedRows }` via api.post
         - Show loading spinner during submission
         - On success: call onComplete with ImportResult
         - On error: show toast error message

    2. Create `apps/web/src/components/import/import-summary.tsx`:
       - 'use client' component
       - Props: `result: ImportResult`
       - LOCKED DECISION: Show flagged duplicates in import summary so agent can handle manually
       - Top: Success banner with checkmark icon: "Import Complete"
       - Summary cards in grid:
         - Clients Created: result.clientsCreated (green)
         - Policies Created: result.policiesCreated (green)
         - Duplicates Skipped: result.duplicatesSkipped (amber)
         - Errors: result.errors.length (red, or green 0 if none)
       - If duplicates exist: "Duplicate Clients" section with a table showing duplicate name, email, and existing client ID (link to /clients/[existingId])
       - If errors exist: "Import Errors" section with a table showing row number and error message
       - Bottom: "Import Another File" button (resets wizard to step 1), "Go to Clients" link button

    3. Update `apps/web/src/components/import/import-wizard.tsx` (if needed):
       - Ensure step transitions are wired:
         - Step 1 complete -> step 2 (with rawRows, headers)
         - Step 2 complete -> step 3 (with columnMapping added)
         - Step 3 complete -> step 4 (with importResult)
         - Step 4 "Start Over" -> step 1 (reset all state)
       - The mapped rows transformation happens inside preview-step, not in the wizard (to keep wizard lean)
  </action>
  <verify>
    1. `pnpm --filter web build` passes
    2. Full wizard flow: upload CSV -> map columns -> preview rows with validation -> import -> see summary
    3. Error rows are highlighted and can be skipped
    4. Import submits to API and receives result
    5. Summary shows created/skipped/duplicate/error counts
    6. Duplicate clients link to their profile pages
    7. "Import Another File" resets wizard
  </verify>
  <done>
    Complete 4-step import wizard: (1) CSV upload with PapaParse, (2) auto-detected column mapping with manual adjust, (3) row preview with error highlighting, inline edit, skip, and import execution, (4) results summary showing created/skipped/duplicates/errors. Duplicates link to existing client profiles. Template download available. Accessible from /settings/import.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` passes
2. Settings nav shows "Import" tab linking to /settings/import
3. Template download link triggers .csv file download with headers + example rows
4. Wizard step 1: upload .csv, see parsed row count
5. Wizard step 2: auto-detected mapping shown, can manually adjust via dropdowns
6. Wizard step 3: rows displayed in scrollable table, errors highlighted, can skip/edit rows
7. Wizard step 3: "Import" button sends valid rows to API
8. Wizard step 4: summary shows clientsCreated, policiesCreated, duplicatesSkipped, errors
9. Wizard step 4: duplicate clients link to their profile pages
10. "Import Another File" resets wizard to step 1
</verification>

<success_criteria>
- CSV import wizard accessible from /settings/import
- 4-step flow: Upload -> Map Columns -> Preview -> Summary
- Auto-detect column mapping with fuzzy header matching
- Lenient policy type mapping (automobile->auto, house->home, etc.)
- Error/warning highlighting with inline edit and skip per row
- Import results show created/skipped/duplicate/error counts
- Duplicate clients link to existing profiles for manual review
- Template download available with expected headers and example data
</success_criteria>

<output>
After completion, create `.planning/phases/07-analytics-import-and-polish/07-04-SUMMARY.md`
</output>
