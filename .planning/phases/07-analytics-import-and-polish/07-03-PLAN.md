---
phase: 07-analytics-import-and-polish
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - apps/web/src/components/analytics/analytics-renewals-tab.tsx
  - apps/web/src/components/analytics/analytics-expenses-tab.tsx
  - apps/web/src/components/analytics/analytics-compliance-tab.tsx
  - apps/web/src/components/analytics/analytics-crosssell-tab.tsx
  - apps/web/src/app/(dashboard)/analytics/page.tsx
  - apps/web/src/app/(dashboard)/clients/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a renewal pipeline stacked bar chart by month on the Renewals tab"
    - "User can view expense summary with category donut and budget-vs-actual on Expenses tab"
    - "User can view compliance event summary with activity counts on Compliance tab"
    - "User can view cross-sell opportunities with summary cards and detail table on Cross-Sell tab"
    - "User can see a cross-sell badge/indicator on individual client profiles showing coverage gaps"
    - "All 7 analytics tabs are fully populated -- no more placeholders"
  artifacts:
    - path: "apps/web/src/components/analytics/analytics-renewals-tab.tsx"
      provides: "Renewal pipeline stacked bar chart + upcoming renewals list"
      min_lines: 80
    - path: "apps/web/src/components/analytics/analytics-crosssell-tab.tsx"
      provides: "Cross-sell summary cards + detail table with coverage gaps"
      min_lines: 100
    - path: "apps/web/src/components/analytics/analytics-expenses-tab.tsx"
      provides: "Expense donut, trend, budget vs actual"
      min_lines: 80
    - path: "apps/web/src/components/analytics/analytics-compliance-tab.tsx"
      provides: "Compliance event counts and user activity summary"
      min_lines: 60
  key_links:
    - from: "apps/web/src/components/analytics/analytics-renewals-tab.tsx"
      to: "/api/analytics/renewal-pipeline"
      via: "API fetch"
      pattern: "api\\.get.*renewal-pipeline"
    - from: "apps/web/src/components/analytics/analytics-crosssell-tab.tsx"
      to: "/api/analytics/cross-sell"
      via: "API fetch"
      pattern: "api\\.get.*cross-sell"
    - from: "apps/web/src/app/(dashboard)/clients/[id]/page.tsx"
      to: "/api/analytics/cross-sell"
      via: "Client-specific cross-sell badge"
      pattern: "cross-sell"
---

<objective>
Complete the remaining 4 analytics tabs (Renewals, Expenses, Compliance, Cross-Sell) and add the cross-sell badge to individual client profiles.

Purpose: Finishes the full analytics experience. The renewal pipeline stacked bar chart and cross-sell intelligence are the most impactful analytical views -- they directly answer "which renewals are coming up?" and "which clients could buy more?"
Output: All 7 analytics tabs fully populated. Cross-sell badge visible on client profile pages. No placeholder content remains.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-analytics-import-and-polish/07-CONTEXT.md
@.planning/phases/07-analytics-import-and-polish/07-RESEARCH.md
@.planning/phases/07-analytics-import-and-polish/07-01-SUMMARY.md
@.planning/phases/07-analytics-import-and-polish/07-02-SUMMARY.md
@apps/web/src/app/(dashboard)/analytics/page.tsx
@apps/web/src/components/analytics/chart-card.tsx
@apps/web/src/components/analytics/export-buttons.tsx
@apps/web/src/lib/export-utils.ts
@apps/web/src/app/(dashboard)/clients/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Renewals and Expenses analytics tabs</name>
  <files>
    apps/web/src/components/analytics/analytics-renewals-tab.tsx
    apps/web/src/components/analytics/analytics-expenses-tab.tsx
  </files>
  <action>
    1. Create `apps/web/src/components/analytics/analytics-renewals-tab.tsx`:
       - 'use client' component, props: startDate?: string, endDate?: string
       - Fetch `GET /analytics/renewal-pipeline` (no date params -- pipeline always shows last 12 months)
       - LOCKED DECISION: Renewal pipeline must be a **stacked bar chart** with active/expiring/expired segments
       - Use Recharts BarChart with 3 stacked Bar components (stackId="a"):
         - Bar dataKey="active" fill={hsl(var(--chart-1))} name="Active"
         - Bar dataKey="expiring" fill={hsl(var(--chart-2))} name="Expiring"
         - Bar dataKey="expired" fill={hsl(var(--chart-3))} name="Expired"
       - CartesianGrid with strokeDasharray="3 3" className="stroke-muted"
       - XAxis dataKey="month", YAxis, both with className="text-xs"
       - Tooltip with popover-styled content (backgroundColor hsl(var(--popover)), border hsl(var(--border)), borderRadius var(--radius))
       - Legend component
       - Wrap in ResponsiveContainer width="100%" height={350} (200 on mobile via css or responsive prop)
       - Wrap chart in ChartCard with title "Renewal Pipeline" description "Monthly view of policy lifecycle status"
       - Below chart: summary row showing totals (total active, total expiring, total expired across all months)
       - ExportButtons: CSV exports month-by-month data, PDF exports pipeline table
       - Three-state pattern (loading skeleton, empty, data)

    2. Create `apps/web/src/components/analytics/analytics-expenses-tab.tsx`:
       - 'use client' component, props: startDate?: string, endDate?: string
       - Fetch `GET /analytics/expense-summary?startDate=X&endDate=Y`
       - Top: 3 stat cards: Total Approved (CAD), Total Pending (CAD), Budget Usage (percentage or "No budget set")
       - Middle-left: Expense by category donut chart (follow exact expense-donut-chart.tsx pattern from Phase 5). Use PieChart with innerRadius/outerRadius for donut style. HSL chart colors.
       - Middle-right: Budget vs Actual comparison. If budgetUsage is available, show a simple bar or progress indicator. If no budget, show "No budget set for current period".
       - Bottom: Category breakdown table: category, amount, percentage of total. Simple HTML table.
       - ExportButtons for expense summary data
       - Three-state pattern
  </action>
  <verify>
    Run `pnpm --filter web build` to verify both components compile. Renewals tab shows stacked bar chart. Expenses tab shows donut chart and stat cards.
  </verify>
  <done>
    Renewals tab renders stacked bar chart with 12 months of active/expiring/expired data. Expenses tab renders donut chart by category, stat cards, and budget usage. Both tabs use three-state loading pattern, HSL chart colors, and have CSV/PDF export buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Compliance, Cross-Sell tabs and client profile cross-sell badge</name>
  <files>
    apps/web/src/components/analytics/analytics-compliance-tab.tsx
    apps/web/src/components/analytics/analytics-crosssell-tab.tsx
    apps/web/src/app/(dashboard)/analytics/page.tsx
    apps/web/src/app/(dashboard)/clients/[id]/page.tsx
  </files>
  <action>
    1. Create `apps/web/src/components/analytics/analytics-compliance-tab.tsx`:
       - 'use client' component, props: startDate?: string, endDate?: string
       - Fetch `GET /analytics/compliance-summary?startDate=X&endDate=Y`
       - Top: Total Events stat card
       - Middle: Activity events by type horizontal bar chart (BarChart layout="vertical" from Recharts). Each bar = event type, value = count. HSL chart colors.
       - Bottom: Per-user activity summary table: userName, event count. Simple HTML table sorted by count descending.
       - ExportButtons for compliance data
       - Three-state pattern

    2. Create `apps/web/src/components/analytics/analytics-crosssell-tab.tsx`:
       - 'use client' component (no date range props -- cross-sell is based on current active policies, not historical)
       - Fetch `GET /analytics/cross-sell`
       - LOCKED DECISION: Summary cards at top showing counts per gap type
         - Aggregate the results: count clients missing each policy type (e.g., "12 clients missing Home", "8 clients missing Life")
         - Render as cards in grid: `grid-cols-1 sm:grid-cols-2 lg:grid-cols-3`
         - Each card: icon for the policy type (from POLICY_TYPES constant), count, "clients missing [Type]"
         - Also show a card for "Clients with < 2 policy types" count
       - LOCKED DECISION: Detail table below with all clients and their coverage gaps
         - Columns: Client Name (link to profile), Active Policy Types (badges/chips), Missing Types (red badges), # Policies
         - Sortable by client name or number of gaps
         - Use a proper table with `overflow-x-auto` wrapper for mobile
         - View-only -- NO action buttons per user decision
       - ExportButtons for cross-sell data
       - Three-state pattern

    3. Update `apps/web/src/app/(dashboard)/analytics/page.tsx`:
       - Replace all 4 placeholder "Coming soon" TabsContent with the real tab component imports:
         - Import AnalyticsRenewalsTab, AnalyticsExpensesTab, AnalyticsComplianceTab, AnalyticsCrossSellTab
         - Pass startDate/endDate props (except CrossSell which takes no date props)
       - Verify all 7 tabs are now fully wired

    4. Add cross-sell badge to client profile page `apps/web/src/app/(dashboard)/clients/[id]/page.tsx`:
       - LOCKED DECISION: Show a small cross-sell badge/indicator on individual client profiles
       - Add a new small component (inline or extracted) that fetches cross-sell data for a specific client:
         - Fetch `GET /analytics/cross-sell` and filter results for this clientId
         - OR: add the client-level cross-sell check inline (check client's policies against CROSS_SELL_BUNDLES locally on the frontend, using the policies already fetched for the profile page)
         - PREFERRED approach: Use the policies already loaded on the client profile page. Import CROSS_SELL_BUNDLES from shared constants (or define inline). Check if client has coverage gaps. This avoids an extra API call.
       - Display: Small badge/chip near the client name or in the profile header area. Example: orange/amber badge saying "Coverage Gaps: Home, Life" or a tooltip icon if no gaps exist, show nothing.
       - Only show if the client has status='client' (not leads) and has at least one active policy
       - Keep it subtle -- a small indicator, not a large section
  </action>
  <verify>
    1. `pnpm --filter web build` passes
    2. All 7 analytics tabs show real content (no placeholders)
    3. Renewals tab has stacked bar chart
    4. Cross-Sell tab has summary cards with gap counts and detail table
    5. Client profile page shows cross-sell badge when client has coverage gaps
    6. All tabs have working CSV/PDF export buttons
  </verify>
  <done>
    All 7 analytics tabs fully populated: Overview, Clients, Policies, Renewals, Expenses, Compliance, Cross-Sell. Cross-sell tab shows summary cards with gap counts and a detail table of all clients with coverage gaps (view-only). Client profile pages show a small cross-sell badge/indicator when coverage gaps exist. No placeholder content remains on the analytics page.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` passes
2. All 7 /analytics tabs render content (no "Coming soon" placeholders)
3. Renewals tab: stacked bar chart with active/expiring/expired segments per month
4. Expenses tab: donut chart by category, stat cards, budget usage indicator
5. Compliance tab: event type bar chart, per-user activity table
6. Cross-Sell tab: summary cards with gap counts, detail table with all clients and their gaps, view-only
7. Client profile /clients/[id]: cross-sell badge visible when client has coverage gaps
8. CSV/PDF export works on all 4 new tabs
9. Charts use HSL CSS variable colors for dark mode support
</verification>

<success_criteria>
- Renewals tab: stacked bar chart showing 12-month renewal pipeline (active vs expiring vs expired)
- Expenses tab: expense donut by category, stat cards, budget comparison
- Compliance tab: event type breakdown chart, per-user activity summary
- Cross-Sell tab: summary cards counting clients missing each policy type + detail table with all gap data
- Cross-sell badge visible on client profile pages showing specific coverage gaps
- All analytics tabs have working CSV and PDF export
- Zero placeholder content on analytics page
</success_criteria>

<output>
After completion, create `.planning/phases/07-analytics-import-and-polish/07-03-SUMMARY.md`
</output>
