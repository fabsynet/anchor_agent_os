---
phase: 07-analytics-import-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/web/src/app/(dashboard)/analytics/page.tsx
  - apps/web/src/components/analytics/time-range-selector.tsx
  - apps/web/src/components/analytics/chart-card.tsx
  - apps/web/src/components/analytics/export-buttons.tsx
  - apps/web/src/components/analytics/analytics-overview-tab.tsx
  - apps/web/src/components/analytics/analytics-clients-tab.tsx
  - apps/web/src/components/analytics/analytics-policies-tab.tsx
  - apps/web/src/lib/export-utils.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to /analytics from the sidebar"
    - "User can switch between analytics tabs (Overview, Clients, Policies visible)"
    - "User can change time range and all tab data refreshes"
    - "User sees donut chart for policy type breakdown on Policies tab"
    - "User can export any report as CSV or PDF"
    - "Overview tab shows summary cards with key metrics and charts"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/analytics/page.tsx"
      provides: "Analytics page with 7 Radix tabs"
      min_lines: 60
    - path: "apps/web/src/components/analytics/time-range-selector.tsx"
      provides: "Shared time range picker with 3mo/6mo/YTD/12mo/All presets"
      exports: ["TimeRangeSelector"]
    - path: "apps/web/src/lib/export-utils.ts"
      provides: "CSV and PDF export utility functions"
      exports: ["exportToCsv", "exportToPdf"]
    - path: "apps/web/src/components/analytics/analytics-overview-tab.tsx"
      provides: "Overview tab with summary cards and charts"
      min_lines: 80
    - path: "apps/web/src/components/analytics/analytics-policies-tab.tsx"
      provides: "Policies tab with donut chart and premium table"
      min_lines: 80
  key_links:
    - from: "apps/web/src/app/(dashboard)/analytics/page.tsx"
      to: "components/analytics/*-tab.tsx"
      via: "Radix Tabs TabsContent imports"
      pattern: "TabsContent"
    - from: "apps/web/src/components/analytics/analytics-overview-tab.tsx"
      to: "/api/analytics/overview"
      via: "API fetch with auth"
      pattern: "api\\.get.*analytics/overview"
    - from: "apps/web/src/lib/export-utils.ts"
      to: "papaparse"
      via: "CSV generation"
      pattern: "Papa\\.unparse"
---

<objective>
Build the analytics page shell with time range selector, export utilities, and the first 3 tab implementations (Overview, Clients, Policies).

Purpose: Establishes the analytics page structure, shared components (time range, chart card, export), and delivers the most critical analytics views -- overview metrics, client breakdown, and policy type analysis with donut/pie chart.
Output: Working /analytics page with 3 populated tabs and CSV/PDF export capability.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-analytics-import-and-polish/07-CONTEXT.md
@.planning/phases/07-analytics-import-and-polish/07-RESEARCH.md
@.planning/phases/07-analytics-import-and-polish/07-01-SUMMARY.md
@apps/web/src/app/(dashboard)/expenses/page.tsx
@apps/web/src/components/expenses/expense-donut-chart.tsx
@apps/web/src/components/dashboard/financial-widget.tsx
@apps/web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create shared analytics components</name>
  <files>
    apps/web/src/components/analytics/time-range-selector.tsx
    apps/web/src/components/analytics/chart-card.tsx
    apps/web/src/components/analytics/export-buttons.tsx
    apps/web/src/lib/export-utils.ts
  </files>
  <action>
    1. Install new web dependencies:
       ```
       pnpm --filter web add papaparse jspdf jspdf-autotable
       pnpm --filter web add -D @types/papaparse
       ```

    2. Create `apps/web/src/lib/export-utils.ts`:
       - `exportToCsv(data: Record<string, any>[], filename: string)`: Use PapaParse `Papa.unparse(data)`, create Blob with 'text/csv;charset=utf-8;', create download link, trigger click, revoke URL. Follow RESEARCH.md Pattern 4.
       - `exportToPdf(title: string, columns: string[], rows: (string | number)[][], filename: string)`: Use DYNAMIC imports: `const { default: jsPDF } = await import('jspdf')` and `const { default: autoTable } = await import('jspdf-autotable')`. This is critical to avoid bundle bloat per Pitfall 6. Create doc, add title (fontSize 16), add generated date (fontSize 10, 'en-CA' locale), call autoTable with head/body, headStyles fillColor [15, 23, 42] (slate-900), save. Follow RESEARCH.md Pattern 4.
       - Both functions are async (PDF uses dynamic import).

    3. Create `apps/web/src/components/analytics/time-range-selector.tsx`:
       - 'use client' component
       - Props: `value: TimeRange`, `onChange: (range: TimeRange) => void`
       - Import TimeRange type from @anchor/shared (or define locally if shared import has issues)
       - Render a button group (not Select -- buttons are faster to scan): 5 buttons for '3 Months', '6 Months', 'YTD', '12 Months', 'All Time'
       - Use existing Button component with variant="outline" for unselected, variant="default" for selected
       - On mobile: horizontal scroll with `overflow-x-auto flex-nowrap` wrapper
       - Each button computes start/end dates using date-fns: subMonths(now, 3), subMonths(now, 6), startOfYear(now), subMonths(now, 12), null for 'all'
       - Export `getDateRange(range: TimeRange): { startDate: string; endDate: string } | null` helper function for consumers to compute dates

    4. Create `apps/web/src/components/analytics/chart-card.tsx`:
       - Reusable card wrapper for charts on the analytics page
       - Props: `title: string`, `description?: string`, `children: React.ReactNode`, `className?: string`
       - Renders a Card (from ui/card) with CardHeader (title + description) and CardContent (children)
       - Consistent padding and spacing

    5. Create `apps/web/src/components/analytics/export-buttons.tsx`:
       - 'use client' component
       - Props: `onExportCsv: () => void`, `onExportPdf: () => void`, `loading?: boolean`
       - Two buttons: "Export CSV" with Download icon, "Export PDF" with FileText icon
       - Use Button variant="outline" size="sm"
       - Stack vertically on mobile (flex-col sm:flex-row gap-2)
       - Show loading spinner on the active button during export
  </action>
  <verify>
    Run `pnpm --filter web build` to verify dependencies installed and components compile. Check that jspdf is NOT in the main bundle (it should only be dynamically imported).
  </verify>
  <done>
    PapaParse and jsPDF installed. Export utilities use dynamic import for PDF. TimeRangeSelector renders 5 preset buttons. ChartCard provides consistent chart wrapper. ExportButtons provide CSV/PDF download triggers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Analytics page with Overview, Clients, and Policies tabs</name>
  <files>
    apps/web/src/app/(dashboard)/analytics/page.tsx
    apps/web/src/components/analytics/analytics-overview-tab.tsx
    apps/web/src/components/analytics/analytics-clients-tab.tsx
    apps/web/src/components/analytics/analytics-policies-tab.tsx
  </files>
  <action>
    1. Create `apps/web/src/app/(dashboard)/analytics/page.tsx`:
       - 'use client' page component
       - State: `timeRange` (default '12mo'), computed startDate/endDate via getDateRange helper
       - Layout: Page title "Analytics" at top, TimeRangeSelector below title, then Radix Tabs below
       - Use Radix Tabs (TabsList, TabsTrigger, TabsContent) -- same pattern as client profile tabs
       - 7 tabs: Overview, Clients, Policies, Renewals, Expenses, Compliance, Cross-Sell
       - TabsList: `overflow-x-auto flex-nowrap` on mobile for horizontal scrolling
       - For tabs not yet built (Renewals, Expenses, Compliance, Cross-Sell), render a placeholder `<div className="py-12 text-center text-muted-foreground">Coming soon</div>`. These will be replaced in Plan 07-03.
       - Pass startDate, endDate as props to each tab component
       - Default to Overview tab

    2. Create `apps/web/src/components/analytics/analytics-overview-tab.tsx`:
       - 'use client' component, props: startDate?: string, endDate?: string
       - Fetch `GET /analytics/overview?startDate=X&endDate=Y` using api.get from lib/api.ts
       - Fetch `GET /analytics/policy-breakdown?startDate=X&endDate=Y` for the overview chart
       - Use three-state pattern (loading/empty/data) per established project convention:
         - Loading: Skeleton cards (4 in a row)
         - Empty: "No data for the selected period"
         - Data: render content
       - Top: 4 summary cards in `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4` layout:
         - Total Clients (with Users icon)
         - Active Policies (with Shield icon)
         - Total Premium YTD (with DollarSign icon, format as CAD currency using Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }))
         - Renewal Rate (with TrendingUp icon, show as percentage)
       - Bottom: Policy type breakdown as a donut/pie chart using Recharts PieChart (follow expense-donut-chart.tsx pattern EXACTLY). Use hsl(var(--chart-1)) through --chart-5 for colors. Wrap in ChartCard with title "Policy Distribution".
       - Add ExportButtons: CSV exports the overview stats + policy breakdown table data. PDF exports same as formatted table.

    3. Create `apps/web/src/components/analytics/analytics-clients-tab.tsx`:
       - 'use client' component, props: startDate?: string, endDate?: string
       - Fetch `GET /analytics/client-stats?startDate=X&endDate=Y`
       - Top: 4 stat cards: Total Clients, Active Clients, Leads, New This Period
       - Middle: Client growth line chart (if possible from data). If the API only returns aggregate counts (not monthly breakdown), show just the stat cards. A line chart for client growth would require a new endpoint -- skip for now and use stat cards only.
       - Bottom: ExportButtons for client stats
       - Use three-state pattern (loading/empty/data)

    4. Create `apps/web/src/components/analytics/analytics-policies-tab.tsx`:
       - 'use client' component, props: startDate?: string, endDate?: string
       - Fetch `GET /analytics/policy-breakdown?startDate=X&endDate=Y` AND `GET /analytics/premium-by-product?startDate=X&endDate=Y`
       - Top: Policy type breakdown donut chart (PieChart from Recharts, same as overview but larger). Wrap in ChartCard "Policy Types".
       - Middle: Premium by product line horizontal bar chart (BarChart with layout="vertical" from Recharts). Each bar = policy type, value = totalPremium. Format as CAD. Wrap in ChartCard "Premium by Product Line".
       - Bottom: Detail table showing type, count, totalPremium with sorting. Use a simple HTML table (not @tanstack/react-table -- overkill for 8 rows). If type='other', show customType breakdown sub-rows.
       - ExportButtons: CSV exports breakdown data, PDF exports with both charts as data tables + the detail table.
       - Use three-state pattern, HSL chart colors
  </action>
  <verify>
    1. `pnpm --filter web build` passes
    2. Navigate to /analytics -- page loads with tabs
    3. Overview tab shows 4 cards and donut chart (or skeleton/empty state if no data)
    4. Clients tab shows stat cards
    5. Policies tab shows donut chart, bar chart, and detail table
    6. CSV/PDF export buttons appear and are clickable on each tab
    7. Time range selector changes data across all tabs
  </verify>
  <done>
    /analytics page renders with 7 tabs (3 populated, 4 placeholder). TimeRangeSelector controls date filtering across all tabs. Overview shows summary cards + policy distribution donut. Clients shows stat cards. Policies shows donut chart + premium bar chart + detail table. CSV and PDF export works on all 3 tabs. All charts use HSL CSS variable colors. Mobile responsive with horizontal tab scrolling.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` passes with no errors
2. /analytics page accessible from sidebar navigation
3. 7 tabs rendered (3 with content, 4 with "Coming soon" placeholder)
4. TimeRangeSelector shows 5 preset options and updates data on change
5. Donut/pie chart renders on Overview and Policies tabs using Recharts
6. Bar chart renders on Policies tab using Recharts
7. Export CSV downloads a .csv file; Export PDF downloads a .pdf file
8. Charts use hsl(var(--chart-N)) CSS variables for dark mode support
9. Three-state loading pattern: skeletons during fetch, empty state when no data, content when data available
10. Mobile: tabs scroll horizontally, cards stack vertically, charts resize via ResponsiveContainer
</verification>

<success_criteria>
- Analytics page is live at /analytics with sidebar navigation link
- Overview tab: 4 summary metric cards + policy distribution donut chart
- Clients tab: 4 client stat cards with export
- Policies tab: policy type donut + premium bar chart + detail table with export
- Time range selector (3mo/6mo/YTD/12mo/All) filters data across all tabs
- CSV export generates downloadable .csv file with correct data
- PDF export generates downloadable .pdf file with formatted tables
- All charts use theme-aware CSS variable colors
</success_criteria>

<output>
After completion, create `.planning/phases/07-analytics-import-and-polish/07-02-SUMMARY.md`
</output>
