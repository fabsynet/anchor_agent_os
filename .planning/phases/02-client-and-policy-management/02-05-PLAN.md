---
phase: 02-client-and-policy-management
plan: 05
type: execute
wave: 4
depends_on: ["02-03", "02-04"]
files_modified:
  - apps/web/src/components/clients/client-policies-tab.tsx
  - apps/web/src/components/policies/policy-form.tsx
  - apps/web/src/components/policies/policy-cards.tsx
  - apps/web/src/components/policies/policy-table.tsx
  - apps/web/src/components/policies/policy-status-badge.tsx
  - apps/web/src/app/(dashboard)/clients/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can create a policy linked to a client from the Policies tab"
    - "User can edit and delete a policy"
    - "Policy form includes all detail fields (type, carrier, policy number, dates, premium, coverage, deductible, payment frequency, commission, notes)"
    - "Policy types include Canadian set (Auto, Home, Life, Health, Commercial, Travel, Umbrella) plus Other with free text"
    - "Policy status shows as colored badge (Draft, Active, Pending Renewal, Renewed, Expired, Cancelled)"
    - "Policies display as summary cards by default with toggle to table rows"
    - "Creating a policy on a Lead auto-converts them to Client (reflected in UI)"
    - "Policy card shows type icon, carrier, premium, expiry, status badge"
  artifacts:
    - path: "apps/web/src/components/clients/client-policies-tab.tsx"
      provides: "Policies tab with list, view toggle, add button"
      min_lines: 50
    - path: "apps/web/src/components/policies/policy-form.tsx"
      provides: "Create/edit policy form in Dialog"
      min_lines: 80
    - path: "apps/web/src/components/policies/policy-cards.tsx"
      provides: "Summary card display for policies"
      min_lines: 40
    - path: "apps/web/src/components/policies/policy-table.tsx"
      provides: "Table view for policies"
      min_lines: 40
    - path: "apps/web/src/components/policies/policy-status-badge.tsx"
      provides: "Status badge with color coding"
      min_lines: 15
  key_links:
    - from: "apps/web/src/components/clients/client-policies-tab.tsx"
      to: "/api/clients/:clientId/policies"
      via: "api.get for policy list"
      pattern: "api\\.get.*policies"
    - from: "apps/web/src/components/policies/policy-form.tsx"
      to: "/api/clients/:clientId/policies"
      via: "api.post/api.patch for create/update"
      pattern: "api\\.(post|patch).*policies"
    - from: "apps/web/src/components/clients/client-policies-tab.tsx"
      to: "apps/web/src/components/policies/policy-cards.tsx"
      via: "conditional rendering based on viewMode"
      pattern: "viewMode.*cards"
---

<objective>
Build the policy management UI on the client profile page: create/edit/delete policies in a Dialog, display as summary cards or table rows, show status badges, and wire the auto-convert lead-to-client behavior in the UI.

Purpose: Users need to manage policies linked to their clients with full Canadian insurance fields and proper status tracking.
Output: Fully functional Policies tab on client profile with CRUD operations, summary cards/table toggle, and auto-convert feedback.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-client-and-policy-management/02-CONTEXT.md
@.planning/phases/02-client-and-policy-management/02-RESEARCH.md
@.planning/phases/02-client-and-policy-management/02-01-SUMMARY.md
@.planning/phases/02-client-and-policy-management/02-02-SUMMARY.md
@.planning/phases/02-client-and-policy-management/02-03-SUMMARY.md
@.planning/phases/02-client-and-policy-management/02-04-SUMMARY.md
@apps/web/src/lib/api.ts
@packages/shared/src/types/policy.ts
@packages/shared/src/constants/insurance.ts
@packages/shared/src/validation/policy.schema.ts
@apps/web/src/components/ui/dialog.tsx
@apps/web/src/components/ui/alert-dialog.tsx
@apps/web/src/components/ui/form.tsx
@apps/web/src/components/ui/select.tsx
@apps/web/src/components/clients/view-toggle.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Policy form, status badge, and card/table display components</name>
  <files>
    apps/web/src/components/policies/policy-form.tsx
    apps/web/src/components/policies/policy-status-badge.tsx
    apps/web/src/components/policies/policy-cards.tsx
    apps/web/src/components/policies/policy-table.tsx
  </files>
  <action>
**policy-status-badge.tsx:**
Simple component that renders a shadcn Badge with color based on PolicyStatus.

Color mapping (use POLICY_STATUSES from @anchor/shared for consistency):
- draft: variant="secondary" (gray)
- active: variant="default" (primary/navy)
- pending_renewal: custom className for amber/warning (e.g., "bg-amber-100 text-amber-800 border-amber-200")
- renewed: variant="default"
- expired: variant="destructive"
- cancelled: variant="destructive" with outline style

Display the formatted label from POLICY_STATUSES constant (e.g., "Pending Renewal" not "pending_renewal").

**policy-form.tsx:**
Policy create/edit form rendered inside a shadcn `<Dialog>`. Uses react-hook-form + zodResolver + createPolicySchema.

Props: `clientId: string`, `mode: 'create' | 'edit'`, `defaultValues?: Partial<Policy>`, `policyId?: string`, `open: boolean`, `onOpenChange: (open: boolean) => void`, `onSuccess: () => void`.

**Form fields** (all detail fields per locked decision):

1. **Type** (required): Select dropdown. Options from POLICY_TYPES constant. When "Other" is selected, show a text input for `customType` below.

2. **Carrier**: Text input with autocomplete suggestions from COMMON_CARRIERS. Use a simple datalist HTML element or a Combobox pattern. For simplicity, use a regular text input with a `<datalist>` element populated from COMMON_CARRIERS. User can type freely or select from suggestions.

3. **Policy Number**: Text input, optional.

4. **Dates row** (side by side):
   - Start Date: date input (type="date")
   - End Date / Expiry: date input (type="date")

5. **Financial details section:**
   - Premium ($): text input, placeholder "0.00". Will be sent as string to API.
   - Coverage Amount ($): text input, placeholder "0.00"
   - Deductible ($): text input, placeholder "0.00"
   - Payment Frequency: Select from PAYMENT_FREQUENCIES constant
   - Broker Commission (%): text input, placeholder "0.00"

6. **Status**: Select from POLICY_STATUSES constant. Default "Draft" for new policies. For edit mode, only show valid transitions from current status (locked decision: Draft -> Active, Active -> Pending Renewal/Cancelled/Expired, etc.).

7. **Notes**: Textarea for policy-specific notes.

**Layout:** Use a 2-column grid for compact layout on larger screens. Group related fields:
- Row 1: Type + Carrier
- Row 2: Policy Number + Status
- Row 3: Start Date + End Date
- Row 4: Premium + Coverage Amount
- Row 5: Deductible + Payment Frequency
- Row 6: Broker Commission (half width)
- Row 7: Notes (full width)

**Submission:**
- Create: `api.post('/api/clients/${clientId}/policies', data)`
- Edit: `api.patch('/api/clients/${clientId}/policies/${policyId}', data)`
- On success: toast.success, close dialog, call onSuccess.
- On error: toast.error with message.
- Special handling: if the API returns that the client was auto-converted to Client (detect via toast message or response), show an info toast: "Lead auto-converted to Client".

**IMPORTANT:**
- Decimal fields (premium, coverageAmount, deductible, brokerCommission) are sent as strings. The API accepts strings and Prisma converts to Decimal.
- Import types from @anchor/shared (PolicyType, PolicyStatus, Policy).
- Import constants from @anchor/shared (POLICY_TYPES, POLICY_STATUSES, COMMON_CARRIERS, PAYMENT_FREQUENCIES).
- Use zodResolver with createPolicySchema for create, updatePolicySchema for edit.

**policy-cards.tsx:**
Summary card display for policies. Props: `policies: Policy[]`, `clientId: string`, `onEdit: (policy: Policy) => void`, `onDelete: (policy: Policy) => void`.

Per locked decision: "summary cards by default (type icon, carrier, premium, expiry, status badge)".

Each card (shadcn Card) shows:
- **Header:** Policy type icon (from POLICY_TYPES constant, map to lucide-react icons: Car, Home, Heart, Activity, Building2, Plane, Umbrella, FileText) + type label + policy number
- **Body:**
  - Carrier name
  - Premium formatted as CAD currency: `$${parseFloat(premium).toLocaleString('en-CA', { minimumFractionDigits: 2 })}`
  - Expiry date formatted with date-fns
  - PolicyStatusBadge
- **Footer:** Edit and Delete action buttons (small, icon buttons)

Responsive grid: 1 col mobile, 2 cols md, 3 cols lg.

**policy-table.tsx:**
Table view for policies. Props: same as policy-cards.

Columns:
1. Type (icon + label)
2. Carrier
3. Policy #
4. Premium (CAD formatted)
5. Start Date
6. End Date
7. Status (PolicyStatusBadge)
8. Actions (Edit, Delete dropdown)

Use @tanstack/react-table with useReactTable, getCoreRowModel. Follow the client-table pattern.

**IMPORTANT for both views:**
- Parse premium/coverageAmount/deductible from string to number only for DISPLAY (parseFloat). Do not convert for storage.
- Format dates with date-fns format(date, 'MMM d, yyyy').
- Handle null/undefined fields gracefully (show '--').
  </action>
  <verify>
Run `pnpm --filter web build` -- should compile with zero TypeScript errors.
Verify policy-form.tsx uses zodResolver with createPolicySchema.
Verify policy-form.tsx has all detail fields (type, carrier, policy number, dates, premium, coverage, deductible, frequency, commission, notes).
Verify POLICY_TYPES and COMMON_CARRIERS constants used for dropdowns.
Verify policy-cards.tsx shows type icon, carrier, premium, expiry, status badge.
Verify policy-table.tsx uses @tanstack/react-table.
Verify PolicyStatusBadge maps all 6 statuses to appropriate colors.
  </verify>
  <done>
Policy form component in Dialog with all Canadian insurance fields. Status badge with color coding. Summary cards showing type icon, carrier, premium, expiry, and status. Table view with sortable columns. Both views handle Decimal-as-string display and null fields gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Policies tab into client profile and handle auto-convert feedback</name>
  <files>
    apps/web/src/components/clients/client-policies-tab.tsx
    apps/web/src/app/(dashboard)/clients/[id]/page.tsx
  </files>
  <action>
**client-policies-tab.tsx:**
Policies tab content on the client profile page. Props: `clientId: string`, `clientStatus: ClientStatus`, `onClientUpdated: () => void`.

Layout:
1. **Header row:** "Policies" label (left) + "Add Policy" button (right) + ViewToggle (right, next to button)
2. **Content:** PolicyCards (default, per locked decision "summary cards by default") or PolicyTable based on viewMode
3. **Empty state:** "No policies yet. Add a policy to start tracking coverage." with an "Add Policy" CTA button.

State management:
- `viewMode`: 'cards' | 'table' (default 'cards')
- `policies`: Policy[] fetched from API
- `showForm`: boolean for Dialog open state
- `editingPolicy`: Policy | null for edit mode
- `loading`: boolean

Data fetching:
- On mount and after mutations, fetch `api.get<Policy[]>('/api/clients/${clientId}/policies')`.
- NOTE: The policies endpoint returns an array directly (not paginated) since a single client rarely has >20 policies.

CRUD operations:
- **Add:** Click "Add Policy" opens Dialog with PolicyForm in create mode.
- **Edit:** Click edit on a card/row opens Dialog with PolicyForm in edit mode, defaultValues from the policy.
- **Delete:** Click delete shows AlertDialog. On confirm: `api.delete('/api/clients/${clientId}/policies/${id}')`, toast, refresh.

Auto-convert handling:
- After creating a policy, check if `clientStatus` was 'lead'. If so, call `onClientUpdated()` which re-fetches the client data in the parent page. The parent will see the updated status and the header badge will change from Lead to Client.
- Show a specific toast: "Policy created. Lead has been converted to Client." (if client was a lead).

**Update clients/[id]/page.tsx:**
Replace the "Policies will appear here" placeholder tab content with `<ClientPoliciesTab clientId={id} clientStatus={client.status} onClientUpdated={refreshClient} />`.

Import ClientPoliciesTab component. The refreshClient function already exists from plan 02-04 (re-fetches client data and updates state).

Also ensure the ViewToggle component (built in plan 02-03) is available for import. If it was placed in `components/clients/view-toggle.tsx`, import from there. It should be generic enough to reuse.

**CRITICAL:**
- Policy summary cards are the DEFAULT view (locked decision).
- Import Policy, PolicyType, PolicyStatus, ClientStatus from @anchor/shared.
- Import POLICY_TYPES, POLICY_STATUSES from @anchor/shared constants.
- Auto-convert feedback: after creating a policy on a lead, re-fetch client to update header status badge.
- Delete confirmation via AlertDialog.
- Use sonner toast for all feedback.
  </action>
  <verify>
Run `pnpm --filter web build` -- should compile with zero TypeScript errors.
Verify client-policies-tab.tsx fetches policies from /api/clients/:id/policies.
Verify "Add Policy" button opens Dialog with PolicyForm.
Verify edit and delete work with proper feedback.
Verify cards are the default view with toggle to table.
Verify auto-convert feedback: after creating policy on a lead, client status refreshes.
Verify Policies tab replaces placeholder in [id]/page.tsx.
  </verify>
  <done>
Policies tab fully functional on client profile. Users can add, edit, and delete policies via Dialog form. Summary cards show by default with table toggle. Auto-convert from Lead to Client is reflected in UI after first policy creation. All policy types and statuses use shared constants.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete client and policy management system:
1. Client list page with Clients/Leads tabs, search, filters, and table/card view toggle
2. Client create form with lead/client conditional validation and Canadian province selector
3. Client profile page with Overview, Policies, Timeline/Notes tabs
4. Activity timeline with compact/expanded views and immutable note creation
5. Policy CRUD with all Canadian insurance fields, status badges, summary cards/table toggle
6. Auto-convert lead to client on first policy creation
7. Manual convert/revert button on client profile
  </what-built>
  <how-to-verify>
Start both servers (`pnpm dev` from monorepo root or `pnpm --filter web dev` and `pnpm --filter api dev` separately).

**Test 1 — Create a Lead:**
1. Navigate to /clients
2. Click "New Client"
3. Set status to "Lead"
4. Enter first name, last name, and email (or phone)
5. Submit — should succeed with toast notification
6. Verify lead appears in the "Leads" tab on the client list

**Test 2 — Client list features:**
1. Search for the lead by name — should appear in results
2. Toggle from table view to card view — both should display correctly
3. Switch between "Clients" and "Leads" tabs — filtering should work

**Test 3 — Client profile:**
1. Click on the lead name to open profile
2. Verify Overview tab shows contact details
3. Verify Timeline/Notes tab shows "Client created" event
4. Add a note in the Timeline tab — should appear in the timeline
5. Verify note cannot be edited or deleted (no edit/delete buttons)

**Test 4 — Auto-convert via policy:**
1. On the lead profile, go to Policies tab
2. Click "Add Policy"
3. Fill in: Type=Auto, Carrier=Intact Insurance, Premium=1200, Status=Active
4. Submit — should see policy created AND "Lead converted to Client" toast
5. Verify header badge changed from "Lead" to "Client"
6. Verify Timeline shows both "Policy created" and "Status changed" events

**Test 5 — Manual convert:**
1. Click "Revert to Lead" button on profile header
2. Confirm status badge changes back to "Lead"
3. Verify Timeline shows status change event

**Test 6 — Full client creation:**
1. Go to /clients/new
2. Set status to "Client"
3. Fill all required fields including address, province (select from dropdown), postal code
4. Submit and verify client appears in "Clients" tab

**Test 7 — Policy management:**
1. On a client profile, add 2-3 policies of different types
2. Verify summary cards show type icons, carrier, premium, status badges
3. Toggle to table view — verify all columns display
4. Edit a policy — change status from Draft to Active
5. Delete a policy — confirm with dialog, verify removed

**Expected URL:** http://localhost:3000/clients
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- `pnpm build` passes across entire monorepo
- All 7 test scenarios pass during human verification
- Client CRUD works end-to-end (create, read, update, delete)
- Search and filter work on client list
- Table/card toggle works on both client list and policy display
- Timeline shows all activity events and notes
- Notes are immutable (no edit/delete)
- Policy form includes all Canadian insurance fields
- Auto-convert lead to client works on first policy
- Manual convert/revert works
- Policy status badges show correct colors
</verification>

<success_criteria>
All 5 success criteria from the roadmap are met:
1. User can create, edit, search, and delete clients with full contact details
2. User can set a client as Lead (minimal data) or Client (full records)
3. Each client has a profile page showing a living activity timeline
4. User can add notes to a client and see them in the timeline
5. User can create, edit, and delete policies linked to a client with type, carrier, dates, premium, and status
</success_criteria>

<output>
After completion, create `.planning/phases/02-client-and-policy-management/02-05-SUMMARY.md`
</output>
