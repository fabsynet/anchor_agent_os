---
phase: 02-client-and-policy-management
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - apps/web/src/app/(dashboard)/clients/page.tsx
  - apps/web/src/app/(dashboard)/clients/new/page.tsx
  - apps/web/src/components/clients/client-list.tsx
  - apps/web/src/components/clients/client-table.tsx
  - apps/web/src/components/clients/client-cards.tsx
  - apps/web/src/components/clients/client-form.tsx
  - apps/web/src/components/clients/view-toggle.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a clients page with Clients and Leads tabs"
    - "User can search clients by name, email, or phone"
    - "User can filter clients by status"
    - "User can toggle between table view and card grid view"
    - "User can create a new client/lead via a form with proper validation"
    - "User can edit an existing client from the list"
    - "User can delete a client with confirmation dialog"
    - "Table shows blended key fields: name, phone, status, policy count, next renewal date"
    - "Lead creation requires only name + email or phone"
    - "Client creation requires full contact details"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/clients/page.tsx"
      provides: "Client list page with tabs and routing"
      min_lines: 20
    - path: "apps/web/src/components/clients/client-list.tsx"
      provides: "Main list component with search, filters, tabs, view toggle"
      min_lines: 80
    - path: "apps/web/src/components/clients/client-table.tsx"
      provides: "Table view using @tanstack/react-table"
      min_lines: 60
    - path: "apps/web/src/components/clients/client-cards.tsx"
      provides: "Card grid view for clients"
      min_lines: 40
    - path: "apps/web/src/components/clients/client-form.tsx"
      provides: "Create/edit form with lead/client conditional validation"
      min_lines: 80
  key_links:
    - from: "apps/web/src/components/clients/client-list.tsx"
      to: "/api/clients"
      via: "api.get for fetching client list"
      pattern: "api\\.get.*clients"
    - from: "apps/web/src/components/clients/client-form.tsx"
      to: "/api/clients"
      via: "api.post/api.patch for create/update"
      pattern: "api\\.(post|patch).*clients"
    - from: "apps/web/src/components/clients/client-table.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable hook"
      pattern: "useReactTable"
---

<objective>
Build the client list page with Clients/Leads tabs, search bar, status filters, table/card toggle, and create/edit/delete functionality. This is the main CRM interface.

Purpose: Users need to see, search, and manage their book of business from a single page.
Output: Fully functional /clients page with CRUD operations, dual view modes, and proper form validation.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-client-and-policy-management/02-CONTEXT.md
@.planning/phases/02-client-and-policy-management/02-RESEARCH.md
@.planning/phases/02-client-and-policy-management/02-01-SUMMARY.md
@.planning/phases/02-client-and-policy-management/02-02-SUMMARY.md
@apps/web/src/lib/api.ts
@apps/web/src/app/(dashboard)/layout.tsx
@packages/shared/src/types/client.ts
@packages/shared/src/types/policy.ts
@packages/shared/src/constants/insurance.ts
@packages/shared/src/validation/client.schema.ts
@apps/web/src/components/settings/invite-form.tsx
@apps/web/src/components/ui/form.tsx
@apps/web/src/components/ui/tabs.tsx
@apps/web/src/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Client list page with tabs, search, filters, and view toggle</name>
  <files>
    apps/web/src/app/(dashboard)/clients/page.tsx
    apps/web/src/components/clients/client-list.tsx
    apps/web/src/components/clients/client-table.tsx
    apps/web/src/components/clients/client-cards.tsx
    apps/web/src/components/clients/view-toggle.tsx
  </files>
  <action>
**clients/page.tsx:**
'use client' page component. Renders ClientList component. Page title "Clients" with a "New Client" button (links to /clients/new or opens dialog).

**view-toggle.tsx:**
Reusable component for toggling between 'table' and 'cards' view modes. Two icon buttons (List and LayoutGrid from lucide-react) in a bordered container. Active mode gets 'secondary' variant, inactive gets 'ghost'. Accepts `mode: 'table' | 'cards'` and `onChange` callback.

**client-list.tsx:**
Main list component. This is a 'use client' component that:

1. **State management:**
   - `viewMode` state: 'table' | 'cards' (default 'table')
   - `activeTab` state: 'clients' | 'leads' (default 'clients')
   - `searchQuery` state: debounced search string
   - `page` state: current page number
   - Fetch clients using `api.get<PaginatedResponse>('/api/clients', { params })` where params include status (from activeTab), search, page, limit=20.
   - Use `useEffect` to refetch when activeTab, searchQuery, or page changes.
   - Use `useState` + `useEffect` for simple data fetching (no SWR/React Query needed for MVP).

2. **Layout (top to bottom):**
   - Header row: "Clients" title (h1) + "New Client" button (right-aligned). Button uses `<Link href="/clients/new">` or triggers a dialog.
   - Tabs row: shadcn `<Tabs>` with "Clients" and "Leads" tabs. Tab values = 'clients' and 'leads'. Clicking a tab sets activeTab and resets page to 1.
   - Controls row: Search input (left, with Search icon), ViewToggle (right). Search input uses `onChange` with 300ms debounce (simple setTimeout + clearTimeout pattern, no lodash needed).
   - Content: Conditionally render `<ClientTable>` or `<ClientCards>` based on viewMode.
   - Footer: Pagination controls using shadcn Pagination component (or simple Prev/Next buttons with page count).

3. **Data shape from API:**
   ```typescript
   interface PaginatedClients {
     data: ClientListItem[];
     total: number;
     page: number;
     limit: number;
     totalPages: number;
   }
   ```
   Import `ClientListItem` from `@anchor/shared`.

4. **Empty states:**
   - No clients yet: "No clients found. Create your first client to get started." with CTA button.
   - No search results: "No clients match your search."
   - No leads: "No leads yet. Add a lead to start tracking prospects."

**client-table.tsx:**
Table view using @tanstack/react-table. Receives `data: ClientListItem[]` prop.

Column definitions (per locked decision -- blended key fields):
1. **Name** — `${firstName} ${lastName}`, clickable link to `/clients/${id}`
2. **Phone** — phone number or '--'
3. **Status** — Badge component: 'Client' (default variant) or 'Lead' (secondary variant)
4. **Policies** — policyCount number
5. **Next Renewal** — nextRenewalDate formatted with date-fns `format(date, 'MMM d, yyyy')` or '--'
6. **Actions** — DropdownMenu with Edit and Delete options

Use shadcn `<Table>`, `<TableHeader>`, `<TableBody>`, `<TableRow>`, `<TableCell>` components.
Use `useReactTable` from @tanstack/react-table with `getCoreRowModel`, `getSortingRowModel`.
Enable column header click for sorting.

Delete action: Opens an `<AlertDialog>` confirmation. On confirm, calls `api.delete('/api/clients/${id}')` and refreshes the list.

**client-cards.tsx:**
Card grid view. Receives `data: ClientListItem[]` prop. Renders a responsive grid (1 col mobile, 2 cols md, 3 cols lg) of shadcn `<Card>` components.

Each card shows:
- Name (bold, clickable link to /clients/${id})
- Status badge
- Phone and/or email
- Policy count
- Next renewal date
- Actions dropdown (Edit, Delete)

Use Tailwind grid: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`.

**CRITICAL:**
- Import types from `@anchor/shared` (ClientListItem, ClientStatus) — NOT using `string`.
- Import api from `@/lib/api`.
- Use `sonner` toast for success/error notifications on delete.
- All dates formatted with date-fns.
- Clicking a client name navigates to `/clients/${id}` (the profile page, built in plan 02-04).
  </action>
  <verify>
Run `pnpm --filter web build` -- should compile with zero TypeScript errors.
Verify client-list.tsx fetches from /api/clients with correct query params.
Verify client-table.tsx uses @tanstack/react-table with column definitions.
Verify Tabs component has "Clients" and "Leads" tabs.
Verify ViewToggle renders table/cards toggle.
Verify delete flow uses AlertDialog confirmation.
  </verify>
  <done>
/clients page renders with Clients/Leads tabs, search input, view toggle (table/cards), and paginated client list. Table view shows name, phone, status badge, policy count, and next renewal date. Card view shows same data in a responsive grid. Delete uses AlertDialog confirmation with toast feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Client create/edit form with lead/client conditional validation</name>
  <files>
    apps/web/src/app/(dashboard)/clients/new/page.tsx
    apps/web/src/components/clients/client-form.tsx
  </files>
  <action>
**client-form.tsx:**
Shared form component for create and edit modes. Uses react-hook-form + Zod resolver + shadcn Form components. Follow the exact pattern from invite-form.tsx and signup-form.tsx.

Props: `mode: 'create' | 'edit'`, `defaultValues?: Partial<CreateClientInput>`, `clientId?: string`, `onSuccess?: () => void`.

**Form fields:**

1. **Status selector** (at top): Radio group or Select with "Lead" and "Client" options. Default: 'lead'. This controls which fields are required below.

2. **Basic info (always shown):**
   - First Name (required)
   - Last Name (required)
   - Email (optional for lead, show always)
   - Phone (optional for lead, show always)

3. **Full details (shown always, required only when status is 'client'):**
   - Address (text input)
   - City (text input)
   - Province (Select dropdown using CANADIAN_PROVINCES from @anchor/shared)
   - Postal Code (text input, format hint: "A1A 1A1")
   - Date of Birth (date input, type="date")

When status is 'lead': Show a helper text "Leads require just a name and either email or phone."
When status is 'client': Show helper text "Full contact details required for clients."

**Validation:**
Use `createClientSchema` from `@anchor/shared` via `zodResolver(createClientSchema)` with react-hook-form `useForm`. The schema already has the .refine() for lead validation (email OR phone required).

For edit mode, use `updateClientSchema` (partial, all optional).

Watch the `status` field with `form.watch('status')` to conditionally show required indicators (*) on client fields.

**Form submission:**
- Create mode: `api.post('/api/clients', data)` then navigate to `/clients/${response.id}` or back to list.
- Edit mode: `api.patch('/api/clients/${clientId}', data)` then call onSuccess or navigate back.
- Show loading state on submit button.
- On success: toast.success('Client created') or toast.success('Client updated').
- On error: toast.error(error.message).

**clients/new/page.tsx:**
Page that renders `<ClientForm mode="create" />` inside a card layout with "New Client" heading and a back link to /clients.

**Edit flow:**
The edit page can be either:
- A separate page at /clients/[id]/edit (simple, works with navigation)
- A Dialog overlay from the list page

Use a separate page approach for simplicity: Create `apps/web/src/app/(dashboard)/clients/[id]/edit/page.tsx` that fetches the client data and renders `<ClientForm mode="edit" defaultValues={client} clientId={id} />`. This page should be created here.

**New file:** `apps/web/src/app/(dashboard)/clients/[id]/edit/page.tsx`:
- 'use client' component
- Fetch client via `api.get<Client>('/api/clients/${id}')` on mount
- Show loading skeleton while fetching
- Render ClientForm with mode='edit' and defaultValues from fetched data
- On success, navigate to `/clients/${id}` (profile page)

**IMPORTANT:**
- Import createClientSchema, updateClientSchema from @anchor/shared.
- Import CANADIAN_PROVINCES from @anchor/shared.
- Use zodResolver from @hookform/resolvers/zod.
- Province Select should use the CANADIAN_PROVINCES constant for options.
- All API calls use api from @/lib/api.
- Use router.push() from next/navigation for navigation after submit.
  </action>
  <verify>
Run `pnpm --filter web build` -- should compile with zero TypeScript errors.
Verify client-form.tsx uses react-hook-form + zodResolver + createClientSchema.
Verify status toggle changes required fields (conditional validation).
Verify CANADIAN_PROVINCES used for province Select.
Verify form submission calls correct API endpoint.
Verify /clients/new page renders the create form.
Verify /clients/[id]/edit page fetches client data and renders edit form.
  </verify>
  <done>
Client create form at /clients/new with lead/client status toggle controlling required fields. Edit form at /clients/[id]/edit prefills existing data. Both use Zod validation via react-hook-form. Province selector uses Canadian provinces constant. Forms submit to correct API endpoints with toast feedback and navigation on success.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web build` passes
- /clients page shows tabs (Clients/Leads), search, filters, view toggle
- Table view has columns: Name, Phone, Status, Policies, Next Renewal, Actions
- Card view shows client info in responsive grid
- /clients/new renders create form with lead/client validation
- /clients/[id]/edit renders edit form with prefilled data
- Delete uses AlertDialog with toast feedback
</verification>

<success_criteria>
- Client list page is fully functional with tabs, search, view toggle, and pagination
- Table and card views display blended key fields per locked decisions
- Create form enforces lead (name + email/phone) vs client (full details) validation
- Edit form prefills and updates correctly
- Delete prompts for confirmation before removing
- All API calls use correct /api/clients endpoints
- Types from @anchor/shared used throughout (no string types for status)
</success_criteria>

<output>
After completion, create `.planning/phases/02-client-and-policy-management/02-03-SUMMARY.md`
</output>
