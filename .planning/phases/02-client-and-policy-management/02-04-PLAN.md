---
phase: 02-client-and-policy-management
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - apps/web/src/app/(dashboard)/clients/[id]/page.tsx
  - apps/web/src/components/clients/client-profile-header.tsx
  - apps/web/src/components/clients/client-overview-tab.tsx
  - apps/web/src/components/clients/client-timeline-tab.tsx
  - apps/web/src/components/timeline/timeline-list.tsx
  - apps/web/src/components/timeline/timeline-expanded.tsx
  - apps/web/src/components/timeline/note-form.tsx
  - apps/web/src/components/timeline/activity-icon.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a client profile page with tabbed sections"
    - "Profile header shows client name, status badge, and action buttons"
    - "Overview tab shows client contact details and summary stats"
    - "Timeline/Notes tab shows chronological activity events and notes"
    - "User can add a plain text note from the Timeline tab"
    - "Timeline defaults to compact list view with toggle to expanded cards"
    - "Each timeline entry has an icon, description, and timestamp"
    - "Manual Convert to Client / Revert to Lead button works from profile"
    - "Notes are displayed inline in the timeline chronologically"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/clients/[id]/page.tsx"
      provides: "Client profile page with data fetching and tabs"
      min_lines: 40
    - path: "apps/web/src/components/clients/client-profile-header.tsx"
      provides: "Profile header with name, status, actions"
      min_lines: 30
    - path: "apps/web/src/components/clients/client-timeline-tab.tsx"
      provides: "Timeline tab container with note form and event list"
      min_lines: 40
    - path: "apps/web/src/components/timeline/timeline-list.tsx"
      provides: "Compact timeline view"
      min_lines: 30
    - path: "apps/web/src/components/timeline/note-form.tsx"
      provides: "Add note form with textarea"
      min_lines: 20
  key_links:
    - from: "apps/web/src/app/(dashboard)/clients/[id]/page.tsx"
      to: "/api/clients/:id"
      via: "api.get for client data"
      pattern: "api\\.get.*clients"
    - from: "apps/web/src/components/clients/client-timeline-tab.tsx"
      to: "/api/clients/:id/timeline"
      via: "api.get for timeline events"
      pattern: "api\\.get.*timeline"
    - from: "apps/web/src/components/timeline/note-form.tsx"
      to: "/api/clients/:id/notes"
      via: "api.post for creating notes"
      pattern: "api\\.post.*notes"
---

<objective>
Build the client profile page with tabbed sections (Overview, Policies, Timeline/Notes, Documents) and the full timeline/notes UI with compact/expanded views.

Purpose: Each client needs a detailed profile showing all associated data and a living activity timeline for compliance and relationship tracking.
Output: Client profile at /clients/[id] with overview, timeline display, note creation, and placeholder tabs for Policies and Documents (filled by later plans/phases).
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-client-and-policy-management/02-CONTEXT.md
@.planning/phases/02-client-and-policy-management/02-RESEARCH.md
@.planning/phases/02-client-and-policy-management/02-01-SUMMARY.md
@.planning/phases/02-client-and-policy-management/02-02-SUMMARY.md
@apps/web/src/lib/api.ts
@packages/shared/src/types/client.ts
@packages/shared/src/types/activity.ts
@packages/shared/src/constants/insurance.ts
@apps/web/src/components/ui/tabs.tsx
@apps/web/src/components/ui/scroll-area.tsx
@apps/web/src/components/ui/textarea.tsx
@apps/web/src/components/ui/badge.tsx
@apps/web/src/components/ui/card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Client profile page with header, overview tab, and convert button</name>
  <files>
    apps/web/src/app/(dashboard)/clients/[id]/page.tsx
    apps/web/src/components/clients/client-profile-header.tsx
    apps/web/src/components/clients/client-overview-tab.tsx
  </files>
  <action>
**clients/[id]/page.tsx:**
'use client' page component. Receives `params: { id: string }` from Next.js dynamic routing.

On mount, fetch client data via `api.get<Client>('/api/clients/${id}')`. Show loading skeleton while fetching. Handle 404 (client not found) with a "Client not found" message and back link.

Layout:
1. `<ClientProfileHeader>` at top
2. shadcn `<Tabs>` below with 4 tabs:
   - **Overview** (default) — `<ClientOverviewTab>`
   - **Policies** — placeholder: "Policies will appear here" (filled by Plan 02-05)
   - **Timeline / Notes** — `<ClientTimelineTab>` (Task 2)
   - **Documents** — placeholder: "Documents coming soon" (filled in Phase 4)

Tab ordering per Claude's discretion: Overview, Policies, Timeline/Notes, Documents. Use icons from lucide-react: User, Shield, Clock, FileText.

Pass client data and a `refreshClient` callback (re-fetches client) to child components.

**client-profile-header.tsx:**
Displays at the top of the profile page. Props: `client: Client`, `onRefresh: () => void`.

Layout (horizontal, responsive):
- Left: Client avatar placeholder (initials in a colored circle), name (`${firstName} ${lastName}`), email, phone
- Center/below: Status badge (Lead or Client) using shadcn Badge
- Right: Action buttons:
  - **Edit** button — links to `/clients/${id}/edit`
  - **Convert** button — "Convert to Client" (if lead) or "Revert to Lead" (if client). Calls `api.patch('/api/clients/${id}/convert')`. On success, toast and call onRefresh. If converting to client fails (missing fields), show error toast with the missing fields message from API.
  - **Delete** button (destructive variant) — opens AlertDialog. On confirm, calls `api.delete('/api/clients/${id}')`, shows toast, navigates to /clients.

The convert button is important (locked decision): auto-convert happens on first policy, but manual conversion must also be available.

**client-overview-tab.tsx:**
Shows client details in a structured layout. Props: `client: Client`.

Layout using Card components or simple grid:
- **Contact Information** section: Email, Phone, Address (formatted: address, city, province postalCode), Date of Birth (formatted with date-fns)
- **Summary Stats** section (if data available): Policy count, Next renewal date, Account age (calculated from createdAt with date-fns `formatDistanceToNow`)
- **Status** section: Current status with conversion info

For fields that are null/empty (especially for leads), show "--" or "Not provided" in muted text.

**CRITICAL:**
- Import Client type from @anchor/shared.
- Use date-fns `format` and `formatDistanceToNow` for date display.
- Use api from @/lib/api for all API calls.
- Use sonner toast for success/error messages.
- Use router from next/navigation for navigation.
  </action>
  <verify>
Run `pnpm --filter web build` -- should compile with zero TypeScript errors.
Verify /clients/[id] page fetches client data and renders tabs.
Verify header shows name, status badge, Edit/Convert/Delete buttons.
Verify Convert button toggles between "Convert to Client" and "Revert to Lead".
Verify overview tab displays contact information and summary stats.
Verify Delete uses AlertDialog and navigates to /clients on success.
  </verify>
  <done>
Client profile page at /clients/[id] renders with header (name, status badge, Edit/Convert/Delete actions) and 4 tabs (Overview, Policies, Timeline/Notes, Documents). Overview tab shows formatted contact details and summary stats. Convert button toggles lead/client status with API call. Delete prompts confirmation and navigates away.
  </done>
</task>

<task type="auto">
  <name>Task 2: Timeline/Notes tab with compact/expanded views and note form</name>
  <files>
    apps/web/src/components/clients/client-timeline-tab.tsx
    apps/web/src/components/timeline/timeline-list.tsx
    apps/web/src/components/timeline/timeline-expanded.tsx
    apps/web/src/components/timeline/note-form.tsx
    apps/web/src/components/timeline/activity-icon.tsx
  </files>
  <action>
**activity-icon.tsx:**
Maps ActivityEventType to a lucide-react icon. Export a component `ActivityIcon` that takes `type: string` and returns the appropriate icon.

Icon mapping (Claude's discretion):
- client_created: UserPlus
- client_updated: UserCog or Pencil
- client_status_changed: ArrowRightLeft
- note_added: StickyNote or MessageSquare
- policy_created: ShieldPlus or FilePlus
- policy_updated: ShieldCheck or FileEdit
- policy_status_changed: RefreshCw
- policy_deleted: ShieldX or Trash2
- default: Activity

Each icon renders at size 16 (className="size-4") with muted color.

**note-form.tsx:**
Simple form to add a note. Props: `clientId: string`, `onNoteAdded: () => void`.

Uses shadcn Textarea + Button. The textarea has placeholder "Add a note...". Submit button says "Add Note".

On submit:
1. Validate content is not empty (min 1 char).
2. Call `api.post('/api/clients/${clientId}/notes', { content })`.
3. Clear textarea.
4. Call onNoteAdded callback (to refresh timeline).
5. toast.success('Note added').
6. On error: toast.error(error.message).

Keep it simple -- no react-hook-form needed for a single textarea field. Use controlled state with useState.

**timeline-list.tsx:**
Compact timeline view (default per locked decision). Props: `items: TimelineItem[]` where TimelineItem is the merged event/note type from the API.

Each item renders as a horizontal row:
- Left: ActivityIcon (for events) or StickyNote icon (for notes)
- Middle: Description text. For notes, show the note content (first 100 chars with ellipsis if longer). For events, show the description string.
- Right: Relative timestamp using date-fns `formatDistanceToNow(date, { addSuffix: true })` (e.g., "2 hours ago", "3 days ago")

Use a vertical line connecting items (CSS border-left or pseudo-element) for a timeline feel.

For note items (kind === 'note'): show the author name below the content in muted text: "by {firstName} {lastName}".
For event items (kind === 'event'): show just the description.

Items are sorted by createdAt descending (newest first) -- the API returns them sorted.

**timeline-expanded.tsx:**
Expanded card view. Same data as timeline-list but each item is a Card component.

Each card shows:
- Icon + type label (e.g., "Note Added", "Policy Created") at top
- Full description/content (no truncation)
- Author name
- Full timestamp: date-fns `format(date, 'MMM d, yyyy, h:mm a')`
- For events with metadata: show metadata details (e.g., "Status changed from Lead to Client")

Cards laid out in a vertical stack with spacing.

**client-timeline-tab.tsx:**
Container for the timeline. Props: `clientId: string`.

Layout:
1. **Note form** at top — renders `<NoteForm clientId={clientId} onNoteAdded={refreshTimeline} />`
2. **View toggle** — compact list (default) vs expanded cards. Reuse or replicate the ViewToggle pattern from client-list but with List/Maximize2 icons and labels "Compact" / "Expanded".
3. **Timeline content** — renders `<TimelineList>` or `<TimelineExpanded>` based on viewMode.
4. **Load more / Pagination** — simple "Load More" button or pagination at bottom.

Data fetching:
- Fetch timeline from `api.get('/api/clients/${clientId}/timeline?page=${page}&limit=50')`.
- Response shape: `{ data: TimelineItem[], total, page, limit }`.
- Each TimelineItem has: id, kind ('event' | 'note'), type (ActivityEventType for events), content (for notes), description (for events), metadata, createdAt, user: { firstName, lastName }.
- Define a local `TimelineItem` type that represents the merged shape. Import ActivityEventType from @anchor/shared.

Empty state: "No activity yet. Add a note to start the timeline."

The timeline is immutable per locked decision: no edit or delete buttons on events or notes. The UI should NOT have any edit/delete controls on timeline items.

**CRITICAL:**
- Compact list is the DEFAULT view (locked decision: "Default view is compact list").
- Notes cannot be deleted (locked decision: "notes cannot be deleted, corrections can be added").
- No edit/delete actions on any timeline item.
- Import types from @anchor/shared.
- Use date-fns for all date formatting.
- Use ScrollArea from shadcn for the timeline content if it gets long.
  </action>
  <verify>
Run `pnpm --filter web build` -- should compile with zero TypeScript errors.
Verify client-timeline-tab.tsx fetches from /api/clients/:id/timeline.
Verify note-form.tsx posts to /api/clients/:id/notes.
Verify timeline-list.tsx renders compact view by default.
Verify timeline-expanded.tsx renders card view.
Verify NO edit/delete controls on timeline items (immutability).
Verify activity-icon.tsx maps all 8 event types to icons.
  </verify>
  <done>
Timeline/Notes tab renders on client profile with note form at top, compact/expanded view toggle, and chronological event list. Notes can be added via textarea. Timeline shows icons, descriptions, and relative timestamps. Expanded view shows full details including metadata. No edit/delete controls (immutable per compliance requirement).
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web build` passes
- /clients/[id] renders profile with 4 tabs
- Overview shows contact details formatted correctly
- Timeline tab shows events and notes in compact list by default
- Notes can be added and appear in timeline
- Convert button works for lead/client toggling
- No edit/delete on timeline items
</verification>

<success_criteria>
- Client profile page fully functional at /clients/[id]
- Header shows name, status, Edit/Convert/Delete actions
- Overview tab displays all client fields with proper formatting
- Timeline tab shows merged events and notes chronologically
- Note form creates notes and refreshes timeline
- Compact list default, expandable to cards (locked decision)
- Timeline is immutable -- no edit/delete controls (compliance)
- Policies and Documents tabs render as placeholders
</success_criteria>

<output>
After completion, create `.planning/phases/02-client-and-policy-management/02-04-SUMMARY.md`
</output>
