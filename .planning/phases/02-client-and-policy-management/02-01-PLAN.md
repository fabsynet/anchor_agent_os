---
phase: 02-client-and-policy-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - packages/shared/src/types/client.ts
  - packages/shared/src/types/policy.ts
  - packages/shared/src/types/activity.ts
  - packages/shared/src/constants/insurance.ts
  - packages/shared/src/validation/client.schema.ts
  - packages/shared/src/validation/policy.schema.ts
  - packages/shared/src/validation/note.schema.ts
  - packages/shared/src/index.ts
  - apps/web/package.json
  - apps/api/package.json
autonomous: true

must_haves:
  truths:
    - "Prisma schema has Client, Policy, ActivityEvent, Note models with all required fields"
    - "Shared types match Prisma models exactly (ClientStatus, PolicyType, PolicyStatus, etc.)"
    - "Canadian insurance constants (provinces, carriers, policy types) are available from @anchor/shared"
    - "Zod validation schemas enforce lead vs client data requirements"
    - "@tanstack/react-table and date-fns are installed and importable"
    - "New shadcn/ui components (Tabs, Dialog, AlertDialog, Textarea, Pagination, ScrollArea) are available"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "Client, Policy, ActivityEvent, Note models + 5 enums + relation updates to User and Tenant"
      contains: "model Client"
    - path: "packages/shared/src/types/client.ts"
      provides: "ClientStatus, Client, ClientListItem types"
      exports: ["ClientStatus", "Client", "ClientListItem"]
    - path: "packages/shared/src/types/policy.ts"
      provides: "PolicyType, PolicyStatus, PaymentFrequency, Policy types"
      exports: ["PolicyType", "PolicyStatus", "Policy"]
    - path: "packages/shared/src/types/activity.ts"
      provides: "ActivityEventType, ActivityEvent, Note types"
      exports: ["ActivityEventType", "ActivityEvent", "Note"]
    - path: "packages/shared/src/constants/insurance.ts"
      provides: "POLICY_TYPES, POLICY_STATUSES, CANADIAN_PROVINCES, COMMON_CARRIERS, PAYMENT_FREQUENCIES"
      exports: ["POLICY_TYPES", "POLICY_STATUSES", "CANADIAN_PROVINCES", "COMMON_CARRIERS", "PAYMENT_FREQUENCIES"]
    - path: "packages/shared/src/validation/client.schema.ts"
      provides: "createClientSchema, updateClientSchema with lead/client conditional validation"
      exports: ["createClientSchema", "updateClientSchema"]
    - path: "packages/shared/src/validation/policy.schema.ts"
      provides: "createPolicySchema, updatePolicySchema"
      exports: ["createPolicySchema", "updatePolicySchema"]
  key_links:
    - from: "packages/shared/src/types/client.ts"
      to: "packages/database/prisma/schema.prisma"
      via: "type alignment"
      pattern: "ClientStatus.*lead.*client"
    - from: "packages/shared/src/index.ts"
      to: "packages/shared/src/types/client.ts"
      via: "re-export"
      pattern: "export.*from.*types/client"
---

<objective>
Create the data foundation for Phase 2: Prisma schema models, shared TypeScript types, Zod validation schemas, Canadian insurance constants, and install new frontend/backend dependencies.

Purpose: All backend modules, frontend components, and forms in subsequent plans depend on these models, types, and libraries existing first.
Output: Migrated database with Client/Policy/ActivityEvent/Note tables, shared package with all types/constants/validation, installed @tanstack/react-table + date-fns + shadcn components.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-client-and-policy-management/02-CONTEXT.md
@.planning/phases/02-client-and-policy-management/02-RESEARCH.md
@packages/database/prisma/schema.prisma
@packages/shared/src/index.ts
@packages/shared/src/types/auth.ts
@packages/shared/src/validation/auth.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma schema additions and migration</name>
  <files>
    packages/database/prisma/schema.prisma
  </files>
  <action>
Add 5 new enums and 4 new models to the existing Prisma schema. Also add new relation fields to the existing User and Tenant models.

**New enums:**
- `ClientStatus` (lead, client) mapped to "client_status"
- `PolicyType` (auto, home, life, health, commercial, travel, umbrella, other) mapped to "policy_type"
- `PolicyStatus` (draft, active, pending_renewal, renewed, expired, cancelled) mapped to "policy_status"
- `PaymentFrequency` (monthly, quarterly, semi_annual, annual) mapped to "payment_frequency"
- `ActivityEventType` (client_created, client_updated, client_status_changed, note_added, policy_created, policy_updated, policy_status_changed, policy_deleted) mapped to "activity_event_type"

**New models** (follow existing Prisma conventions: UUID @id, @map for snake_case columns, @@map for table names, tenantId with @@index):

**Client model:** id, tenantId, firstName, lastName, email (optional), phone (optional), address (optional), city (optional), province (optional), postalCode (optional), dateOfBirth (optional, @db.Date), status (ClientStatus, default: lead), createdById (@db.Uuid), createdAt, updatedAt. Relations: tenant (Tenant), createdBy (User, "clientCreatedBy"), policies (Policy[]), activityEvents (ActivityEvent[]), notes (Note[]). Indexes: [tenantId], [tenantId, status], [tenantId, lastName, firstName].

**Policy model:** id, tenantId, clientId, type (PolicyType), customType (optional, for "other"), carrier (optional), policyNumber (optional), startDate (optional, @db.Date), endDate (optional, @db.Date), premium (optional, @db.Decimal(12,2)), coverageAmount (optional, @db.Decimal(12,2)), deductible (optional, @db.Decimal(12,2)), paymentFrequency (optional, PaymentFrequency), brokerCommission (optional, @db.Decimal(5,2) percentage), status (PolicyStatus, default: draft), notes (optional String), createdById, createdAt, updatedAt. Relations: tenant, client (Client, onDelete: Cascade), createdBy (User, "policyCreatedBy"). Indexes: [tenantId], [clientId], [tenantId, status].

**ActivityEvent model:** id, tenantId, clientId, userId, type (ActivityEventType), description (String), metadata (Json?, stores old/new values), createdAt (NO updatedAt -- immutable). Relations: tenant, client (onDelete: Cascade), user (User, "activityEventUser"). Indexes: [clientId, createdAt(sort: Desc)], [tenantId].

**Note model:** id, tenantId, clientId, userId, content (String), createdAt (NO updatedAt -- immutable). Relations: tenant, client (onDelete: Cascade), user (User, "noteUser"). Indexes: [clientId, createdAt(sort: Desc)], [tenantId].

**Add to existing User model:**
```
clientsCreated    Client[]        @relation("clientCreatedBy")
policiesCreated   Policy[]        @relation("policyCreatedBy")
activityEvents    ActivityEvent[] @relation("activityEventUser")
notesMade         Note[]          @relation("noteUser")
```

**Add to existing Tenant model:**
```
clients         Client[]
policies        Policy[]
activityEvents  ActivityEvent[]
notes           Note[]
```

After updating schema, run:
```bash
cd packages/database
npx prisma generate
npx prisma migrate dev --name add_client_policy_timeline_models
```

If migration fails due to enum + default in same migration, inspect the SQL and split if needed. Supabase uses PG 15 so this should work, but verify.
  </action>
  <verify>
Run `npx prisma validate` from packages/database -- should pass with no errors.
Run `npx prisma generate` -- should complete successfully.
Run `pnpm --filter @anchor/database build` -- should compile.
Verify migration file exists in packages/database/prisma/migrations/.
  </verify>
  <done>
Schema has all 4 new models (Client, Policy, ActivityEvent, Note), 5 new enums, and updated relations on User and Tenant. Prisma client is generated with all new types available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Shared types, constants, validation schemas, and dependency installation</name>
  <files>
    packages/shared/src/types/client.ts
    packages/shared/src/types/policy.ts
    packages/shared/src/types/activity.ts
    packages/shared/src/constants/insurance.ts
    packages/shared/src/validation/client.schema.ts
    packages/shared/src/validation/policy.schema.ts
    packages/shared/src/validation/note.schema.ts
    packages/shared/src/index.ts
    apps/web/package.json
    apps/api/package.json
  </files>
  <action>
**1. Create shared types** (follow existing auth.ts pattern):

`packages/shared/src/types/client.ts`:
- `ClientStatus` = 'lead' | 'client'
- `Client` interface with all fields from Prisma model (dates as strings for JSON serialization)
- `ClientListItem` interface for list view: id, firstName, lastName, email, phone, status, policyCount (number), nextRenewalDate (string | null), createdAt

`packages/shared/src/types/policy.ts`:
- `PolicyType` = 'auto' | 'home' | 'life' | 'health' | 'commercial' | 'travel' | 'umbrella' | 'other'
- `PolicyStatus` = 'draft' | 'active' | 'pending_renewal' | 'renewed' | 'expired' | 'cancelled'
- `PaymentFrequency` = 'monthly' | 'quarterly' | 'semi_annual' | 'annual'
- `Policy` interface with all fields (Decimal fields as `string` for JSON serialization -- parseFloat on frontend display only)

`packages/shared/src/types/activity.ts`:
- `ActivityEventType` = all 8 event types as string union
- `ActivityEvent` interface: id, clientId, userId, type, description, metadata (Record<string, unknown> | null), createdAt, user (optional { firstName, lastName } for display)
- `Note` interface: id, clientId, userId, content, createdAt, user (optional { firstName, lastName })

**2. Create constants** (`packages/shared/src/constants/insurance.ts`):
Copy the POLICY_TYPES, POLICY_STATUSES, CANADIAN_PROVINCES, COMMON_CARRIERS, PAYMENT_FREQUENCIES arrays from the research document exactly. These use `as const` for type narrowing.

**3. Create Zod validation schemas:**

`client.schema.ts`:
- `createClientSchema` using Zod v4 (z.object). Fields: firstName (min 1), lastName (min 1), email (optional email or empty string), phone (optional), status (z.enum(['lead', 'client']).default('lead')), address/city/province/postalCode/dateOfBirth all optional. Add .refine() for lead validation: if status is 'lead', must have email OR phone.
- `updateClientSchema` = createClientSchema.partial() (all fields optional for PATCH).
- Export inferred types: CreateClientInput, UpdateClientInput.

`policy.schema.ts`:
- `createPolicySchema`: type (z.enum of all PolicyType values), customType (optional, required when type is 'other' via .refine()), carrier (optional), policyNumber (optional), startDate (optional ISO date string), endDate (optional), premium (optional, z.string() for decimal -- will be parsed by backend), coverageAmount (optional), deductible (optional), paymentFrequency (optional z.enum), brokerCommission (optional), status (z.enum of PolicyStatus, default 'draft'), notes (optional).
- `updatePolicySchema` = createPolicySchema.partial().
- Export inferred types.

`note.schema.ts`:
- `createNoteSchema`: content (z.string().min(1, 'Note cannot be empty').max(5000))
- Export CreateNoteInput type.

**4. Update `packages/shared/src/index.ts`:**
Add all new type exports, constant exports, and validation schema exports. Follow existing pattern with `export type {}` for interfaces and `export {}` for values.

**5. Install dependencies:**
```bash
# From monorepo root
pnpm --filter web add @tanstack/react-table date-fns
pnpm --filter api add date-fns

# shadcn/ui components (from apps/web directory)
cd apps/web
npx shadcn@latest add tabs dialog alert-dialog textarea pagination scroll-area --yes
```

IMPORTANT: Use Zod v4 syntax (already installed). The import is `import { z } from 'zod'` -- same API surface as v3 for these use cases.

IMPORTANT: All types use `string` for dates (ISO format in JSON) and `string` for Decimal fields (Prisma serializes Decimals as strings). Document this in JSDoc comments.
  </action>
  <verify>
Run `pnpm --filter @anchor/shared build` -- should compile with zero errors.
Run `pnpm build` from root -- all packages and apps should compile.
Verify `@tanstack/react-table` is in apps/web/package.json dependencies.
Verify `date-fns` is in both apps/web/package.json and apps/api/package.json.
Verify shadcn components exist: apps/web/src/components/ui/tabs.tsx, dialog.tsx, alert-dialog.tsx, textarea.tsx, pagination.tsx, scroll-area.tsx.
  </verify>
  <done>
All shared types (Client, Policy, ActivityEvent, Note + status unions), constants (POLICY_TYPES, CANADIAN_PROVINCES, etc.), and Zod schemas (createClientSchema, createPolicySchema, createNoteSchema) are exported from @anchor/shared. All new dependencies are installed and importable. Full monorepo builds successfully.
  </done>
</task>

</tasks>

<verification>
- `npx prisma validate` passes in packages/database
- `pnpm build` succeeds across the entire monorepo
- `@anchor/shared` exports all new types, constants, and schemas
- New UI components exist in apps/web/src/components/ui/
- Migration file exists in prisma/migrations/
</verification>

<success_criteria>
- Database has Client, Policy, ActivityEvent, Note tables with all columns and indexes
- @anchor/shared exports ClientStatus, PolicyType, PolicyStatus, ActivityEventType, Client, Policy, ActivityEvent, Note types
- @anchor/shared exports POLICY_TYPES, POLICY_STATUSES, CANADIAN_PROVINCES, COMMON_CARRIERS, PAYMENT_FREQUENCIES constants
- @anchor/shared exports createClientSchema, createPolicySchema, createNoteSchema with proper validation
- @tanstack/react-table and date-fns installed in web app
- shadcn Tabs, Dialog, AlertDialog, Textarea, Pagination, ScrollArea components available
- Full monorepo builds with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-client-and-policy-management/02-01-SUMMARY.md`
</output>
