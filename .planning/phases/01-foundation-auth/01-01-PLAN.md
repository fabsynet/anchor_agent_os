---
phase: 01-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-workspace.yaml
  - turbo.json
  - .env.example
  - .gitignore
  - apps/web/*
  - apps/api/*
  - packages/shared/*
  - packages/database/*
  - packages/email/*
autonomous: true

must_haves:
  truths:
    - "pnpm dev starts both Next.js and NestJS concurrently via Turborepo"
    - "Prisma schema compiles and generates client types for Tenant, User, Invitation models"
    - "Supabase client utilities exist for both browser and server use in Next.js"
    - "Database trigger creates tenant + user profile on Supabase auth signup"
    - "Custom access token hook adds tenant_id and user_role to JWT claims"
  artifacts:
    - path: "package.json"
      provides: "Root monorepo package with Turborepo scripts"
      contains: "turbo"
    - path: "pnpm-workspace.yaml"
      provides: "Workspace definition"
      contains: "apps/*"
    - path: "turbo.json"
      provides: "Turborepo task pipeline"
      contains: "build"
    - path: "packages/database/prisma/schema.prisma"
      provides: "Tenant, User, Invitation models with enums"
      contains: "model Tenant"
    - path: "packages/database/prisma/migrations"
      provides: "SQL trigger for handle_new_user and custom_access_token_hook"
    - path: "apps/web/src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      contains: "createBrowserClient"
    - path: "apps/web/src/lib/supabase/server.ts"
      provides: "Server Supabase client"
      contains: "createServerClient"
    - path: "apps/web/src/middleware.ts"
      provides: "Session refresh middleware"
      contains: "getUser"
    - path: "packages/shared/src/types/auth.ts"
      provides: "User, Session, Role types"
    - path: "packages/shared/src/constants/roles.ts"
      provides: "Role enum and permissions map"
    - path: "packages/shared/src/validation/auth.schema.ts"
      provides: "Zod schemas for auth forms"
  key_links:
    - from: "packages/database/prisma/schema.prisma"
      to: "Supabase PostgreSQL"
      via: "DATABASE_URL env var"
      pattern: "env\\(\"DATABASE_URL\"\\)"
    - from: "apps/web/src/lib/supabase/client.ts"
      to: "Supabase project"
      via: "NEXT_PUBLIC_SUPABASE_URL env var"
      pattern: "NEXT_PUBLIC_SUPABASE_URL"
---

<objective>
Scaffold the Turborepo monorepo with Next.js 15 frontend, NestJS 11 backend, shared packages (types, database, email), Prisma schema with Phase 1 models, Supabase client utilities, and database triggers for tenant/user creation on signup.

Purpose: This is the foundation everything else builds on. No auth pages, no UI, no API endpoints — just the project structure, dependencies, database schema, and Supabase wiring that Plans 02-05 require.

Output: A working monorepo where `pnpm dev` starts both apps, Prisma types are generated, Supabase clients are configured, and the database has triggers ready for signup.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold monorepo with Turborepo, Next.js, NestJS, and shared packages</name>
  <files>
    package.json
    pnpm-workspace.yaml
    turbo.json
    .gitignore
    .env.example
    apps/web/ (Next.js 15 app with Tailwind v4, shadcn/ui init)
    apps/api/ (NestJS 11 app)
    packages/shared/package.json
    packages/shared/tsconfig.json
    packages/shared/src/types/auth.ts
    packages/shared/src/types/tenant.ts
    packages/shared/src/constants/roles.ts
    packages/shared/src/validation/auth.schema.ts
    packages/shared/src/validation/tenant.schema.ts
    packages/shared/src/index.ts
    packages/database/package.json
    packages/database/tsconfig.json
    packages/email/package.json
    packages/email/tsconfig.json
  </files>
  <action>
    1. Initialize Turborepo monorepo structure manually (do NOT use create-turbo as it creates unwanted boilerplate):
       - Create root `package.json` with name "anchor", private: true, scripts: { dev: "turbo dev", build: "turbo build", lint: "turbo lint", db:generate: "turbo db:generate", db:migrate: "turbo db:migrate" }
       - Create `pnpm-workspace.yaml` with packages: ['apps/*', 'packages/*']
       - Create `turbo.json` per research (build, dev, lint, db:migrate, db:generate tasks)

    2. Scaffold Next.js 15 frontend in `apps/web/`:
       - Run `npx create-next-app@latest apps/web --typescript --tailwind --app --src-dir --no-import-alias`
       - Install deps: `@supabase/supabase-js @supabase/ssr react-hook-form @hookform/resolvers zod next-themes lucide-react sonner`
       - Run `npx shadcn@latest init` inside apps/web — select default style, slate base color (we will customize to navy later), CSS variables: yes
       - Add commonly needed shadcn components: `npx shadcn@latest add button input label card form toast separator avatar dropdown-menu sheet skeleton badge tooltip`

    3. Scaffold NestJS 11 backend in `apps/api/`:
       - Run `npx @nestjs/cli new apps/api --package-manager pnpm --skip-git`
       - Install deps: `@nestjs/passport passport passport-jwt @supabase/supabase-js @nestjs/config class-validator class-transformer nestjs-cls resend @react-email/components`
       - Install dev deps: `@types/passport-jwt`

    4. Create shared packages:
       - `packages/shared/`: TypeScript package with types, constants, and Zod validation schemas
         - `src/types/auth.ts`: Export UserRole type ('admin' | 'agent'), UserProfile interface (id, tenantId, email, firstName, lastName, role, avatarUrl, setupCompleted), SessionUser interface (id, email, tenantId, role)
         - `src/types/tenant.ts`: Export Tenant interface (id, name, slug, createdAt, updatedAt)
         - `src/constants/roles.ts`: Export ROLES enum (ADMIN = 'admin', AGENT = 'agent'), PERMISSIONS map defining which nav items each role can access. Admin: all. Agent: dashboard, clients, policies, tasks, documents (no expenses, no settings/team). Define NAV_ITEMS array with id, label, href, icon name, adminOnly boolean
         - `src/validation/auth.schema.ts`: Zod schemas for: signupSchema (firstName: min 1, lastName: min 1, agencyName: min 2, email: valid email, password: min 8, confirmPassword must match), loginSchema (email, password), resetPasswordSchema (email), updatePasswordSchema (password: min 8, confirmPassword), acceptInviteSchema (firstName, lastName, password, confirmPassword)
         - `src/validation/tenant.schema.ts`: Zod schema for tenant setup (phone: optional, address: optional, province: optional string)
         - `src/index.ts`: Re-export all types, constants, schemas
       - `packages/database/`: Prisma schema package (schema written in Task 2)
       - `packages/email/`: Placeholder package for React Email templates (built in Plan 05)

    5. Create `.env.example` with all required env vars:
       ```
       # Supabase
       NEXT_PUBLIC_SUPABASE_URL=
       NEXT_PUBLIC_SUPABASE_ANON_KEY=
       SUPABASE_SERVICE_ROLE_KEY=
       SUPABASE_JWT_SECRET=

       # Database (Supabase PostgreSQL)
       DATABASE_URL=
       DIRECT_DATABASE_URL=

       # NestJS
       API_PORT=3001
       FRONTEND_URL=http://localhost:3000
       CORS_ORIGIN=http://localhost:3000

       # Resend (email)
       RESEND_API_KEY=
       ```

    6. Update `.gitignore` to include: node_modules, .next, dist, .env, .env.local, *.tsbuildinfo, .turbo

    7. Ensure `pnpm install` succeeds at root and `pnpm dev` starts both apps (Next.js on 3000, NestJS on 3001).
  </action>
  <verify>
    - `pnpm install` completes without errors at monorepo root
    - `pnpm build` completes for all packages (shared, database, email stubs)
    - `pnpm --filter web dev` starts Next.js on localhost:3000
    - `pnpm --filter api dev` starts NestJS on localhost:3001
    - TypeScript compilation succeeds with no errors: `pnpm --filter shared build`
    - Zod schemas are importable: verify by checking `packages/shared/src/validation/auth.schema.ts` exports signupSchema, loginSchema, etc.
  </verify>
  <done>
    Monorepo runs. Both apps start. Shared types and Zod schemas compile and export. All directories exist per the architecture from RESEARCH.md.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Prisma schema, database migrations, triggers, and Supabase client utilities</name>
  <files>
    packages/database/prisma/schema.prisma
    packages/database/prisma/migrations/ (SQL migration files)
    packages/database/package.json (update scripts)
    apps/web/src/lib/supabase/client.ts
    apps/web/src/lib/supabase/server.ts
    apps/web/src/middleware.ts
    apps/web/src/lib/api.ts
  </files>
  <action>
    1. Create Prisma schema at `packages/database/prisma/schema.prisma` exactly as specified in RESEARCH.md:
       - datasource: postgresql, url from DATABASE_URL, directUrl from DIRECT_DATABASE_URL
       - generator: prisma-client-js
       - Enums: UserRole (admin, agent), InvitationStatus (pending, accepted, revoked, expired)
       - Model Tenant: id (uuid), name, slug (unique), createdAt, updatedAt, relations to users and invitations. Map to "tenants"
       - Model User: id (uuid, matches auth.users.id), tenantId, email, firstName, lastName, role (default agent), avatarUrl (optional), setupCompleted (default false), createdAt, updatedAt. Index on tenantId. Map to "users"
       - Model Invitation: id (uuid), tenantId, email, role, status (default pending), invitedById, token (unique, optional), expiresAt, createdAt, updatedAt. Index on tenantId, index on [email, status]. Map to "invitations"
       - Use @map for snake_case column names (tenantId -> tenant_id, firstName -> first_name, etc.)

    2. Add database scripts to `packages/database/package.json`:
       - "db:generate": "prisma generate"
       - "db:migrate": "prisma migrate dev"
       - "db:push": "prisma db push"
       - "db:studio": "prisma studio"

    3. Run `prisma generate` to create the Prisma client types (no migration push yet — user needs Supabase credentials first).

    4. Create a SQL migration file (manually, not via prisma migrate) at `packages/database/prisma/migrations/00000000000000_init/migration.sql` that includes:
       - The standard Prisma-generated table creation SQL
       - PLUS the `handle_new_user()` trigger function (from RESEARCH.md Pattern 1) that:
         - Creates a tenant record from raw_user_meta_data->>'agency_name'
         - Generates a slug from the agency name (lowercase, replace spaces with hyphens, append random 4 chars)
         - Creates a user profile linked to the tenant with role 'admin'
         - Creates the trigger: `CREATE TRIGGER on_auth_user_created AFTER INSERT ON auth.users FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();`
       - PLUS the `custom_access_token_hook()` function (from RESEARCH.md) that adds tenant_id and user_role to JWT claims
       - PLUS the necessary grants: `GRANT USAGE ON SCHEMA public TO supabase_auth_admin; GRANT SELECT ON public.users TO supabase_auth_admin;`

       IMPORTANT: The trigger must handle BOTH signup users (who have agency_name in metadata) AND invited users (who have invitation_id in metadata). For invited users, look up the invitation record to get tenant_id and role, then create the user profile linked to the existing tenant.

    5. Create Supabase client utilities for Next.js:
       - `apps/web/src/lib/supabase/client.ts`: Browser client using `createBrowserClient` from `@supabase/ssr`. Uses NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY.
       - `apps/web/src/lib/supabase/server.ts`: Server client using `createServerClient` from `@supabase/ssr` with cookies from `next/headers`. Must use the pattern: `const cookieStore = await cookies()` then pass getAll/setAll.
       - Both should be properly typed and follow the exact patterns from Supabase SSR docs.

    6. Create Next.js middleware at `apps/web/src/middleware.ts`:
       - Refresh Supabase session on every request using `getUser()` (NOT getSession() — security requirement from RESEARCH.md)
       - Redirect unauthenticated users to /login for protected routes
       - Allow public routes: /login, /signup, /verify, /reset-password, /update-password, /accept-invite
       - Use the correct matcher to exclude static assets: `/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)`

    7. Create `apps/web/src/lib/api.ts`: A simple fetch wrapper for calling the NestJS API:
       - Base URL from NEXT_PUBLIC_API_URL env var (default http://localhost:3001)
       - Includes Authorization header with Supabase access token
       - Methods: get, post, put, patch, delete
       - Handles error responses and throws with error message
  </action>
  <verify>
    - `npx prisma validate` passes in packages/database
    - `npx prisma generate` produces client types without errors
    - Migration SQL file exists and contains CREATE TABLE for tenants, users, invitations
    - Migration SQL contains handle_new_user() trigger function
    - Migration SQL contains custom_access_token_hook() function
    - `apps/web/src/lib/supabase/client.ts` exports createClient function
    - `apps/web/src/lib/supabase/server.ts` exports createClient function
    - `apps/web/src/middleware.ts` exists and references getUser
    - TypeScript compilation: `pnpm build` passes for apps/web (may need to skip type errors on env vars not being set — that is acceptable)
  </verify>
  <done>
    Prisma schema defines all Phase 1 models. Migration SQL includes table creation + trigger functions. Supabase client utilities are ready for browser and server use. Middleware handles session refresh and route protection. API client utility is ready for NestJS communication.
  </done>
</task>

</tasks>

<verification>
1. `pnpm install` at root succeeds
2. `pnpm build` compiles all packages without TypeScript errors
3. `npx prisma validate` confirms schema is valid
4. `npx prisma generate` produces client types
5. Directory structure matches RESEARCH.md architecture
6. `.env.example` contains all required environment variables
7. Shared types (UserRole, UserProfile, SessionUser, Tenant) are importable from @anchor/shared
8. Zod schemas (signupSchema, loginSchema, etc.) are importable from @anchor/shared
</verification>

<success_criteria>
- Monorepo structure exists with apps/web, apps/api, packages/shared, packages/database, packages/email
- Both apps start via pnpm dev
- Prisma schema has Tenant, User, Invitation models with correct fields and relations
- SQL migration includes handle_new_user trigger and custom_access_token_hook
- Supabase client utilities exist for browser and server
- Next.js middleware refreshes sessions and protects routes
- Shared package exports types, constants, and validation schemas
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-01-SUMMARY.md`
</output>
