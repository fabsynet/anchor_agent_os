---
phase: 01-foundation-auth
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/web/src/app/(auth)/layout.tsx
  - apps/web/src/app/(auth)/signup/page.tsx
  - apps/web/src/app/(auth)/login/page.tsx
  - apps/web/src/app/(auth)/verify/page.tsx
  - apps/web/src/app/(auth)/reset-password/page.tsx
  - apps/web/src/app/(auth)/update-password/page.tsx
  - apps/web/src/components/auth/signup-form.tsx
  - apps/web/src/components/auth/login-form.tsx
  - apps/web/src/components/auth/reset-form.tsx
  - apps/web/src/components/auth/update-password-form.tsx
  - apps/web/src/app/layout.tsx
autonomous: false
user_setup:
  - service: supabase
    why: "Authentication and database"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon/public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> service_role key"
      - name: SUPABASE_JWT_SECRET
        source: "Supabase Dashboard -> Settings -> API -> JWT Secret"
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Settings -> Database -> Connection string (Session pooler, port 5432)"
      - name: DIRECT_DATABASE_URL
        source: "Supabase Dashboard -> Settings -> Database -> Connection string (Direct connection)"
    dashboard_config:
      - task: "Create Supabase project"
        location: "supabase.com -> New Project"
      - task: "Run database migration"
        location: "After env vars set, run: cd packages/database && npx prisma migrate deploy"
      - task: "Enable Custom Access Token Hook"
        location: "Supabase Dashboard -> Authentication -> Hooks -> Add hook -> custom_access_token_hook -> Select function public.custom_access_token_hook"
      - task: "Set email redirect URLs"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Set Site URL to http://localhost:3000 and add redirect URLs: http://localhost:3000/verify, http://localhost:3000/update-password, http://localhost:3000/accept-invite"

must_haves:
  truths:
    - "User can fill out signup form with first name, last name, agency name, email, password, confirm password and submit"
    - "After signup, user sees a message to check their email for verification"
    - "After email verification, new signup user is redirected to /setup wizard (not dashboard)"
    - "User can fill out login form with email and password and access the app"
    - "User can request a password reset email from the login page"
    - "User can set a new password via the update-password page"
    - "Auth pages use split-screen layout: branding on left, form on right"
    - "Session persists across browser refresh (cookie-based)"
  artifacts:
    - path: "apps/web/src/app/(auth)/layout.tsx"
      provides: "Split-screen auth layout with branding panel"
      min_lines: 20
    - path: "apps/web/src/app/(auth)/signup/page.tsx"
      provides: "Signup page"
    - path: "apps/web/src/app/(auth)/login/page.tsx"
      provides: "Login page"
    - path: "apps/web/src/components/auth/signup-form.tsx"
      provides: "Signup form with React Hook Form + Zod validation"
      contains: "signupSchema"
    - path: "apps/web/src/components/auth/login-form.tsx"
      provides: "Login form with React Hook Form + Zod validation"
      contains: "loginSchema"
    - path: "apps/web/src/components/auth/reset-form.tsx"
      provides: "Password reset request form"
    - path: "apps/web/src/components/auth/update-password-form.tsx"
      provides: "New password form for reset flow"
    - path: "apps/web/src/app/(auth)/verify/page.tsx"
      provides: "Email verification confirmation page"
    - path: "apps/web/src/app/auth/callback/route.ts"
      provides: "Auth callback route that handles post-verification redirect to /setup for new signups"
      contains: "exchangeCodeForSession"
  key_links:
    - from: "apps/web/src/components/auth/signup-form.tsx"
      to: "Supabase Auth"
      via: "supabase.auth.signUp() with user_metadata"
      pattern: "auth\\.signUp"
    - from: "apps/web/src/components/auth/login-form.tsx"
      to: "Supabase Auth"
      via: "supabase.auth.signInWithPassword()"
      pattern: "signInWithPassword"
    - from: "apps/web/src/components/auth/reset-form.tsx"
      to: "Supabase Auth"
      via: "supabase.auth.resetPasswordForEmail()"
      pattern: "resetPasswordForEmail"
    - from: "apps/web/src/components/auth/update-password-form.tsx"
      to: "Supabase Auth"
      via: "supabase.auth.updateUser()"
      pattern: "updateUser"
    - from: "apps/web/src/components/auth/signup-form.tsx"
      to: "packages/shared"
      via: "Zod schema import for validation"
      pattern: "signupSchema"
    - from: "apps/web/src/app/auth/callback/route.ts"
      to: "/setup"
      via: "Redirect new signups to setup wizard after verification"
      pattern: "setup"
---

<objective>
Build all authentication pages: signup, login, email verification, password reset, and password update. These use Supabase Auth directly from the frontend — no NestJS backend needed for auth flows.

Purpose: Covers AUTH-01 (signup), AUTH-02 (email verification), AUTH-03 (password reset), AUTH-04 (session persistence). These are the core auth flows every user needs.

Output: Working auth pages with split-screen layout, form validation, Supabase integration, and proper routing.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth layout and signup/login pages with Supabase integration</name>
  <files>
    apps/web/src/app/layout.tsx
    apps/web/src/app/(auth)/layout.tsx
    apps/web/src/app/(auth)/signup/page.tsx
    apps/web/src/app/(auth)/login/page.tsx
    apps/web/src/components/auth/signup-form.tsx
    apps/web/src/components/auth/login-form.tsx
  </files>
  <action>
    1. Update root layout (`apps/web/src/app/layout.tsx`):
       - Add ThemeProvider from next-themes wrapping children (attribute="class", defaultTheme="system", enableSystem)
       - Add Toaster from sonner
       - Set metadata: title "Anchor", description "Insurance agent operating system"
       - Apply Inter font from next/font/google

    2. Create auth layout (`apps/web/src/app/(auth)/layout.tsx`):
       - Split-screen layout per user decision: LEFT side is branding panel, RIGHT side is form content
       - Left panel: Navy blue gradient background (from navy-900 to navy-950), centered content with:
         - Anchor logo/wordmark (text-based for now: "Anchor" in large white bold text)
         - Tagline: "Your insurance agency, running on autopilot." in white/muted text
         - Optional: small decorative element (wave pattern or anchor icon from lucide)
       - Right panel: White background (dark: navy-950), centered form area with max-w-md, vertical centering
       - On mobile (below md breakpoint): Hide left branding panel entirely, show only the form panel full-width
       - Use CSS classes following the navy color scheme: primary navy-950 (#0f172a or similar), white backgrounds

    3. Create signup form component (`apps/web/src/components/auth/signup-form.tsx`):
       - Use React Hook Form with @hookform/resolvers/zod and the signupSchema from @anchor/shared
       - Fields per user decision: firstName, lastName, agencyName, email, password, confirmPassword
       - Use shadcn/ui Form components (FormField, FormItem, FormLabel, FormControl, FormMessage)
       - Validate on blur (per discretion decision in RESEARCH.md), revalidate on change after error
       - Password field with show/hide toggle (Eye/EyeOff icons from lucide)
       - Submit button with loading spinner state (disabled + spinner icon during submission)
       - On submit: call `supabase.auth.signUp()` with email, password, and options.data containing firstName, lastName, agencyName. Set emailRedirectTo to `${window.location.origin}/auth/callback`
       - On success: redirect to /verify with a success message
       - On error: show error via sonner toast
       - Link to login page: "Already have an account? Log in"

    4. Create signup page (`apps/web/src/app/(auth)/signup/page.tsx`):
       - Render the SignupForm component
       - Page title: "Create your account"
       - Subtitle: "Start your 14-day free trial"

    5. Create login form component (`apps/web/src/components/auth/login-form.tsx`):
       - Use React Hook Form with loginSchema from @anchor/shared
       - Fields: email, password (with show/hide toggle)
       - Submit button with loading state
       - On submit: call `supabase.auth.signInWithPassword()`
       - On success: redirect to / (dashboard) using router.push
       - On error: show "Invalid email or password" toast
       - Link to signup: "Don't have an account? Sign up"
       - Link to reset: "Forgot your password?" (links to /reset-password)

    6. Create login page (`apps/web/src/app/(auth)/login/page.tsx`):
       - Render the LoginForm component
       - Page title: "Welcome back"
       - Subtitle: "Sign in to your Anchor account"
  </action>
  <verify>
    - `pnpm --filter web build` compiles without TypeScript errors
    - Auth layout file exists at apps/web/src/app/(auth)/layout.tsx
    - Signup form imports and uses signupSchema from shared package
    - Login form imports and uses loginSchema from shared package
    - Signup form calls supabase.auth.signUp with correct user_metadata fields
    - Login form calls supabase.auth.signInWithPassword
    - Both forms use React Hook Form with Zod resolver
  </verify>
  <done>
    Signup and login pages render with split-screen layout. Forms validate input using shared Zod schemas. Signup calls Supabase signUp with metadata. Login calls signInWithPassword. Navigation links exist between pages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create verification, password reset, update password pages, and auth callback with setup redirect</name>
  <files>
    apps/web/src/app/(auth)/verify/page.tsx
    apps/web/src/app/(auth)/reset-password/page.tsx
    apps/web/src/app/(auth)/update-password/page.tsx
    apps/web/src/components/auth/reset-form.tsx
    apps/web/src/components/auth/update-password-form.tsx
    apps/web/src/app/auth/callback/route.ts
  </files>
  <action>
    1. Create verification page (`apps/web/src/app/(auth)/verify/page.tsx`):
       - Static page shown after signup
       - Display: mail icon (from lucide), heading "Check your email", message "We've sent a verification link to your email address. Click the link to verify your account and get started."
       - "Back to login" link
       - Note: The actual email verification is handled by Supabase. When user clicks the link in the email, Supabase redirects to the callback route which exchanges the code for a session.

    2. Create auth callback route (`apps/web/src/app/auth/callback/route.ts`):
       - This is a Route Handler (API route) that exchanges the Supabase auth code for a session
       - Extract `code` and `next` parameters from the URL search params
       - If code exists: create server Supabase client, call `supabase.auth.exchangeCodeForSession(code)`
       - CRITICAL post-verification redirect logic:
         a. If `next` param is explicitly set (e.g., `/update-password` for password reset flow), redirect there.
         b. If no `next` param (default case for new signup email verification):
            - After exchanging the code, fetch the user's profile to check `setupCompleted` status.
            - Query the public.users table using the Supabase service role client or the server client: check if the user record exists and if `setup_completed` is false.
            - If user has `setupCompleted === false` (new signup who hasn't done the wizard): redirect to `/setup`
            - If user has `setupCompleted === true` (returning user, e.g., re-verification): redirect to `/` (dashboard)
            - If user profile doesn't exist yet (trigger may not have fired yet): redirect to `/setup` as a safe default for new signups
         c. For invite acceptance flows: the `next` param will be set to `/accept-invite`, so those redirect correctly.
       - On error: redirect to /login with error param
       - IMPORTANT: This route handles ALL Supabase auth redirects (verification, password reset, invitation acceptance). The redirect logic must distinguish between these flows.

    3. Create password reset form (`apps/web/src/components/auth/reset-form.tsx`):
       - Use React Hook Form with resetPasswordSchema from @anchor/shared
       - Single field: email
       - On submit: call `supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/auth/callback?next=/update-password' })`
       - On success: show confirmation message "If an account exists with this email, you'll receive a reset link"
       - Submit button with loading state

    4. Create reset password page (`apps/web/src/app/(auth)/reset-password/page.tsx`):
       - Render ResetForm component
       - Title: "Reset your password"
       - Subtitle: "Enter your email and we'll send you a reset link"
       - "Back to login" link

    5. Create update password form (`apps/web/src/components/auth/update-password-form.tsx`):
       - Use React Hook Form with updatePasswordSchema from @anchor/shared
       - Fields: new password (with show/hide), confirm password (with show/hide)
       - On submit: call `supabase.auth.updateUser({ password: newPassword })`
       - On success: show success toast, redirect to /login
       - On error: show error toast

    6. Create update password page (`apps/web/src/app/(auth)/update-password/page.tsx`):
       - Render UpdatePasswordForm component
       - Title: "Set new password"
       - Subtitle: "Enter your new password below"
  </action>
  <verify>
    - `pnpm --filter web build` compiles without TypeScript errors
    - Verify page exists at apps/web/src/app/(auth)/verify/page.tsx
    - Auth callback route exists at apps/web/src/app/auth/callback/route.ts and calls exchangeCodeForSession
    - Auth callback route contains logic to check setupCompleted and redirect to /setup for new signups
    - Auth callback route respects `next` param for password reset (/update-password) and invite acceptance (/accept-invite) flows
    - Reset form calls supabase.auth.resetPasswordForEmail
    - Update password form calls supabase.auth.updateUser
    - All pages render within the (auth) layout (split-screen)
  </verify>
  <done>
    Email verification flow: signup -> verify page -> email link -> callback route -> code exchanged -> setupCompleted check -> redirect to /setup for new users (or / for returning users). Password reset flow: reset page -> email link -> callback route (next=/update-password) -> update password page -> new password saved. All pages use the split-screen auth layout. Auth callback correctly routes new signups to the setup wizard per user decision.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify auth pages render correctly</name>
  <what-built>
    All authentication pages with split-screen layout, form validation, and Supabase integration:
    - Signup page with 6 fields (first name, last name, agency name, email, password, confirm password)
    - Login page with email/password
    - Verify email confirmation page
    - Reset password page
    - Update password page
    - Auth callback route for code exchange with smart redirect (new signups -> /setup, password reset -> /update-password)
  </what-built>
  <how-to-verify>
    1. Ensure .env.local has Supabase credentials (NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY)
    2. Run `pnpm --filter web dev`
    3. Visit http://localhost:3000/signup — verify:
       - Split-screen layout: navy branding panel on left, form on right
       - All 6 fields present with labels
       - Form validation fires on blur (try submitting empty, short password, mismatched confirm)
       - Password show/hide toggle works
    4. Visit http://localhost:3000/login — verify:
       - Same split-screen layout
       - Email + password fields
       - "Forgot your password?" and "Sign up" links work
    5. Visit http://localhost:3000/verify — verify mail icon and check-email message
    6. Visit http://localhost:3000/reset-password — verify email field and submit
    7. Resize browser to mobile width — verify branding panel hides, form is full-width
    8. (Optional) If Supabase is configured and migration run: test actual signup, check email, verify, and confirm redirect goes to /setup (not dashboard)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. All auth routes render: /signup, /login, /verify, /reset-password, /update-password
2. Split-screen layout works on desktop (branding + form) and mobile (form only)
3. Forms validate using shared Zod schemas
4. Supabase auth methods are called correctly (signUp, signInWithPassword, resetPasswordForEmail, updateUser, exchangeCodeForSession)
5. Auth callback redirects new signups to /setup after email verification
6. Auth callback redirects password reset flow to /update-password
7. Session persists across browser refresh (middleware refreshes tokens via getUser)
8. Navigation between auth pages works (login <-> signup, login -> reset)
</verification>

<success_criteria>
- AUTH-01: Signup form with email/password + metadata fields, calls Supabase signUp
- AUTH-02: Verify page + auth callback route handle email verification flow, new signups redirect to /setup
- AUTH-03: Reset password page + update password page with Supabase integration
- AUTH-04: Cookie-based sessions via middleware (from Plan 01) + auth callback code exchange
- Split-screen layout per user decision
- Form validation with shared Zod schemas
- Post-verification redirect: new signups go to /setup wizard, not dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-02-SUMMARY.md`
</output>
