---
phase: 01-foundation-auth
plan: 04
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - apps/web/src/app/(dashboard)/layout.tsx
  - apps/web/src/app/(dashboard)/page.tsx
  - apps/web/src/components/layout/sidebar.tsx
  - apps/web/src/components/layout/topnav.tsx
  - apps/web/src/components/layout/mode-toggle.tsx
  - apps/web/src/components/layout/user-menu.tsx
  - apps/web/src/components/layout/nav-items.tsx
  - apps/web/src/app/globals.css
  - apps/web/src/hooks/use-user.ts
autonomous: false

must_haves:
  truths:
    - "Authenticated user sees a dashboard layout with collapsible left sidebar and top navigation bar"
    - "Admin sees all nav items enabled: Dashboard, Clients, Policies, Tasks, Documents, Expenses, Settings"
    - "Agent sees most nav items enabled including Expenses (can submit expenses) — only Settings is greyed out with 'Admin only' tooltip"
    - "User can toggle between light and dark mode"
    - "Sidebar collapses to hamburger menu on mobile screens"
    - "User can log out from the profile dropdown in the top nav"
    - "Color scheme is navy blue primary with white backgrounds"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with sidebar + topnav"
      min_lines: 20
    - path: "apps/web/src/components/layout/sidebar.tsx"
      provides: "Collapsible sidebar with role-based nav items"
      contains: "Sidebar"
    - path: "apps/web/src/components/layout/topnav.tsx"
      provides: "Top navigation bar with branding and user menu"
      contains: "Topnav"
    - path: "apps/web/src/components/layout/mode-toggle.tsx"
      provides: "Light/dark mode toggle button"
      contains: "useTheme"
    - path: "apps/web/src/components/layout/user-menu.tsx"
      provides: "User profile dropdown with logout"
      contains: "signOut"
    - path: "apps/web/src/hooks/use-user.ts"
      provides: "Hook to get current user and role for client components"
    - path: "apps/web/src/app/(dashboard)/page.tsx"
      provides: "Dashboard placeholder page"
  key_links:
    - from: "apps/web/src/components/layout/sidebar.tsx"
      to: "packages/shared/src/constants/roles.ts"
      via: "NAV_ITEMS import for role-based rendering"
      pattern: "NAV_ITEMS|adminOnly"
    - from: "apps/web/src/components/layout/user-menu.tsx"
      to: "Supabase Auth"
      via: "supabase.auth.signOut() for logout"
      pattern: "signOut"
    - from: "apps/web/src/components/layout/mode-toggle.tsx"
      to: "next-themes"
      via: "useTheme hook"
      pattern: "useTheme"
---

<objective>
Build the authenticated app shell: collapsible sidebar with role-based navigation, top navigation bar with branding and user menu, navy color scheme, light/dark mode toggle, responsive mobile layout, and dashboard placeholder page.

Purpose: Covers AUTH-07 (admin full access), AUTH-08 (agent restricted access) from a navigation visibility standpoint. This is the layout users see after login. All future phases build pages inside this shell.

Output: Working app shell with sidebar navigation, role-based item visibility, theme toggle, responsive design, and a placeholder dashboard.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up navy color theme and create layout components</name>
  <files>
    apps/web/src/app/globals.css
    apps/web/src/hooks/use-user.ts
    apps/web/src/components/layout/mode-toggle.tsx
    apps/web/src/components/layout/user-menu.tsx
    apps/web/src/components/layout/nav-items.tsx
  </files>
  <action>
    1. Update `apps/web/src/app/globals.css` to customize the shadcn/ui theme with navy colors:
       - Override the CSS variables in :root (light mode) and .dark:
         - Light mode: background white, foreground navy-950, primary navy-900, primary-foreground white, accent blue-50, accent-foreground navy-900, muted slate-100, muted-foreground slate-500, card white, border slate-200, destructive red-500
         - Dark mode: background navy-950, foreground slate-50, primary blue-500, primary-foreground white, accent navy-800, accent-foreground slate-50, muted navy-900, muted-foreground slate-400, card navy-900, border navy-800
       - These follow the "navy blue primary, white backgrounds" decision from CONTEXT.md
       - Use the OKLCH or HSL format that shadcn/ui initialized with (maintain consistency with what `npx shadcn init` generated)

    2. Create `apps/web/src/hooks/use-user.ts`:
       - Custom hook that fetches the current user session from Supabase
       - Uses `supabase.auth.getUser()` on mount
       - Also fetches user profile from the NestJS API (`GET /api/auth/me`) to get role and tenant info
       - Returns: { user, profile, isLoading, isAdmin } where isAdmin = profile?.role === 'admin'
       - Caches in React state to avoid re-fetching on every render
       - Handles signed-out state gracefully (returns null)

    3. Create `apps/web/src/components/layout/mode-toggle.tsx`:
       - Uses useTheme() from next-themes
       - Button with Sun icon (light) / Moon icon (dark) from lucide-react
       - Dropdown menu (shadcn/ui DropdownMenu) with options: Light, Dark, System
       - Compact: just the icon button, dropdown reveals options

    4. Create `apps/web/src/components/layout/user-menu.tsx`:
       - DropdownMenu triggered by Avatar button (user initials if no avatar, or avatar image)
       - Menu items: user name + email (display only), separator, "Profile" (links to /settings/profile), "Settings" (links to /settings, admin only), separator, "Log out"
       - Log out: calls supabase.auth.signOut(), then router.push('/login')
       - Uses the useUser() hook for user data

    5. Create `apps/web/src/components/layout/nav-items.tsx`:
       - Import NAV_ITEMS from @anchor/shared/constants/roles
       - Render a list of nav links using shadcn/ui Button variant="ghost"
       - Each item: icon (from lucide-react based on icon name in NAV_ITEMS), label, href
       - If item.adminOnly and user is NOT admin: render the item with opacity-50, cursor-not-allowed, pointer-events-none, and wrap in a Tooltip with "Admin only" message
       - IMPORTANT: Expenses is NOT adminOnly (per user decision — agents CAN submit expenses). Only Settings should show as disabled for agents.
       - Active state: highlight current route item using usePathname()
       - Accept `collapsed` prop: when true, show only icons (no labels), with tooltips for the label
  </action>
  <verify>
    - `pnpm --filter web build` compiles without TypeScript errors
    - globals.css has navy-themed CSS variables for both :root and .dark
    - use-user.ts hook exists and fetches from /api/auth/me
    - mode-toggle.tsx uses useTheme from next-themes
    - user-menu.tsx calls supabase.auth.signOut on logout
    - nav-items.tsx imports NAV_ITEMS and handles adminOnly items with tooltip
    - nav-items.tsx does NOT disable Expenses for agents (only Settings is adminOnly)
  </verify>
  <done>
    Navy color theme applied. User hook fetches profile with role. Mode toggle switches themes. User menu provides logout. Nav items render with role-based visibility — only Settings is disabled for agents, Expenses is accessible to all roles per user decision.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build sidebar, topnav, dashboard layout, and placeholder page</name>
  <files>
    apps/web/src/components/layout/sidebar.tsx
    apps/web/src/components/layout/topnav.tsx
    apps/web/src/app/(dashboard)/layout.tsx
    apps/web/src/app/(dashboard)/page.tsx
    apps/web/src/app/(dashboard)/settings/profile/page.tsx
    apps/web/src/app/(dashboard)/settings/team/page.tsx
  </files>
  <action>
    1. Create `apps/web/src/components/layout/sidebar.tsx`:
       - Desktop (md+ breakpoint): Fixed left sidebar, default width ~256px (w-64)
         - Collapsible: toggle button at bottom collapses to icon-only mode (~w-16)
         - Store collapsed state in localStorage to persist preference
         - Top: Anchor logo/wordmark (text "Anchor" or anchor icon + text)
         - Middle: NavItems component
         - Bottom: collapse toggle button (ChevronLeft/ChevronRight icon)
       - Mobile (below md): Use shadcn/ui Sheet component (slides in from left)
         - Triggered by hamburger button (Menu icon) in the Topnav
         - Shows full nav items, closes on link click
         - Pass `isOpen` and `onClose` props for mobile sheet control

    2. Create `apps/web/src/components/layout/topnav.tsx`:
       - Fixed top bar across the full width (to the right of sidebar on desktop)
       - Left section: Hamburger menu button (visible only on mobile, triggers sidebar sheet), page breadcrumb or title
       - Right section: ModeToggle component, UserMenu component
       - Height: h-16
       - Border-bottom for subtle separation
       - Background matches theme (white in light, navy-950 in dark)

    3. Create dashboard layout (`apps/web/src/app/(dashboard)/layout.tsx`):
       - Server component that fetches user data from Supabase (using server client + getUser)
       - If no user: redirect to /login
       - If user exists but setupCompleted is false: redirect to /setup (the wizard page from Plan 05)
       - Layout structure:
         ```
         <div className="flex h-screen">
           <Sidebar />
           <div className="flex flex-1 flex-col overflow-hidden">
             <Topnav />
             <main className="flex-1 overflow-y-auto p-6">
               {children}
             </main>
           </div>
         </div>
         ```
       - Pass user data to sidebar and topnav via context or props

    4. Create dashboard placeholder page (`apps/web/src/app/(dashboard)/page.tsx`):
       - Title: "Today's Dashboard"
       - Show skeleton cards (3-4 cards in a grid) as placeholder for future dashboard widgets
       - Cards should use shadcn/ui Card and Skeleton components
       - Grid: 3 columns on large screens, 2 on medium, 1 on mobile
       - Message: "Dashboard widgets coming in Phase 3"

    5. Create placeholder settings pages:
       - `apps/web/src/app/(dashboard)/settings/profile/page.tsx`: Title "Profile Settings", placeholder content "Profile management coming soon"
       - `apps/web/src/app/(dashboard)/settings/team/page.tsx`: Title "Team Settings", placeholder content "Team management coming in this phase" (will be built in Plan 05)
  </action>
  <verify>
    - `pnpm --filter web build` compiles without TypeScript errors
    - Dashboard layout wraps content with sidebar + topnav
    - Sidebar renders all nav items from NAV_ITEMS
    - Sidebar collapse works (stores in localStorage)
    - Mobile sheet sidebar works (md breakpoint switch)
    - Dashboard page shows skeleton grid
    - Settings placeholder pages exist
  </verify>
  <done>
    App shell is complete: collapsible sidebar with role-aware navigation, top nav with user menu and theme toggle, responsive mobile layout with hamburger menu, navy color scheme in both light and dark modes. Dashboard and settings placeholders are in place.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify app shell layout, responsiveness, and role-based navigation</name>
  <what-built>
    Complete app shell with:
    - Navy blue color scheme (light + dark modes)
    - Collapsible left sidebar with navigation items
    - Top nav bar with Anchor branding, theme toggle, and user dropdown
    - Role-based nav: only Settings is greyed out for agents — Expenses is enabled for all roles (agents can submit expenses)
    - Responsive design (hamburger menu on mobile)
    - Dashboard placeholder with skeleton cards
  </what-built>
  <how-to-verify>
    1. Run `pnpm dev` (both apps need to be running for auth to work)
    2. Log in at http://localhost:3000/login
    3. Verify dashboard layout:
       - Left sidebar visible with nav items (Dashboard, Clients, Policies, Tasks, Documents, Expenses, Settings)
       - Top nav bar with "Anchor" branding, theme toggle, user avatar/menu
       - Main content area shows dashboard placeholder with skeleton cards
    4. Test sidebar collapse:
       - Click collapse button at bottom of sidebar
       - Sidebar should shrink to icon-only mode
       - Refresh page — collapse state should persist
    5. Test theme toggle:
       - Click sun/moon icon in top nav
       - Switch between Light, Dark, System
       - Verify navy color scheme in both modes
    6. Test responsive design:
       - Resize browser to mobile width (below 768px)
       - Sidebar should disappear, hamburger button should appear in top nav
       - Click hamburger — sidebar slides in as sheet overlay
    7. Test user menu:
       - Click avatar/user button in top nav
       - See dropdown with name, email, Profile link, Log out
       - Click "Log out" — should redirect to login page
    8. (If possible) Test agent role visibility:
       - If you have an agent user: verify Expenses is ENABLED (not greyed out) and only Settings is greyed out with "Admin only" tooltip
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. App shell renders correctly after login
2. Sidebar shows all nav items with correct icons
3. Only Settings is disabled with tooltip for Agent role — Expenses is enabled for all roles
4. Dark/light mode toggle works with navy color scheme
5. Sidebar collapses on desktop, becomes hamburger sheet on mobile
6. User menu shows profile info and logout works
7. Dashboard shows placeholder skeleton cards
</verification>

<success_criteria>
- AUTH-07: Admin sees full navigation (all items enabled)
- AUTH-08: Agent sees Expenses enabled (can submit) — only Settings greyed out with "Admin only" tooltip
- User decision: Navy blue + white color scheme
- User decision: Collapsible left sidebar with hamburger on mobile
- User decision: Top nav bar with branding and profile menu
- User decision: Light + dark mode toggle
- User decision: Fully responsive
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-04-SUMMARY.md`
</output>
