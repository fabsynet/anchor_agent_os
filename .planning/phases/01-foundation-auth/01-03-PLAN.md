---
phase: 01-foundation-auth
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/api/src/main.ts
  - apps/api/src/app.module.ts
  - apps/api/src/common/prisma/prisma.module.ts
  - apps/api/src/common/prisma/prisma.service.ts
  - apps/api/src/common/prisma/prisma-tenant.extension.ts
  - apps/api/src/common/config/supabase.config.ts
  - apps/api/src/auth/auth.module.ts
  - apps/api/src/auth/auth.controller.ts
  - apps/api/src/auth/auth.service.ts
  - apps/api/src/auth/strategies/supabase.strategy.ts
  - apps/api/src/auth/guards/jwt-auth.guard.ts
  - apps/api/src/auth/guards/roles.guard.ts
  - apps/api/src/auth/decorators/current-user.decorator.ts
  - apps/api/src/auth/decorators/tenant-id.decorator.ts
  - apps/api/src/auth/decorators/roles.decorator.ts
  - apps/api/src/users/users.module.ts
  - apps/api/src/users/users.controller.ts
  - apps/api/src/users/users.service.ts
autonomous: true

must_haves:
  truths:
    - "NestJS starts and accepts requests on port 3001"
    - "Protected endpoints reject requests without valid Supabase JWT (401)"
    - "Protected endpoints accept requests with valid Supabase JWT and return user data"
    - "Prisma tenant extension auto-filters queries by tenant_id from JWT claims"
    - "Roles guard rejects Agent users from admin-only endpoints (403)"
    - "GET /auth/me returns current user profile with tenant info"
  artifacts:
    - path: "apps/api/src/auth/strategies/supabase.strategy.ts"
      provides: "Passport JWT strategy for Supabase token verification"
      contains: "PassportStrategy"
    - path: "apps/api/src/auth/guards/jwt-auth.guard.ts"
      provides: "Auth guard for protected routes"
      contains: "AuthGuard"
    - path: "apps/api/src/auth/guards/roles.guard.ts"
      provides: "Role-based access guard"
      contains: "RolesGuard"
    - path: "apps/api/src/common/prisma/prisma-tenant.extension.ts"
      provides: "Prisma extension for auto tenant filtering"
      contains: "\\$extends"
    - path: "apps/api/src/common/prisma/prisma.service.ts"
      provides: "Prisma service with tenant client"
      contains: "tenantClient"
    - path: "apps/api/src/auth/auth.controller.ts"
      provides: "Auth endpoints (GET /auth/me)"
      contains: "auth/me"
    - path: "apps/api/src/users/users.service.ts"
      provides: "User CRUD operations"
  key_links:
    - from: "apps/api/src/auth/strategies/supabase.strategy.ts"
      to: "SUPABASE_JWT_SECRET"
      via: "ConfigService env var"
      pattern: "SUPABASE_JWT_SECRET"
    - from: "apps/api/src/common/prisma/prisma.service.ts"
      to: "apps/api/src/common/prisma/prisma-tenant.extension.ts"
      via: "tenantClient getter using CLS"
      pattern: "cls\\.get.*tenantId"
    - from: "apps/api/src/auth/strategies/supabase.strategy.ts"
      to: "JWT claims"
      via: "validate method extracting tenant_id and user_role"
      pattern: "tenant_id|user_role"
---

<objective>
Build the NestJS backend foundation: Supabase JWT authentication strategy, role-based authorization guards, Prisma service with multi-tenant auto-filtering, user profile endpoints, and custom decorators.

Purpose: The backend is needed for invitation management (Plan 05), user profile operations, and all future phases. This plan establishes the auth/tenant infrastructure that every NestJS endpoint will use.

Output: NestJS app with working JWT auth, role guards, tenant-scoped Prisma client, and a /auth/me endpoint to verify the full stack works.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Prisma service with tenant extension, CLS, and Supabase config</name>
  <files>
    apps/api/src/main.ts
    apps/api/src/app.module.ts
    apps/api/src/common/prisma/prisma.module.ts
    apps/api/src/common/prisma/prisma.service.ts
    apps/api/src/common/prisma/prisma-tenant.extension.ts
    apps/api/src/common/config/supabase.config.ts
  </files>
  <action>
    1. Update `apps/api/src/main.ts`:
       - Enable CORS with origin from CORS_ORIGIN env var (default http://localhost:3000), credentials: true
       - Enable global validation pipe with class-validator (whitelist: true, transform: true)
       - Listen on API_PORT env var (default 3001)
       - Add global prefix 'api' (so routes are /api/auth/me, /api/users, etc.)

    2. Update `apps/api/src/app.module.ts`:
       - Import ConfigModule.forRoot({ isGlobal: true })
       - Import ClsModule.forRoot({ middleware: { mount: true } }) from nestjs-cls
       - Import PrismaModule, AuthModule, UsersModule
       - Remove boilerplate AppController/AppService if present

    3. Create `apps/api/src/common/config/supabase.config.ts`:
       - Export a function that creates a Supabase admin client using SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY from ConfigService
       - This is used for server-side admin operations (inviteUserByEmail, etc.)

    4. Create `apps/api/src/common/prisma/prisma-tenant.extension.ts`:
       - Follow the pattern from RESEARCH.md exactly
       - Export `createTenantExtension(prisma, tenantId)` that returns prisma.$extends({...})
       - Override $allModels: findMany, findFirst, create, update, delete to inject tenantId
       - For findMany/findFirst: add tenantId to where clause
       - For create: add tenantId to data
       - For update/delete: add tenantId to where clause
       - Do NOT override findUnique (it uses unique constraints, tenant check happens at service level)

    5. Create `apps/api/src/common/prisma/prisma.service.ts`:
       - Extend PrismaClient, implement OnModuleInit
       - Inject ClsService from nestjs-cls
       - onModuleInit: call this.$connect()
       - Add `get tenantClient()` getter that:
         - Gets tenantId from this.cls.get('tenantId')
         - Throws Error('Tenant context not set') if missing
         - Returns createTenantExtension(this, tenantId)
       - Also expose the raw PrismaClient for operations that don't need tenant filtering (e.g., looking up user by auth ID during login)

    6. Create `apps/api/src/common/prisma/prisma.module.ts`:
       - Global module that provides PrismaService
       - Export PrismaService for use across all modules
  </action>
  <verify>
    - `pnpm --filter api build` compiles without TypeScript errors
    - PrismaService file exists and has tenantClient getter
    - PrismaModule is marked as @Global
    - main.ts enables CORS and validation pipe
    - app.module.ts imports ConfigModule, ClsModule, PrismaModule
  </verify>
  <done>
    NestJS app has global config, CLS for async context, Prisma service with tenant-scoped client. The foundation is ready for auth guards and business modules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase JWT strategy, auth guards, decorators, and user endpoints</name>
  <files>
    apps/api/src/auth/auth.module.ts
    apps/api/src/auth/auth.controller.ts
    apps/api/src/auth/auth.service.ts
    apps/api/src/auth/strategies/supabase.strategy.ts
    apps/api/src/auth/guards/jwt-auth.guard.ts
    apps/api/src/auth/guards/roles.guard.ts
    apps/api/src/auth/decorators/current-user.decorator.ts
    apps/api/src/auth/decorators/tenant-id.decorator.ts
    apps/api/src/auth/decorators/roles.decorator.ts
    apps/api/src/users/users.module.ts
    apps/api/src/users/users.controller.ts
    apps/api/src/users/users.service.ts
  </files>
  <action>
    1. Create Supabase JWT strategy (`apps/api/src/auth/strategies/supabase.strategy.ts`):
       - Extend PassportStrategy(Strategy, 'supabase') from @nestjs/passport
       - Constructor: jwtFromRequest = ExtractJwt.fromAuthHeaderAsBearerToken(), secretOrKey from SUPABASE_JWT_SECRET env var, ignoreExpiration: false
       - validate(payload): Extract and return { id: payload.sub, email: payload.email, tenantId: payload.tenant_id, role: payload.user_role }
       - IMPORTANT: tenant_id and user_role come from the custom_access_token_hook we set up in Plan 01

    2. Create JWT auth guard (`apps/api/src/auth/guards/jwt-auth.guard.ts`):
       - Extend AuthGuard('supabase')
       - Override handleRequest to set tenant context in CLS: inject ClsService, in handleRequest call cls.set('tenantId', user.tenantId) before returning user

    3. Create roles guard (`apps/api/src/auth/guards/roles.guard.ts`):
       - Use Reflector to get required roles from metadata
       - If no roles required, allow access
       - Otherwise check user.role is in required roles
       - Return 403 Forbidden if not authorized

    4. Create decorators:
       - `current-user.decorator.ts`: @CurrentUser() param decorator, extracts request.user. Optionally accepts a key string to extract specific field
       - `tenant-id.decorator.ts`: @TenantId() param decorator, extracts request.user.tenantId
       - `roles.decorator.ts`: @Roles(...roles) method decorator using SetMetadata('roles', roles)

    5. Create auth module (`apps/api/src/auth/auth.module.ts`):
       - Import PassportModule.register({ defaultStrategy: 'supabase' })
       - Provide SupabaseStrategy
       - Export PassportModule
       - Import and provide AuthService

    6. Create auth service (`apps/api/src/auth/auth.service.ts`):
       - Inject PrismaService
       - Method `getProfile(userId: string)`: Find user by id with tenant relation included, return full profile
       - Method `updateProfile(userId: string, data: { firstName?, lastName?, avatarUrl? })`: Update user record

    7. Create auth controller (`apps/api/src/auth/auth.controller.ts`):
       - `GET /auth/me`: Protected with @UseGuards(JwtAuthGuard). Returns current user profile via AuthService.getProfile(user.id)
       - `PATCH /auth/me`: Protected with @UseGuards(JwtAuthGuard). Updates profile fields (firstName, lastName, avatarUrl)

    8. Create users module, service, and controller:
       - `users.service.ts`: Inject PrismaService. Methods:
         - `findByTenant(tenantId)`: List all users in a tenant (uses tenantClient)
         - `findById(id)`: Find user by ID
         - `updateSetupCompleted(userId, completed)`: Mark setup as done
       - `users.controller.ts`:
         - `GET /users`: Protected, @Roles('admin'), lists tenant users
         - `PATCH /users/:id/setup-complete`: Protected, marks setup done
       - `users.module.ts`: Provides UsersService, UsersController

    9. Wire everything in app.module.ts: Import AuthModule, UsersModule.
  </action>
  <verify>
    - `pnpm --filter api build` compiles without TypeScript errors
    - SupabaseStrategy file references SUPABASE_JWT_SECRET
    - JwtAuthGuard sets tenantId in CLS
    - RolesGuard uses Reflector to check roles
    - AuthController has GET /auth/me endpoint
    - UsersController has GET /users endpoint with @Roles('admin')
    - `pnpm --filter api start:dev` starts without runtime errors (may need env vars set)
  </verify>
  <done>
    NestJS backend authenticates Supabase JWTs, extracts tenant_id and role from claims, auto-scopes Prisma queries to tenant, enforces role-based access. GET /auth/me returns user profile. GET /users lists tenant members (admin only). The backend is ready for invitation endpoints in Plan 05.
  </done>
</task>

</tasks>

<verification>
1. NestJS starts on port 3001 with `pnpm --filter api start:dev`
2. Unauthenticated request to GET /api/auth/me returns 401
3. Request with valid Supabase JWT to GET /api/auth/me returns user profile with tenantId
4. PrismaService.tenantClient auto-filters by tenantId from CLS
5. RolesGuard blocks Agent users from admin-only endpoints (403)
6. CORS allows requests from localhost:3000 with credentials
</verification>

<success_criteria>
- NestJS verifies Supabase JWTs using the JWT secret (not by calling Supabase API)
- JWT claims include tenant_id and user_role (from custom_access_token_hook)
- All database queries through tenantClient are automatically scoped to the user's tenant
- Admin-only endpoints are protected with roles guard
- /auth/me endpoint returns user profile for authenticated users
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-03-SUMMARY.md`
</output>
