---
phase: 01-foundation-auth
plan: 05
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - apps/api/src/invitations/invitations.module.ts
  - apps/api/src/invitations/invitations.controller.ts
  - apps/api/src/invitations/invitations.service.ts
  - apps/api/src/tenants/tenants.module.ts
  - apps/api/src/tenants/tenants.controller.ts
  - apps/api/src/tenants/tenants.service.ts
  - apps/web/src/app/(auth)/accept-invite/page.tsx
  - apps/web/src/components/auth/accept-invite-form.tsx
  - apps/web/src/app/setup/page.tsx
  - apps/web/src/components/setup/setup-wizard.tsx
  - apps/web/src/app/(dashboard)/settings/team/page.tsx
  - apps/web/src/components/settings/invite-form.tsx
  - apps/web/src/components/settings/pending-invites.tsx
  - packages/email/src/invite.tsx
  - packages/email/src/welcome.tsx
  - packages/email/src/components/layout.tsx
autonomous: false
user_setup:
  - service: resend
    why: "Invitation email sending"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"

must_haves:
  truths:
    - "Admin can invite a user by entering email and selecting a role (Admin or Agent)"
    - "System enforces invite cap of 2 users maximum per agency"
    - "Invited user receives an email with signup link"
    - "Invited user can accept invite and create account with name, password, optional photo"
    - "Accepted invite links user to the correct agency and role"
    - "Admin can view pending invites, revoke them, and resend expired ones"
    - "After signup and email verification, new user sees setup wizard"
    - "Setup wizard has 3 steps: agency details, profile photo, invite team"
    - "User can skip wizard steps and reach dashboard"
  artifacts:
    - path: "apps/api/src/invitations/invitations.service.ts"
      provides: "Invitation CRUD with cap enforcement and Supabase invite"
      contains: "inviteUser"
    - path: "apps/api/src/invitations/invitations.controller.ts"
      provides: "Invitation API endpoints"
      contains: "invitations"
    - path: "apps/web/src/app/(auth)/accept-invite/page.tsx"
      provides: "Invite acceptance page"
    - path: "apps/web/src/components/auth/accept-invite-form.tsx"
      provides: "Mini-signup form for invited users"
      contains: "acceptInviteSchema"
    - path: "apps/web/src/app/setup/page.tsx"
      provides: "Post-signup setup wizard"
    - path: "apps/web/src/components/setup/setup-wizard.tsx"
      provides: "3-step wizard component"
    - path: "apps/web/src/app/(dashboard)/settings/team/page.tsx"
      provides: "Team settings with invite management"
    - path: "packages/email/src/invite.tsx"
      provides: "Invitation email template"
      contains: "InviteEmail"
  key_links:
    - from: "apps/api/src/invitations/invitations.service.ts"
      to: "Supabase Admin API"
      via: "supabaseAdmin.auth.admin.inviteUserByEmail()"
      pattern: "inviteUserByEmail"
    - from: "apps/api/src/invitations/invitations.service.ts"
      to: "packages/database"
      via: "prisma.invitation.create for tracking"
      pattern: "prisma.*invitation.*create"
    - from: "apps/web/src/app/(dashboard)/settings/team/page.tsx"
      to: "NestJS API"
      via: "fetch /api/invitations endpoints"
      pattern: "api.*invitations"
    - from: "apps/web/src/components/auth/accept-invite-form.tsx"
      to: "Supabase Auth"
      via: "Exchange code + update user metadata"
      pattern: "auth\\.(updateUser|getUser)"
---

<objective>
Build the invitation flow (admin invites users, invited users accept), the post-signup setup wizard, the team management settings page, and email templates. This completes the multi-tenancy and onboarding experience.

Purpose: Covers AUTH-05 (admin invites), AUTH-06 (invite acceptance), NOTF-04 (invitation email). Also delivers the setup wizard and team management UI from CONTEXT.md decisions.

Output: Working invitation flow end-to-end, setup wizard, team settings page with invite management, and email templates.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
@.planning/phases/01-foundation-auth/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build invitation NestJS endpoints, tenant service, and email templates</name>
  <files>
    apps/api/src/invitations/invitations.module.ts
    apps/api/src/invitations/invitations.controller.ts
    apps/api/src/invitations/invitations.service.ts
    apps/api/src/tenants/tenants.module.ts
    apps/api/src/tenants/tenants.controller.ts
    apps/api/src/tenants/tenants.service.ts
    apps/api/src/app.module.ts
    packages/email/src/invite.tsx
    packages/email/src/welcome.tsx
    packages/email/src/components/layout.tsx
    packages/email/package.json
  </files>
  <action>
    1. Create invitation service (`apps/api/src/invitations/invitations.service.ts`):
       - Inject PrismaService, ConfigService
       - Create Supabase admin client using SUPABASE_URL + SUPABASE_SERVICE_ROLE_KEY (same pattern as config/supabase.config.ts)
       - Create Resend client using RESEND_API_KEY

       Methods:
       - `inviteUser(tenantId, invitedById, email, role)`:
         1. Check invite cap: count invitations where tenantId and status in ['pending', 'accepted']. If >= 2, throw ForbiddenException('Maximum invite limit reached (2 users)')
         2. Check for duplicate pending invite for same email. If exists, throw BadRequestException
         3. Create invitation record in DB with status 'pending', expiresAt = 7 days from now
         4. Call supabaseAdmin.auth.admin.inviteUserByEmail(email, { data: { invitation_id: invitation.id, tenant_id: tenantId, role }, redirectTo: FRONTEND_URL + '/accept-invite' })
         5. If Supabase call fails, delete the invitation record and rethrow
         6. Return invitation

       - `listByTenant(tenantId)`: Find all invitations for tenant, ordered by createdAt desc
       - `revokeInvitation(tenantId, invitationId)`: Update invitation status to 'revoked'. Only if currently 'pending'
       - `resendInvitation(tenantId, invitationId)`:
         1. Find invitation, verify it belongs to tenant and is pending or expired
         2. Update expiresAt to 7 days from now, status back to 'pending' if expired
         3. Call supabaseAdmin.auth.admin.inviteUserByEmail again
       - `acceptInvitation(email)`:
         1. Find pending invitation by email
         2. Update status to 'accepted'
         3. Return invitation (with tenantId and role for the trigger to use)

    2. Create invitation controller (`apps/api/src/invitations/invitations.controller.ts`):
       - All endpoints protected with @UseGuards(JwtAuthGuard)
       - `POST /invitations`: @Roles('admin'). Body: { email, role }. Calls inviteUser
       - `GET /invitations`: @Roles('admin'). Lists all invitations for tenant
       - `PATCH /invitations/:id/revoke`: @Roles('admin'). Revokes invitation
       - `POST /invitations/:id/resend`: @Roles('admin'). Resends invitation

    3. Create invitation module: Provides InvitationsService, InvitationsController. Import in app.module.ts.

    4. Create tenant service (`apps/api/src/tenants/tenants.service.ts`):
       - Inject PrismaService
       - `findById(id)`: Get tenant by ID
       - `updateTenant(id, data: { name?, phone?, address?, province? })`: Update tenant details (for setup wizard)

    5. Create tenant controller (`apps/api/src/tenants/tenants.controller.ts`):
       - `GET /tenants/current`: Protected. Returns current user's tenant
       - `PATCH /tenants/current`: Protected, @Roles('admin'). Updates tenant details

    6. Create tenant module: Provides TenantsService, TenantsController. Import in app.module.ts.

    7. Create email templates using React Email:
       - Update `packages/email/package.json` with dependencies: `@react-email/components react`
       - `packages/email/src/components/layout.tsx`: Shared email layout with Anchor logo (text), navy header, white body, footer with "Anchor - Insurance Agent OS"
       - `packages/email/src/invite.tsx`: InviteEmail component. Props: inviterName, agencyName, role, acceptUrl. Content: "{inviterName} has invited you to join {agencyName} on Anchor as a {role}." CTA button: "Accept Invitation"
       - `packages/email/src/welcome.tsx`: WelcomeEmail component. Props: firstName. Content: "Welcome to Anchor, {firstName}! Your account is ready."
       - Navy + white color scheme matching the app branding
  </action>
  <verify>
    - `pnpm --filter api build` compiles without TypeScript errors
    - InvitationsService has inviteUser, listByTenant, revokeInvitation, resendInvitation methods
    - InvitationsController has POST /invitations, GET /invitations, PATCH /invitations/:id/revoke, POST /invitations/:id/resend
    - All invitation endpoints are @Roles('admin')
    - TenantsController has GET /tenants/current and PATCH /tenants/current
    - packages/email builds without errors
    - Email templates use the shared layout component
  </verify>
  <done>
    NestJS invitation endpoints enforce invite cap (2), create invitation records, call Supabase inviteUserByEmail, support revoke and resend. Tenant endpoints support reading and updating agency details. Email templates are ready for sending.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build accept-invite page, setup wizard, and team management UI</name>
  <files>
    apps/web/src/app/(auth)/accept-invite/page.tsx
    apps/web/src/components/auth/accept-invite-form.tsx
    apps/web/src/app/setup/page.tsx
    apps/web/src/app/setup/layout.tsx
    apps/web/src/components/setup/setup-wizard.tsx
    apps/web/src/app/(dashboard)/settings/team/page.tsx
    apps/web/src/components/settings/invite-form.tsx
    apps/web/src/components/settings/pending-invites.tsx
  </files>
  <action>
    1. Create accept-invite form (`apps/web/src/components/auth/accept-invite-form.tsx`):
       - Use React Hook Form with acceptInviteSchema from @anchor/shared
       - Fields per user decision: firstName, lastName, password, confirmPassword, optional profile photo upload
       - Profile photo: simple file input that accepts image files. Upload to a temporary location or store as base64 (Supabase Storage upload can happen after account creation)
       - The page receives the user via Supabase auth callback (user already exists in auth.users from inviteUserByEmail)
       - On submit:
         1. Call supabase.auth.updateUser({ password, data: { first_name: firstName, last_name: lastName } })
         2. The database trigger (handle_new_user from Plan 01) handles profile creation by looking up the invitation record
         3. Show success toast, redirect to /setup or / (dashboard)
       - Agency name displayed as read-only (pre-linked from invitation)

    2. Create accept-invite page (`apps/web/src/app/(auth)/accept-invite/page.tsx`):
       - This page is loaded after the invited user clicks the email link and the auth callback exchanges the code
       - Check if user is authenticated (they should be after code exchange)
       - Display the AcceptInviteForm
       - Title: "Join [Agency Name]" (fetch agency name from invitation metadata or user metadata)
       - Subtitle: "Complete your account setup"

    3. Create setup wizard layout (`apps/web/src/app/setup/layout.tsx`):
       - Simple centered layout (no sidebar) — the wizard is shown before the user enters the dashboard
       - Max width container, centered vertically and horizontally
       - Anchor logo at top

    4. Create setup wizard (`apps/web/src/components/setup/setup-wizard.tsx`):
       - Multi-step wizard with 3 steps per RESEARCH.md discretion recommendation:
         - Step 1: "Agency Details" — Agency phone (optional), address (optional), province (dropdown of Canadian provinces)
         - Step 2: "Your Profile" — Profile photo upload (optional), title/role description (optional text field)
         - Step 3: "Invite Team" — Invite first team member (email + role selector). Optional, can skip. Uses the POST /api/invitations endpoint.
       - Progress indicator: show "Step X of 3" with visual progress bar or dots
       - Each step has "Skip for now" button and "Continue" / "Finish" button
       - Step 1 submits to PATCH /api/tenants/current
       - Step 2 submits to PATCH /api/auth/me (firstName, lastName, avatarUrl)
       - Step 3 submits to POST /api/invitations (or skips)
       - After final step (or skip all): call PATCH /api/users/:id/setup-complete, then redirect to / (dashboard)
       - Store current step in URL params (?step=1, ?step=2, ?step=3) so browser back works

    5. Create setup wizard page (`apps/web/src/app/setup/page.tsx`):
       - Check if user is authenticated, if not redirect to /login
       - Check if setupCompleted is already true, if so redirect to / (dashboard)
       - Render SetupWizard component

    6. Create team settings page (`apps/web/src/app/(dashboard)/settings/team/page.tsx`):
       - Title: "Team Management"
       - Two sections:
         a. "Invite Team Member" form (InviteForm component)
         b. "Pending Invitations" list (PendingInvites component)
         c. "Team Members" list showing current users in the tenant

    7. Create invite form (`apps/web/src/components/settings/invite-form.tsx`):
       - Fields: email (input), role (select: Admin or Agent)
       - Submit button: "Send Invitation"
       - Calls POST /api/invitations
       - On success: toast "Invitation sent!", refresh pending invites list
       - On error: toast with error message (e.g., "Maximum invite limit reached")
       - Show remaining invite count (2 - current pending/accepted count)

    8. Create pending invites component (`apps/web/src/components/settings/pending-invites.tsx`):
       - Fetches GET /api/invitations
       - Lists each invitation: email, role, status (pending/accepted/revoked/expired), sent date
       - Actions per invite:
         - Pending: "Revoke" button (PATCH /api/invitations/:id/revoke), "Resend" button (POST /api/invitations/:id/resend)
         - Expired: "Resend" button
         - Accepted/Revoked: no actions, just display
       - Uses shadcn/ui Table or Card components for the list
       - Also show a "Current Members" section listing users in the tenant (GET /api/users)
  </action>
  <verify>
    - `pnpm --filter web build` compiles without TypeScript errors
    - Accept-invite page exists and renders form with firstName, lastName, password fields
    - Setup wizard has 3 steps with skip buttons
    - Team settings page has invite form and pending invites list
    - InviteForm calls POST /api/invitations
    - PendingInvites calls GET /api/invitations and renders revoke/resend buttons
    - Setup wizard calls the correct API endpoints for each step
  </verify>
  <done>
    Invitation acceptance flow works: invited user sees mini-signup form, sets password and name, gets linked to agency. Setup wizard guides new users through agency details, profile, and team invite. Team settings page lets admin manage invitations with revoke/resend capabilities.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify invitation flow, setup wizard, and team management</name>
  <what-built>
    Complete invitation and onboarding system:
    - Admin can invite users from team settings page (with role selection)
    - Invited users receive email and can accept with mini-signup
    - Post-signup setup wizard (3 steps: agency details, profile, invite team)
    - Team management page (view invites, revoke, resend, see members)
    - Email templates for invitations
  </what-built>
  <how-to-verify>
    1. Run `pnpm dev` (both apps)
    2. Log in as the admin user
    3. Navigate to Settings -> Team
    4. Verify invite form is visible with email field and role selector
    5. Send a test invitation (enter an email, select "Agent", click send)
    6. Verify invitation appears in "Pending Invitations" list
    7. Test "Revoke" button on the pending invitation
    8. Test invite cap: try to invite more than 2 users total
    9. Test the setup wizard:
       - If a new signup hasn't completed setup, they should see the wizard at /setup
       - Verify 3 steps with progress indicator
       - Verify "Skip for now" works on each step
       - Verify completing wizard redirects to dashboard
    10. (If email delivery is configured) Test the full invite acceptance:
        - Send an invitation
        - Check for invitation email
        - Click the link
        - Verify accept-invite page shows with form
        - Complete the form and verify access to dashboard
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Admin can send invitations with role selection (POST /api/invitations works)
2. Invite cap of 2 is enforced (ForbiddenException on third invite)
3. Pending invitations list shows with revoke/resend actions
4. Accept-invite page renders mini-signup form (name, password)
5. Setup wizard has 3 functional steps with skip support
6. Team members list shows users in the agency
7. Email templates render with navy branding
</verification>

<success_criteria>
- AUTH-05: Admin can invite up to 2 additional users via email
- AUTH-06: Invited user can accept invitation and create their account (mini-signup with pre-linked agency)
- NOTF-04: Invitation email includes signup link (via Supabase inviteUserByEmail + custom email template)
- User decision: Admin invites with role selection (Admin or Agent)
- User decision: Invite acceptance is full mini-signup (name, password, optional photo)
- User decision: Admin can view, revoke, and resend invitations
- User decision: Invite cap of 2 users
- User decision: Setup wizard with 3 steps (agency details, profile photo, invite team)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-05-SUMMARY.md`
</output>
